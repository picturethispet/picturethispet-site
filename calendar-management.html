<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendar Management | Picture This Pet Admin</title>
  <meta name="description" content="Manage calendar slots, sessions, and pop-up events for Picture This Pet photography business.">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  
  <!-- Interact.js for drag-and-drop functionality -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.27/dist/interact.min.js"></script>
  
  <style>
    :root {
      --orange: #F47C2C;
      --gold: #FDB75E;
      --dark-brown: #4B2E1E;
      --available-green: #10b981;
      --booked-red: #ef4444;
      --soft-hold-yellow: #f59e0b;
      --admin-purple: #8b5cf6;
      --admin-blue: #3b82f6;
      --popup-event-purple: #a78bfa;
      --blocked-gray: #6b7280;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }
    html::-webkit-scrollbar {
      width: 8px;
    }
    html::-webkit-scrollbar-track {
      background: transparent;
    }
    html::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: white;
      background: none;
    }
    @keyframes moveBackground {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Drag selection styles */
    .drag-selection {
      position: absolute;
      background: rgba(253, 183, 94, 0.3);
      border: 2px solid var(--gold);
      border-radius: 4px;
      pointer-events: none;
      z-index: 1000;
    }
    
    .calendar-day.drag-hover {
      background: rgba(253, 183, 94, 0.2) !important;
      border: 2px solid var(--gold) !important;
    }
    
    .calendar-day.drag-selected {
      background: rgba(253, 183, 94, 0.3) !important;
      border: 2px solid var(--gold) !important;
    }
    
    /* === LAYOUT === */
    .admin-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
      background-image: url("assets/images/main_background_allsystem.png");
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
    }
    /* === HEADER STYLES === */
    header {
      grid-column: 1 / -1;
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 2rem;
    }
    .logo-small {
      height: 50px;
    }
    .header-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .sync-status {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .sync-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--available-green);
      animation: pulse 2s infinite;
    }
    .sync-indicator.disconnected {
      background: var(--booked-red);
    }
    .admin-user {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.8rem 1.5rem;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .logout-btn {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.7rem 1.2rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 80px;
    }
    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    /* === SIDEBAR === */
    .admin-sidebar {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 2rem 0;
      overflow-y: auto;
    }
    .nav-section {
      margin-bottom: 2rem;
    }
    .nav-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 1.5rem;
      margin-bottom: 0.5rem;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      min-height: 48px;
      text-decoration: none;
    }
    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-left-color: var(--gold);
    }
    .nav-icon {
      font-size: 1.2rem;
      width: 20px;
      text-align: center;
    }
    .nav-badge {
      background: var(--booked-red);
      color: white;
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      margin-left: auto;
    }
    /* === MAIN CONTENT === */
    .admin-main {
      padding: 2rem;
      padding-bottom: 4rem;
    }
    /* === CARDS === */
    .admin-card {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      padding: 2rem;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .card-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }
    .card-actions {
      display: flex;
      gap: 0.5rem;
    }
    /* === BUTTONS === */
    .btn {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-height: 48px;
      min-width: 80px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--orange), var(--gold));
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(244, 124, 44, 0.3);
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      min-height: 40px;
      min-width: 60px;
    }
    .btn-icon {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 0.6rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 40px;
      min-width: 40px;
    }
    .btn-icon:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    /* === CALENDAR GRID === */
    .calendar-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
      position: relative;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .calendar-month {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      min-width: 200px;
      text-align: center;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    .calendar-day {
      background: rgba(255, 255, 255, 0.05);
      padding: 0.8rem 0.5rem;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }
    .calendar-day:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .calendar-day.other-month {
      opacity: 0.3;
    }
    .calendar-day.today {
      background: rgba(244, 124, 44, 0.2);
      border: 2px solid var(--orange);
    }
    .calendar-day.has-events {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--available-green);
    }
    .calendar-day.has-bookings {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--booked-red);
    }
    .calendar-day.has-popups {
      background: rgba(167, 139, 250, 0.1);
      border-left: 4px solid var(--popup-event-purple);
    }
    .calendar-day.blocked {
      background: rgba(107, 114, 128, 0.2);
      border-left: 4px solid var(--blocked-gray);
    }
    .day-number {
      font-weight: 600;
      font-size: 1rem;
      color: white;
      margin-bottom: 0.5rem;
    }
    .day-events {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      width: 100%;
    }
    .event-dot {
      width: 100%;
      height: 3px;
      border-radius: 2px;
      background: var(--available-green);
    }
    .event-dot.booked {
      background: var(--booked-red);
    }
    .event-dot.popup {
      background: var(--popup-event-purple);
    }
    .event-dot.blocked {
      background: var(--blocked-gray);
    }
    /* === LEGEND === */
    .calendar-legend {
      display: flex;
      gap: 1.5rem;
      justify-content: center;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .legend-dot.available {
      background: var(--available-green);
    }
    .legend-dot.booked {
      background: var(--booked-red);
    }
    .legend-dot.popup {
      background: var(--popup-event-purple);
    }
    .legend-dot.blocked {
      background: var(--blocked-gray);
    }
    
    /* === DRAG INSTRUCTION OVERLAY === */
    .drag-instructions {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      z-index: 2000;
      display: none;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .drag-instructions.show {
      display: block;
    }
    
    /* === FORMS === */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-label {
      display: block;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: rgba(255, 255, 255, 0.9);
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.8rem;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      color: white;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      transition: all 0.3s ease;
      resize: vertical;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(255, 255, 255, 0.15);
    }
    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    /* === SESSION HOVER POPUP === */
    .session-popup {
      position: fixed;
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      padding: 1rem;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-width: 250px;
      max-width: 300px;
      z-index: 5000;
      pointer-events: none;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.2s ease;
    }
    .session-popup.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }
    .session-popup-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 0.8rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    .session-popup-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--gold);
    }
    .session-popup-status {
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      margin-left: auto;
    }
    .session-popup-status.booked {
      background: rgba(239, 68, 68, 0.2);
      color: var(--booked-red);
      border: 1px solid var(--booked-red);
    }
    .session-popup-status.popup {
      background: rgba(167, 139, 250, 0.2);
      color: var(--popup-event-purple);
      border: 1px solid var(--popup-event-purple);
    }
    .session-popup-details {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-bottom: 1rem;
    }
    .session-popup-detail {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.9);
    }
    .session-popup-icon {
      font-size: 1rem;
      width: 18px;
      text-align: center;
    }
    .session-popup-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }
    .popup-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }
    .popup-btn-primary {
      background: linear-gradient(135deg, var(--orange), var(--gold));
      color: white;
    }
    .popup-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(244, 124, 44, 0.3);
    }
    .popup-btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .popup-btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    /* === MODALS === */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      padding: 2rem;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }
    .modal-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.3s ease;
      min-height: 40px;
      min-width: 40px;
    }
    .modal-close:hover {
      color: white;
    }
    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }
    /* === STATS === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(244, 124, 44, 0.3);
    }
    .stat-card h4 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--gold);
    }
    .stat-card p {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }
    /* === RESPONSIVE === */
    @media (max-width: 1024px) {
      .admin-layout {
        grid-template-columns: 60px 1fr;
      }
      .admin-sidebar {
        padding: 1rem 0;
      }
      .nav-item {
        padding: 1rem 0.8rem;
        justify-content: center;
      }
      .nav-item span:not(.nav-icon) {
        display: none;
      }
      .nav-section-title {
        display: none;
      }
      .calendar-day {
        min-height: 60px;
        padding: 0.5rem 0.3rem;
      }
      .day-number {
        font-size: 0.8rem;
      }
    }
    @media (max-width: 768px) {
      .admin-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .admin-sidebar {
        background: rgba(0, 0, 0, 0.9);
        position: fixed;
        top: 0;
        left: -100%;
        width: 280px;
        height: 100vh;
        z-index: 4000;
        transition: left 0.3s ease;
      }
      .admin-sidebar.open {
        left: 0;
      }
      .mobile-menu-btn {
        display: block;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .mobile-menu-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .header-title {
        font-size: 1.4rem;
      }
      .admin-main {
        padding: 1rem;
        padding-bottom: 2rem;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      .calendar-grid {
        font-size: 0.8rem;
      }
      .calendar-day {
        min-height: 50px;
        padding: 0.3rem 0.2rem;
      }
      .day-number {
        font-size: 0.7rem;
      }
      .calendar-legend {
        font-size: 0.8rem;
      }
      .modal {
        padding: 1.5rem;
        margin: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Header -->
    <header class="admin-header">
      <div class="header-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()" style="display: none;">☰</button>
        <img src="assets/images/headerlogowarm.png" alt="PictureThisPet Logo" class="logo-small" />
        <h1 class="header-title">Calendar Management 📅</h1>
      </div>
  <!-- Session Hover Popup -->
  <div class="session-popup" id="sessionPopup">
    <div class="session-popup-header">
      <div class="session-popup-title" id="popupTitle">Session Details</div>
      <div class="session-popup-status" id="popupStatus">Booked</div>
    </div>
    <div class="session-popup-details" id="popupDetails">
      <!-- Details will be populated by JavaScript -->
    </div>
    <div class="session-popup-actions">
      <button class="popup-btn popup-btn-secondary" onclick="editSessionQuick()">📝 Quick Edit</button>
      <button class="popup-btn popup-btn-primary" onclick="openClientRecord()">👤 Client Record</button>
    </div>
  </div>
      <div class="header-right">
        <div class="sync-status">
          <div class="sync-indicator" id="syncIndicator"></div>
          <span id="syncStatus">Connected</span>
        </div>
        <div class="admin-user" id="adminUser">Welcome, Admin</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>
    <!-- Sidebar -->
    <nav class="admin-sidebar" id="adminSidebar">
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <a href="admin.html" class="nav-item">
          <span class="nav-icon">📊</span>
          <span>Dashboard</span>
        </a>
        <a href="calendar-management.html" class="nav-item active">
          <span class="nav-icon">📅</span>
          <span>Calendar Management</span>
          <span class="nav-badge" id="calendarBadge">0</span>
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Management</div>
        <a href="client-session-management.html" class="nav-item">
          <span class="nav-icon">👥</span>
          <span>Client & Session Management</span>
        </a>
        <a href="gallery-management.html" class="nav-item">
          <span class="nav-icon">🖼️</span>
          <span>Gallery Management</span>
          <span class="nav-badge" id="galleriesBadge">0</span>
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Business</div>
        <a href="business-management.html" class="nav-item">
          <span class="nav-icon">📈</span>
          <span>Business Management</span>
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">System</div>
        <a href="#" class="nav-item">
          <span class="nav-icon">⚙️</span>
          <span>Settings</span>
        </a>
      </div>
    </nav>
    <!-- Main Content -->
    <main class="admin-main">
      <!-- Calendar Stats -->
      <div class="admin-card">
        <div class="card-header">
          <h2 class="card-title">Calendar Overview 📊</h2>
          <div class="card-actions">
            <button class="btn btn-secondary btn-small" onclick="syncCalendarData()">🔄 Sync</button>
            <button class="btn btn-secondary btn-small" onclick="testPopup()" style="background: var(--admin-purple);">🧪 Test Popup</button>
            <button class="btn btn-secondary btn-small" onclick="debugCheckboxes()" style="background: var(--booked-red);">🔍 Debug Checkboxes</button>
            <button class="btn btn-primary btn-small" onclick="exportCalendar()">📤 Export</button>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <h4>Available Slots This Week 📅</h4>
            <p id="available-slots">Loading...</p>
          </div>
          <div class="stat-card">
            <h4>Booked Sessions This Week 📸</h4>
            <p id="booked-sessions">Loading...</p>
          </div>
          <div class="stat-card">
            <h4>Pop-Up Events This Week 🎉</h4>
            <p id="popup-events">Loading...</p>
          </div>
          <div class="stat-card">
            <h4>Blocked Days This Month 🚫</h4>
            <p id="blocked-days">Loading...</p>
          </div>
        </div>
      </div>
      <!-- Calendar View -->
      <div class="admin-card">
        <div class="card-header">
          <h2 class="card-title">Calendar View 🗓️ <small style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">(Click & drag to select dates)</small></h2>
          <div class="card-actions">
            <button class="btn btn-primary btn-small" onclick="openBulkAvailabilityModal()">📅 Add Availability</button>
            <button class="btn btn-primary btn-small" onclick="openPopupEventModal()">🎉 Create Pop-Up Event</button>
            <button class="btn btn-secondary btn-small" onclick="openBlockDateModal()">🚫 Block Date</button>
            <button class="btn btn-secondary btn-small" onclick="openQuickBookModal()">⚡ Quick Book</button>
          </div>
        </div>
        <div class="calendar-container">
          <div class="calendar-header">
            <div class="calendar-nav">
              <button class="btn-icon" onclick="changeMonth(-1)">←</button>
              <div class="calendar-month" id="calendarMonth">May 2025</div>
              <button class="btn-icon" onclick="changeMonth(1)">→</button>
            </div>
            <button class="btn btn-secondary btn-small" onclick="goToToday()">📍 Today</button>
          </div>
          <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar days will be populated here -->
          </div>
          <div class="calendar-legend">
            <div class="legend-item">
              <div class="legend-dot available"></div>
              <span>Available Slots</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot booked"></div>
              <span>Booked Sessions</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot popup"></div>
              <span>Pop-Up Events</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot blocked"></div>
              <span>Blocked Dates</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Drag Action Modal -->
  <div class="modal-overlay" id="dragActionModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Calendar Action ⚡</h3>
        <button class="modal-close" onclick="closeDragActionModal()">×</button>
      </div>
      
      <div id="dragSelectedInfo" style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
        <!-- Selected date range will appear here -->
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
        <button class="btn btn-primary" onclick="createAvailabilityFromDrag()" style="flex-direction: column; height: auto; padding: 1.5rem;">
          <span style="font-size: 2rem; margin-bottom: 0.5rem;">📅</span>
          <span style="font-weight: 700;">Set Availability</span>
          <small style="opacity: 0.8; margin-top: 0.5rem;">Create hourly booking slots</small>
        </button>
        
        <button class="btn btn-secondary" onclick="blockTimeFromDrag()" style="flex-direction: column; height: auto; padding: 1.5rem;">
          <span style="font-size: 2rem; margin-bottom: 0.5rem;">🚫</span>
          <span style="font-weight: 700;">Block Time</span>
          <small style="opacity: 0.8; margin-top: 0.5rem;">Mark as unavailable</small>
        </button>
        
        <button class="btn btn-primary" onclick="quickBookFromDrag()" style="flex-direction: column; height: auto; padding: 1.5rem; background: var(--admin-purple);">
          <span style="font-size: 2rem; margin-bottom: 0.5rem;">⚡</span>
          <span style="font-weight: 700;">Quick Book</span>
          <small style="opacity: 0.8; margin-top: 0.5rem;">Book session now</small>
        </button>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeDragActionModal()">Cancel 🚫</button>
      </div>
    </div>
  </div>
  
  <!-- Quick Book Modal -->
  <div class="modal-overlay" id="quickBookModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Quick Book Session ⚡</h3>
        <button class="modal-close" onclick="closeQuickBookModal()">×</button>
      </div>
      
      <form id="quickBookForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Session Date 📅</label>
            <input type="date" class="form-input" id="quickBookDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Session Time ⏰</label>
            <input type="time" class="form-input" id="quickBookTime" required>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Session Type 📸</label>
            <select class="form-select" id="quickBookSessionType" required>
              <option value="Mini Session">Mini Session (60 min)</option>
              <option value="Full Session">Full Session (90 min)</option>
              <option value="Pop-Up">Pop-Up Session (10 min)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Location 📍</label>
            <select class="form-select" id="quickBookLocation" required>
              <option value="Cheesman Park">Cheesman Park</option>
              <option value="City Park">City Park</option>
              <option value="Washington Park">Washington Park</option>
              <option value="Cherry Creek">Cherry Creek</option>
              <option value="TBD">Location TBD</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Client Name 👤</label>
          <input type="text" class="form-input" id="quickBookClientName" placeholder="Enter client name" required>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Client Phone 📱</label>
            <input type="tel" class="form-input" id="quickBookClientPhone" placeholder="(303) 555-0123" required>
          </div>
          <div class="form-group">
            <label class="form-label">Pet Count 🐾</label>
            <select class="form-select" id="quickBookPetCount">
              <option value="1">1 Pet</option>
              <option value="2">2 Pets</option>
              <option value="3">3 Pets</option>
              <option value="4">4+ Pets</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Quick Notes 📝</label>
          <textarea class="form-input" id="quickBookNotes" rows="2" placeholder="Any quick notes about this session..."></textarea>
        </div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
          <h4 style="color: var(--gold); margin-bottom: 0.5rem;">⚡ Quick Book Options:</h4>
          <div class="checkbox-group">
            <input type="checkbox" id="sendClientLink" checked>
            <label for="sendClientLink">Generate completion link for client</label>
          </div>
          <small style="color: rgba(255,255,255,0.7); display: block; margin-top: 0.5rem;">
            If checked, creates a partial booking and generates a link for the client to complete their details in the client portal.
          </small>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeQuickBookModal()">Cancel 🚫</button>
          <button type="submit" class="btn btn-primary">⚡ Quick Book Session</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Add Availability Modal -->
  <div class="modal-overlay" id="bulkAvailabilityModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Availability 📅</h3>
        <button class="modal-close" onclick="closeBulkAvailabilityModal()">×</button>
      </div>
      
      <form id="bulkAvailabilityForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Start Date 📅</label>
            <input type="date" class="form-input" id="bulkStartDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">End Date 📅</label>
            <input type="date" class="form-input" id="bulkEndDate" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Days of Week 📆</label>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
            <div class="checkbox-group">
              <input type="checkbox" id="dayMon" value="1">
              <label for="dayMon">Mon</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="dayTue" value="2">
              <label for="dayTue">Tue</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="dayWed" value="3">
              <label for="dayWed">Wed</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="dayThu" value="4">
              <label for="dayThu">Thu</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="dayFri" value="5">
              <label for="dayFri">Fri</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="daySat" value="6" checked>
              <label for="daySat">Sat</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="daySun" value="0">
              <label for="daySun">Sun</label>
            </div>
          </div>
          <small style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">Leave unchecked to apply to all days in date range</small>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Start Time ⏰</label>
            <input type="time" class="form-input" id="bulkStartTime" value="08:00" required>
          </div>
          <div class="form-group">
            <label class="form-label">End Time ⏰</label>
            <input type="time" class="form-input" id="bulkEndTime" value="18:00" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Default Location 📍</label>
          <select class="form-select" id="bulkLocation" required>
            <option value="Cheesman Park">Cheesman Park</option>
            <option value="City Park">City Park</option>
            <option value="Washington Park">Washington Park</option>
            <option value="Cherry Creek">Cherry Creek</option>
            <option value="TBD">Location TBD</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Session Buffer Time ⏱️</label>
          <select class="form-select" id="bufferTime" required>
            <option value="30">30 minutes between sessions</option>
            <option value="60" selected>1 hour between sessions (recommended)</option>
            <option value="90">1.5 hours between sessions</option>
            <option value="120">2 hours between sessions</option>
          </select>
          <small style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">Buffer time added automatically after each booked session</small>
        </div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
          <h4 style="color: var(--gold); margin-bottom: 0.5rem;">📋 How This Works:</h4>
          <ul style="font-size: 0.9rem; color: rgba(255,255,255,0.8); line-height: 1.5;">
            <li>• Creates hourly booking slots (8 AM, 9 AM, 10 AM, etc.)</li>
            <li>• Any session type can book any available slot</li>
            <li>• When booked, automatically blocks session + buffer time</li>
            <li>• Example: Mini (60 min) + 1hr buffer = next slot 2 hours later</li>
            <li>• Only your created availability appears to clients</li>
          </ul>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeBulkAvailabilityModal()">Cancel 🚫</button>
          <button type="submit" class="btn btn-primary">Create Availability 📅</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Pop-Up Event Modal -->
  <div class="modal-overlay" id="popupEventModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Create Pop-Up Event 🎉</h3>
        <button class="modal-close" onclick="closePopupEventModal()">×</button>
      </div>
      
      <form id="popupEventForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Event Date 📅</label>
            <input type="date" class="form-input" id="popupDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Start Time ⏰</label>
            <input type="time" class="form-input" id="popupStartTime" required>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Location 📍</label>
            <select class="form-select" id="popupLocation" required>
              <option value="Cheesman Park">Cheesman Park</option>
              <option value="City Park">City Park</option>
              <option value="Cherry Creek">Cherry Creek</option>
              <option value="Washington Park">Washington Park</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Number of Slots 🎯</label>
            <input type="number" class="form-input" id="popupSlots" min="1" max="20" value="10" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Event Description 📝</label>
          <input type="text" class="form-input" id="popupDescription" placeholder="e.g., Spring Pop-Up at Cheesman Park" required>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closePopupEventModal()">Cancel 🚫</button>
          <button type="submit" class="btn btn-primary">Create Event 🎉</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Block Date Modal -->
  <div class="modal-overlay" id="blockDateModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Block Date 🚫</h3>
        <button class="modal-close" onclick="closeBlockDateModal()">×</button>
      </div>
      
      <form id="blockDateForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Start Date 📅</label>
            <input type="date" class="form-input" id="blockStartDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">End Date 📅</label>
            <input type="date" class="form-input" id="blockEndDate" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Block Type 🚫</label>
          <select class="form-select" id="blockType" onchange="toggleTimeInputs()" required>
            <option value="full-day">Full Day Block</option>
            <option value="time-range">Specific Time Range</option>
          </select>
        </div>
        
        <div class="form-grid" id="timeRangeInputs" style="display: none;">
          <div class="form-group">
            <label class="form-label">Start Time ⏰</label>
            <input type="time" class="form-input" id="blockStartTime" value="09:00">
          </div>
          <div class="form-group">
            <label class="form-label">End Time ⏰</label>
            <input type="time" class="form-input" id="blockEndTime" value="17:00">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Reason 📝</label>
          <input type="text" class="form-input" id="blockReason" placeholder="e.g., Personal time off, Equipment maintenance, Private event" required>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeBlockDateModal()">Cancel 🚫</button>
          <button type="submit" class="btn btn-primary">Block Time 🚫</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Client Record Modal -->
  <div class="modal-overlay" id="clientRecordModal">
    <div class="modal" style="max-width: 900px;">
      <div class="modal-header">
        <h3 class="modal-title">Client Record 👤</h3>
        <button class="modal-close" onclick="closeClientRecordModal()">×</button>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <!-- Client Information -->
        <div>
          <h4 style="color: var(--gold); margin-bottom: 1rem; font-size: 1.2rem;">📋 Client Information</h4>
          <div class="form-group">
            <label class="form-label">Primary Client Name 👤</label>
            <input type="text" class="form-input" id="clientRecordName1" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Email 📧</label>
            <input type="email" class="form-input" id="clientRecordEmail1" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Phone 📱</label>
            <input type="tel" class="form-input" id="clientRecordPhone1" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Instagram 📸</label>
            <input type="text" class="form-input" id="clientRecordInstagram1" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Zip Code 📍</label>
            <input type="text" class="form-input" id="clientRecordZip1" readonly>
          </div>
          
          <div id="secondClientInfo" style="margin-top: 1.5rem; display: none;">
            <h5 style="color: var(--gold); margin-bottom: 0.5rem;">Second Client</h5>
            <div class="form-group">
              <label class="form-label">Name 👤</label>
              <input type="text" class="form-input" id="clientRecordName2" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">Email 📧</label>
              <input type="email" class="form-input" id="clientRecordEmail2" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">Phone 📱</label>
              <input type="tel" class="form-input" id="clientRecordPhone2" readonly>
            </div>
          </div>
        </div>
        
        <!-- Pet Information -->
        <div>
          <h4 style="color: var(--gold); margin-bottom: 1rem; font-size: 1.2rem;">🐾 Pet Information</h4>
          <div class="form-group">
            <label class="form-label">Primary Pet Name 🐕</label>
            <input type="text" class="form-input" id="petName1" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Pet Breed 🎯</label>
            <input type="text" class="form-input" id="petBreed1" placeholder="Add breed information">
          </div>
          <div class="form-group">
            <label class="form-label">Pet Age 📅</label>
            <input type="text" class="form-input" id="petAge1" placeholder="Add age information">
          </div>
          <div class="form-group">
            <label class="form-label">Special Notes 📝</label>
            <textarea class="form-input" id="petNotes1" rows="3" placeholder="Behavioral notes, preferences, etc."></textarea>
          </div>
          
          <div id="secondPetInfo" style="margin-top: 1.5rem; display: none;">
            <h5 style="color: var(--gold); margin-bottom: 0.5rem;">Second Pet</h5>
            <div class="form-group">
              <label class="form-label">Pet Name 🐕</label>
              <input type="text" class="form-input" id="petName2" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">Pet Breed 🎯</label>
              <input type="text" class="form-input" id="petBreed2" placeholder="Add breed information">
            </div>
            <div class="form-group">
              <label class="form-label">Pet Age 📅</label>
              <input type="text" class="form-input" id="petAge2" placeholder="Add age information">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Session History -->
      <div style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="color: var(--gold); font-size: 1.2rem;">📸 Session History</h4>
          <button class="btn btn-primary btn-small" onclick="addNewSessionForClient()">➕ Add Session</button>
        </div>
        <div id="sessionHistoryList" style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 1rem; max-height: 300px; overflow-y: auto;">
          <!-- Session history will be populated here -->
        </div>
      </div>
      
      <!-- Client Preferences & Notes -->
      <div style="margin-bottom: 2rem;">
        <h4 style="color: var(--gold); margin-bottom: 1rem; font-size: 1.2rem;">📋 Client Preferences & Notes</h4>
        <div class="form-group">
          <label class="form-label">Preferred Locations 📍</label>
          <input type="text" class="form-input" id="preferredLocations" placeholder="Cheesman Park, City Park, etc.">
        </div>
        <div class="form-group">
          <label class="form-label">Preferred Session Times ⏰</label>
          <input type="text" class="form-input" id="preferredTimes" placeholder="Morning, Evening, Weekends, etc.">
        </div>
        <div class="form-group">
          <label class="form-label">Special Requests & Notes 📝</label>
          <textarea class="form-input" id="clientNotes" rows="4" placeholder="Any special requests, accessibility needs, or important notes about the client or pets"></textarea>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="marketingConsentRecord">
          <label for="marketingConsentRecord">Marketing consent granted 📬</label>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeClientRecordModal()">Close 🚫</button>
        <button type="button" class="btn btn-primary" onclick="updateClientRecord()">Save Updates 💾</button>
      </div>
    </div>
  </div>
  
  <!-- Session Details Modal -->
  <div class="modal-overlay" id="sessionDetailsModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Session Details 📸</h3>
        <button class="modal-close" onclick="closeSessionDetailsModal()">×</button>
      </div>
      
      <form id="sessionDetailsForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Booking ID 🔍</label>
            <input type="text" class="form-input" id="sessionBookingId" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Session Date 📅</label>
            <input type="date" class="form-input" id="sessionDate" required>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Session Time ⏰</label>
            <input type="time" class="form-input" id="sessionTime" required>
          </div>
          <div class="form-group">
            <label class="form-label">Session Type 📸</label>
            <select class="form-select" id="sessionType" required>
              <option value="Mini Session">Mini Session</option>
              <option value="Full Session">Full Session</option>
              <option value="Pop-Up">Pop-Up Session</option>
            </select>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Client 1 Name 👤</label>
            <input type="text" class="form-input" id="client1Name" placeholder="Enter client name" required>
          </div>
          <div class="form-group">
            <label class="form-label">Client 1 Email 📧</label>
            <input type="email" class="form-input" id="client1Email" placeholder="client@email.com">
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Client 1 Phone 📱</label>
            <input type="tel" class="form-input" id="client1Phone" placeholder="(303) 555-0123">
          </div>
          <div class="form-group">
            <label class="form-label">Client 1 Instagram 📸</label>
            <input type="text" class="form-input" id="client1Instagram" placeholder="@username">
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Pet Count 🐾</label>
            <select class="form-select" id="sessionPetCount" required>
              <option value="1">1 Pet</option>
              <option value="2">2 Pets</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">People Count 👥</label>
            <select class="form-select" id="sessionPeopleCount" required>
              <option value="1">1 Person</option>
              <option value="2">2 People</option>
            </select>
          </div>
        </div>
        
        <div id="client2Fields" style="display: none;">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Client 2 Name 👤</label>
              <input type="text" class="form-input" id="client2Name" placeholder="Enter second client name">
            </div>
            <div class="form-group">
              <label class="form-label">Client 2 Email 📧</label>
              <input type="email" class="form-input" id="client2Email" placeholder="client2@email.com">
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Client 2 Phone 📱</label>
              <input type="tel" class="form-input" id="client2Phone" placeholder="(303) 555-0123">
            </div>
            <div class="form-group">
              <label class="form-label">Client 2 Instagram 📸</label>
              <input type="text" class="form-input" id="client2Instagram" placeholder="@username">
            </div>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Client 1 First Pet Name 🐾</label>
            <input type="text" class="form-input" id="client1FirstPetName" placeholder="Pet name">
          </div>
          <div class="form-group" id="client2PetField" style="display: none;">
            <label class="form-label">Client 2 First Pet Name 🐾</label>
            <input type="text" class="form-input" id="client2FirstPetName" placeholder="Pet name">
          </div>
        </div>
        
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="marketingConsent">
            <label for="marketingConsent">Marketing consent granted 📬</label>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="deleteSession()" id="deleteSessionBtn" style="display: none;">🗑️ Delete</button>
          <button type="button" class="btn btn-secondary" onclick="closeSessionDetailsModal()">Cancel 🚫</button>
          <button type="submit" class="btn btn-primary">Save Session 💾</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // Global variables
    let calendarData = [];
    let bookingsData = [];
    let sessionTypes = [];
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let currentSessionPopup = null;
    let currentClientRecord = null;
    
    // Drag and drop variables
    let dragStartDate = null;
    let dragEndDate = null;
    let isDragging = false;
    let selectedDates = [];
    
    // Authentication and initialization
    function checkAuthentication() {
      const isAuthenticated = localStorage.getItem('adminAuthenticated');
      if (!isAuthenticated) {
        console.log('Not authenticated, redirecting to login...');
        window.location.href = '/portal.html';
        return;
      }
      const adminUser = localStorage.getItem('adminUser') || 'Admin';
      document.getElementById('adminUser').textContent = `Welcome, ${adminUser} 👋`;
      console.log('Authenticated as:', adminUser);
    }
    
    function logout() {
      console.log('Logging out...');
      localStorage.removeItem('adminAuthenticated');
      localStorage.removeItem('adminUser');
      localStorage.removeItem('adminLoginTime');
      window.location.href = '/portal.html';
    }
    
    function toggleSidebar() {
      console.log('Toggling sidebar...');
      const sidebar = document.getElementById('adminSidebar');
      sidebar.classList.toggle('open');
    }
    
    // Error logging
    async function logErrorToAirtable(page, error, data = {}) {
      try {
        const errorId = `ERR_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const errorRecord = {
          fields: {
            errorId: errorId,
            timestamp: new Date().toISOString(),
            page: page,
            errorMessage: error.message || String(error),
            errorStack: error.stack || 'No stack trace available',
            userAgent: navigator.userAgent,
            sessionData: JSON.stringify(data)
          }
        };
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Errors', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(errorRecord)
        });
        if (response.ok) {
          console.log('✅ Error logged to Airtable:', errorRecord);
        } else {
          console.warn('⚠️ Failed to log error to Airtable:', response.status);
        }
      } catch (innerError) {
        console.warn('⚠️ Failed to log error to Airtable:', innerError);
      }
    }
    
    // Data fetching functions
    async function fetchCalendarData() {
      try {
        console.log('Fetching calendar data from Airtable...');
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });
        if (!response.ok) {
          throw new Error(`Airtable error: ${response.status}`);
        }
        const data = await response.json();
        calendarData = data.records.map(record => ({
          id: record.id,
          date: record.fields.date,
          time: record.fields.time,
          endTime: record.fields.endTime,
          status: record.fields.status,
          bookingId: record.fields.bookingId,
          sessionType: record.fields.sessionType,
          bufferTime: record.fields.bufferTime || 0,
          isBlocked: record.fields.isBlocked || false,
          slotType: record.fields.SlotType || 'Regular',
          location: record.fields.Location || ''
        }));
        console.log('Calendar data fetched:', calendarData);
        updateCalendarStats();
        renderCalendar();
      } catch (error) {
        console.error('Error fetching calendar data:', error);
        await logErrorToAirtable('calendar-management.html', error);
      }
    }
    
    async function fetchBookingsData() {
      try {
        console.log('Fetching bookings data from Airtable...');
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings', {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });
        if (!response.ok) {
          throw new Error(`Airtable error: ${response.status}`);
        }
        const data = await response.json();
        bookingsData = data.records.map(record => ({
          id: record.id,
          bookingId: record.fields.bookingId,
          client1Name: record.fields.client1Name,
          client2Name: record.fields.client2Name,
          client1Email: record.fields.client1Email,
          client2Email: record.fields.client2Email,
          client1Phone: record.fields.client1Phone,
          client2Phone: record.fields.client2Phone,
          client1Instagram: record.fields.client1Instagram,
          client2Instagram: record.fields.client2Instagram,
          client1Zip: record.fields.client1Zip,
          client2Zip: record.fields.client2Zip,
          client1FirstPetName: record.fields.client1FirstPetName,
          client2FirstPetName: record.fields.client2FirstPetName,
          marketingConsent: record.fields.marketingConsent,
          petCount: record.fields.petCount,
          peopleCount: record.fields.peopleCount,
          sessionDate: record.fields.sessionDate,
          calendarSlot: record.fields.calendarSlot ? record.fields.calendarSlot[0] : null
        }));
        console.log('Bookings data fetched:', bookingsData);
        updateCalendarStats();
      } catch (error) {
        console.error('Error fetching bookings data:', error);
        await logErrorToAirtable('calendar-management.html', error);
      }
    }
    
    async function fetchSessionTypes() {
      try {
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/SessionTypes', {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });
        const data = await response.json();
        sessionTypes = data.records.map(record => ({
          id: record.id,
          typeName: record.fields.typeName,
          duration: record.fields.duration,
          price: record.fields.price || 0
        }));
      } catch (error) {
        console.error('Error fetching session types:', error);
        await logErrorToAirtable('calendar-management.html', error);
      }
    }
    
    // Calendar rendering functions
    function renderCalendar() {
      const calendarGrid = document.getElementById('calendarGrid');
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
      
      document.getElementById('calendarMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
      
      // Clear grid
      calendarGrid.innerHTML = '';
      
      // Add day headers
      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day';
        header.style.fontWeight = 'bold';
        header.style.background = 'rgba(255, 255, 255, 0.1)';
        header.textContent = day;
        calendarGrid.appendChild(header);
      });
      
      // Get first day of month and number of days
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const today = new Date();
      
      // Add empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day other-month';
        calendarGrid.appendChild(emptyDay);
      }
      
      // Add days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.dataset.date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        const currentDate = new Date(currentYear, currentMonth, day);
        const dateString = currentDate.toISOString().split('T')[0];
        
        // Check if it's today
        if (currentDate.toDateString() === today.toDateString()) {
          dayElement.classList.add('today');
        }
        
        // Get events for this day
        const dayEvents = calendarData.filter(slot => slot.date === dateString);
        
        // Classify day based on events
        const hasAvailable = dayEvents.some(event => event.status === 'available' && !event.isBlocked);
        const hasBooked = dayEvents.some(event => event.status === 'booked');
        const hasPopups = dayEvents.some(event => event.slotType === 'Pop-Up' || event.sessionType === 'Pop-Up');
        const hasBlocked = dayEvents.some(event => event.isBlocked);
        
        if (hasBlocked) {
          dayElement.classList.add('blocked');
        } else if (hasBooked) {
          dayElement.classList.add('has-bookings');
        } else if (hasPopups) {
          dayElement.classList.add('has-popups');
        } else if (hasAvailable) {
          dayElement.classList.add('has-events');
        }
        
        // Add day number
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        dayElement.appendChild(dayNumber);
        
        // Add event indicators
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'day-events';
        
        dayEvents.slice(0, 3).forEach(event => {
          const eventDot = document.createElement('div');
          eventDot.className = 'event-dot';
          
          if (event.isBlocked) {
            eventDot.classList.add('blocked');
          } else if (event.slotType === 'Pop-Up') {
            eventDot.classList.add('popup');
          } else if (event.status === 'booked') {
            eventDot.classList.add('booked');
          }
          
          eventsContainer.appendChild(eventDot);
        });
        
        dayElement.appendChild(eventsContainer);
        
        // Add click handler
        dayElement.onclick = () => handleDayClick(dateString, dayEvents);
        
        // Add hover handlers for booked sessions
        const hasBookedEvents = dayEvents.some(event => event.status === 'booked' || event.slotType === 'Pop-Up');
        if (hasBookedEvents) {
          dayElement.style.cursor = 'pointer';
          dayElement.addEventListener('mouseenter', (e) => {
            showSessionPopup(e, dateString, dayEvents);
          });
          dayElement.addEventListener('mouseleave', () => {
            hideSessionPopup();
          });
        }
        
        calendarGrid.appendChild(dayElement);
      }
      
      // Initialize drag and drop after calendar is rendered
      initializeDragAndDrop();
    }
    
    // Initialize Drag and Drop functionality
    function initializeDragAndDrop() {
      if (typeof interact === 'undefined') {
        console.warn('Interact.js not loaded, drag and drop disabled');
        return;
      }
      
      console.log('Initializing drag and drop...');
      
      // Make calendar days draggable and droppable
      interact('.calendar-day').draggable({
        inertia: false,
        modifiers: [
          interact.modifiers.restrictRect({
            restriction: '.calendar-grid',
            endOnly: true
          })
        ],
        onstart: function(event) {
          const dateStr = event.target.dataset.date;
          if (!dateStr) return;
          
          console.log('Drag started on:', dateStr);
          isDragging = true;
          dragStartDate = dateStr;
          selectedDates = [dateStr];
          
          event.target.classList.add('drag-selected');
        },
        onmove: function(event) {
          // Visual feedback during drag
          const elemBelow = document.elementFromPoint(event.clientX, event.clientY);
          const targetDay = elemBelow?.closest('.calendar-day');
          
          if (targetDay && targetDay.dataset.date) {
            // Clear previous hover states
            document.querySelectorAll('.calendar-day.drag-hover').forEach(el => {
              el.classList.remove('drag-hover');
            });
            
            // Add hover to current target
            targetDay.classList.add('drag-hover');
            
            // Update selected range
            updateSelectedDateRange(dragStartDate, targetDay.dataset.date);
          }
        },
        onend: function(event) {
          console.log('Drag ended');
          isDragging = false;
          
          // Clean up drag styles
          document.querySelectorAll('.calendar-day.drag-hover, .calendar-day.drag-selected').forEach(el => {
            el.classList.remove('drag-hover', 'drag-selected');
          });
          
          if (selectedDates.length > 0) {
            dragEndDate = selectedDates[selectedDates.length - 1];
            console.log('Selected date range:', dragStartDate, 'to', dragEndDate);
            console.log('Selected dates:', selectedDates);
            
            // Show action modal
            showDragActionModal();
          }
        }
      });
    }
    
    function updateSelectedDateRange(startDate, endDate) {
      selectedDates = [];
      
      const start = new Date(startDate);
      const end = new Date(endDate);
      
      // Ensure start is before end
      const actualStart = start <= end ? start : end;
      const actualEnd = start <= end ? end : start;
      
      // Add all dates in range
      for (let d = new Date(actualStart); d <= actualEnd; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        selectedDates.push(dateStr);
        
        // Visual feedback
        const dayElement = document.querySelector(`[data-date="${dateStr}"]`);
        if (dayElement) {
          dayElement.classList.add('drag-selected');
        }
      }
    }
    
    // Drag Action Modal functions
    function showDragActionModal() {
      const modal = document.getElementById('dragActionModal');
      const infoDiv = document.getElementById('dragSelectedInfo');
      
      if (selectedDates.length === 1) {
        const date = new Date(selectedDates[0]);
        infoDiv.innerHTML = `
          <h4 style="color: var(--gold); margin-bottom: 0.5rem;">📅 Selected Date</h4>
          <p>${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
        `;
      } else {
        const startDate = new Date(selectedDates[0]);
        const endDate = new Date(selectedDates[selectedDates.length - 1]);
        infoDiv.innerHTML = `
          <h4 style="color: var(--gold); margin-bottom: 0.5rem;">📅 Selected Date Range</h4>
          <p><strong>From:</strong> ${startDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
          <p><strong>To:</strong> ${endDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
          <p><strong>Total Days:</strong> ${selectedDates.length}</p>
        `;
      }
      
      modal.style.display = 'flex';
    }
    
    function closeDragActionModal() {
      document.getElementById('dragActionModal').style.display = 'none';
      selectedDates = [];
      dragStartDate = null;
      dragEndDate = null;
    }
    
    function createAvailabilityFromDrag() {
      closeDragActionModal();
      openBulkAvailabilityModal();
      
      // Pre-fill dates
      document.getElementById('bulkStartDate').value = selectedDates[0];
      document.getElementById('bulkEndDate').value = selectedDates[selectedDates.length - 1];
    }
    
    function blockTimeFromDrag() {
      closeDragActionModal();
      openBlockDateModal();
      
      // Pre-fill dates
      document.getElementById('blockStartDate').value = selectedDates[0];
      document.getElementById('blockEndDate').value = selectedDates[selectedDates.length - 1];
    }
    
    function quickBookFromDrag() {
      closeDragActionModal();
      openQuickBookModal();
      
      // Pre-fill with first selected date
      document.getElementById('quickBookDate').value = selectedDates[0];
    }
    
    // Quick Book Modal functions
    function openQuickBookModal() {
      document.getElementById('quickBookModal').style.display = 'flex';
      
      // Set default date to today if not already set
      const dateInput = document.getElementById('quickBookDate');
      if (!dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
      }
      
      // Set default time
      document.getElementById('quickBookTime').value = '10:00';
    }
    
    function closeQuickBookModal() {
      document.getElementById('quickBookModal').style.display = 'none';
      document.getElementById('quickBookForm').reset();
    }
    
    function handleDayClick(dateString, dayEvents) {
      const availableSlots = dayEvents.filter(e => e.status === 'available' && !e.isBlocked);
      const bookedSessions = dayEvents.filter(e => e.status === 'booked');
      const blockedSlots = dayEvents.filter(e => e.isBlocked);
      
      if (dayEvents.length === 0) {
        // No events, offer to add availability
        if (confirm(`No availability on ${dateString}.\n\nWould you like to create availability for this day?`)) {
          openBulkAvailabilityModal();
          document.getElementById('bulkStartDate').value = dateString;
          document.getElementById('bulkEndDate').value = dateString;
        }
      } else if (bookedSessions.length === 1 && availableSlots.length === 0 && blockedSlots.length === 0) {
        // Single booked session, open details
        const booking = bookingsData.find(b => b.calendarSlot === bookedSessions[0].id);
        if (booking) {
          openSessionDetailsModal(booking, bookedSessions[0]);
        }
      } else {
        // Multiple events or mixed types, show detailed summary
        let summary = `📅 ${dateString} Summary:\n\n`;
        
        if (availableSlots.length > 0) {
          const availabilityWindow = availableSlots[0].availabilityWindow || 'Unknown';
          summary += `✅ Available: ${availableSlots.length} hourly slots (${availabilityWindow})\n`;
        }
        
        if (bookedSessions.length > 0) {
          summary += `📸 Booked: ${bookedSessions.length} session(s)\n`;
          bookedSessions.forEach(session => {
            const booking = bookingsData.find(b => b.calendarSlot === session.id);
            const clientName = booking ? booking.client1Name : 'Unknown';
            summary += `   • ${session.time} - ${clientName} (${session.sessionType})\n`;
          });
        }
        
        if (blockedSlots.length > 0) {
          summary += `🚫 Blocked: ${blockedSlots.length} time slot(s)\n`;
        }
        
        summary += `\nClick a booked session in the hover popup to view client details.`;
        
        alert(summary);
      }
    }
    
    function showDayEventsPopup(dateString, dayEvents) {
      const eventsList = dayEvents.map(event => {
        const booking = bookingsData.find(b => b.calendarSlot === event.id);
        const time = event.time || '00:00';
        let status = event.isBlocked ? 'Blocked' : event.status || 'available';
        let clientInfo = booking ? ` - ${booking.client1Name}` : '';
        return `${time} ${event.sessionType} (${status})${clientInfo}`;
      }).join('\n');
      
      alert(`Events on ${dateString}:\n\n${eventsList}`);
    }
    
    // Navigation functions
    function changeMonth(direction) {
      currentMonth += direction;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    }
    
    function goToToday() {
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      renderCalendar();
    }
    
    // Stats update function
    function updateCalendarStats() {
      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      
      const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
      const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      
      // Available slots this week
      const availableThisWeek = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= weekStart && slotDate <= weekEnd && 
               slot.status === 'available' && !slot.isBlocked;
      }).length;
      document.getElementById('available-slots').textContent = availableThisWeek;
      
      // Booked sessions this week
      const bookedThisWeek = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= weekStart && slotDate <= weekEnd && slot.status === 'booked';
      }).length;
      document.getElementById('booked-sessions').textContent = bookedThisWeek;
      
      // Pop-up events this week
      const popupsThisWeek = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= weekStart && slotDate <= weekEnd && slot.slotType === 'Pop-Up';
      }).length;
      document.getElementById('popup-events').textContent = popupsThisWeek;
      
      // Blocked days this month
      const blockedThisMonth = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= monthStart && slotDate <= monthEnd && slot.isBlocked;
      }).length;
      document.getElementById('blocked-days').textContent = blockedThisMonth;
      
      // Update badge
      document.getElementById('calendarBadge').textContent = calendarData.length;
    }
    
    // Modal functions
    function openBulkAvailabilityModal() {
      document.getElementById('bulkAvailabilityModal').style.display = 'flex';
      
      // Set default dates (today + 7 days)
      const today = new Date();
      const nextWeek = new Date(today);
      nextWeek.setDate(today.getDate() + 7);
      
      if (!document.getElementById('bulkStartDate').value) {
        document.getElementById('bulkStartDate').value = today.toISOString().split('T')[0];
        document.getElementById('bulkEndDate').value = nextWeek.toISOString().split('T')[0];
      }
    }
    
    function closeBulkAvailabilityModal() {
      document.getElementById('bulkAvailabilityModal').style.display = 'none';
      document.getElementById('bulkAvailabilityForm').reset();
      
      // Reset to default values
      document.getElementById('bulkStartTime').value = '08:00';
      document.getElementById('bulkEndTime').value = '18:00';
      document.getElementById('bufferTime').value = '60';
      document.getElementById('daySat').checked = true;
    }
    
    function openPopupEventModal() {
      document.getElementById('popupEventModal').style.display = 'flex';
    }
    
    function closePopupEventModal() {
      document.getElementById('popupEventModal').style.display = 'none';
      document.getElementById('popupEventForm').reset();
    }
    
    function openBlockDateModal() {
      document.getElementById('blockDateModal').style.display = 'flex';
    }
    
    function closeBlockDateModal() {
      document.getElementById('blockDateModal').style.display = 'none';
      document.getElementById('blockDateForm').reset();
      document.getElementById('timeRangeInputs').style.display = 'none';
    }
    
    function toggleTimeInputs() {
      const blockType = document.getElementById('blockType').value;
      const timeInputs = document.getElementById('timeRangeInputs');
      timeInputs.style.display = blockType === 'time-range' ? 'grid' : 'none';
    }
    
    function openSessionDetailsModal(booking = null, calendarSlot = null) {
      const modal = document.getElementById('sessionDetailsModal');
      const form = document.getElementById('sessionDetailsForm');
      const deleteBtn = document.getElementById('deleteSessionBtn');
      
      if (booking && calendarSlot) {
        // Editing existing session
        document.getElementById('sessionBookingId').value = booking.bookingId || '';
        document.getElementById('sessionDate').value = calendarSlot.date || '';
        document.getElementById('sessionTime').value = calendarSlot.time || '';
        document.getElementById('sessionType').value = calendarSlot.sessionType || '';
        document.getElementById('client1Name').value = booking.client1Name || '';
        document.getElementById('client1Email').value = booking.client1Email || '';
        document.getElementById('client1Phone').value = booking.client1Phone || '';
        document.getElementById('client1Instagram').value = booking.client1Instagram || '';
        document.getElementById('client2Name').value = booking.client2Name || '';
        document.getElementById('client2Email').value = booking.client2Email || '';
        document.getElementById('client2Phone').value = booking.client2Phone || '';
        document.getElementById('client2Instagram').value = booking.client2Instagram || '';
        document.getElementById('sessionPetCount').value = booking.petCount || 1;
        document.getElementById('sessionPeopleCount').value = booking.peopleCount || 1;
        document.getElementById('client1FirstPetName').value = booking.client1FirstPetName || '';
        document.getElementById('client2FirstPetName').value = booking.client2FirstPetName || '';
        document.getElementById('marketingConsent').checked = booking.marketingConsent || false;
        
        deleteBtn.style.display = 'block';
        deleteBtn.onclick = () => deleteSession(booking.id, calendarSlot.id);
      } else {
        // Creating new session
        const newBookingId = `SESS_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        document.getElementById('sessionBookingId').value = newBookingId;
        deleteBtn.style.display = 'none';
      }
      
      // Show/hide client 2 fields based on people count
      updateClient2Fields();
      
      modal.style.display = 'flex';
    }
    
    function closeSessionDetailsModal() {
      document.getElementById('sessionDetailsModal').style.display = 'none';
      document.getElementById('sessionDetailsForm').reset();
    }
    
    function updateClient2Fields() {
      const peopleCount = document.getElementById('sessionPeopleCount').value;
      const petCount = document.getElementById('sessionPetCount').value;
      const client2Fields = document.getElementById('client2Fields');
      const client2PetField = document.getElementById('client2PetField');
      
      client2Fields.style.display = peopleCount === '2' ? 'block' : 'none';
      client2PetField.style.display = petCount === '2' ? 'block' : 'none';
    }
    
    // Session popup functions
    function showSessionPopup(event, dateString, dayEvents) {
      console.log('showSessionPopup called with:', dateString, dayEvents);
      
      const popup = document.getElementById('sessionPopup');
      if (!popup) {
        console.error('Session popup element not found!');
        return;
      }
      
      const bookedEvents = dayEvents.filter(event => event.status === 'booked' || event.slotType === 'Pop-Up');
      console.log('Booked events found:', bookedEvents);
      
      if (bookedEvents.length === 0) {
        console.log('No booked events found');
        return;
      }
      
      currentSessionPopup = { events: bookedEvents, dateString: dateString };
      
      // If multiple sessions, show list format
      if (bookedEvents.length > 1) {
        document.getElementById('popupTitle').textContent = `${bookedEvents.length} Sessions`;
        document.getElementById('popupStatus').textContent = 'Multiple';
        document.getElementById('popupStatus').className = 'session-popup-status booked';
        
        let detailsHTML = '';
        bookedEvents.forEach((event, index) => {
          const booking = bookingsData.find(b => b.calendarSlot === event.id);
          const clientName = booking ? booking.client1Name : 'Unknown Client';
          
          detailsHTML += `
            <div class="session-popup-detail" style="cursor: pointer; padding: 0.5rem; margin: 0.2rem 0; background: rgba(255,255,255,0.1); border-radius: 4px;" onclick="openSingleSession(${index})">
              <div style="font-weight: 600; color: var(--gold);">${event.time} - ${clientName}</div>
              <div style="font-size: 0.8rem; color: rgba(255,255,255,0.8);">${event.sessionType} • ${event.location}</div>
            </div>
          `;
        });
        
        document.getElementById('popupDetails').innerHTML = detailsHTML;
      } else {
        // Single session format
        const mainEvent = bookedEvents[0];
        const booking = bookingsData.find(b => b.calendarSlot === mainEvent.id);
        
        if (!booking) {
          console.log('No booking found for event');
          return;
        }
        
        document.getElementById('popupTitle').textContent = booking.client1Name || 'Session';
        
        const statusElement = document.getElementById('popupStatus');
        statusElement.textContent = mainEvent.slotType === 'Pop-Up' ? 'Pop-Up' : 'Booked';
        statusElement.className = `session-popup-status ${mainEvent.slotType === 'Pop-Up' ? 'popup' : 'booked'}`;
        
        document.getElementById('popupDetails').innerHTML = `
          <div class="session-popup-detail">
            <span class="session-popup-icon">📅</span>
            <span>${dateString} at ${mainEvent.time}</span>
          </div>
          <div class="session-popup-detail">
            <span class="session-popup-icon">📸</span>
            <span>${mainEvent.sessionType}</span>
          </div>
          <div class="session-popup-detail">
            <span class="session-popup-icon">📍</span>
            <span>${mainEvent.location || 'Location TBD'}</span>
          </div>
          <div class="session-popup-detail">
            <span class="session-popup-icon">🐾</span>
            <span>${booking.petCount} pet${booking.petCount > 1 ? 's' : ''}, ${booking.peopleCount} person${booking.peopleCount > 1 ? 's' : ''}</span>
          </div>
          ${booking.client1FirstPetName ? `
          <div class="session-popup-detail">
            <span class="session-popup-icon">🐕</span>
            <span>${booking.client1FirstPetName}${booking.client2FirstPetName ? `, ${booking.client2FirstPetName}` : ''}</span>
          </div>
          ` : ''}
        `;
      }
      
      // Position popup near the mouse
      popup.style.position = 'fixed';
      popup.style.left = `${event.clientX + 10}px`;
      popup.style.top = `${event.clientY + 10}px`;
      
      console.log('Showing popup at:', event.clientX, event.clientY);
      popup.classList.add('show');
      
      // Adjust if popup goes off screen
      setTimeout(() => {
        const popupRect = popup.getBoundingClientRect();
        if (popupRect.right > window.innerWidth) {
          popup.style.left = `${window.innerWidth - popupRect.width - 10}px`;
        }
        if (popupRect.bottom > window.innerHeight) {
          popup.style.top = `${event.clientY - popupRect.height - 10}px`;
        }
      }, 10);
    }
    
    function openSingleSession(index) {
      if (currentSessionPopup && currentSessionPopup.events[index]) {
        const event = currentSessionPopup.events[index];
        const booking = bookingsData.find(b => b.calendarSlot === event.id);
        if (booking) {
          showClientRecordModal(booking);
          hideSessionPopup();
        }
      }
    }
    
    function hideSessionPopup() {
      console.log('hideSessionPopup called');
      const popup = document.getElementById('sessionPopup');
      if (popup) {
        popup.classList.remove('show');
      }
      currentSessionPopup = null;
    }
    
    function editSessionQuick() {
      if (currentSessionPopup) {
        if (currentSessionPopup.events && currentSessionPopup.events.length === 1) {
          const event = currentSessionPopup.events[0];
          const booking = bookingsData.find(b => b.calendarSlot === event.id);
          if (booking) {
            openSessionDetailsModal(booking, event);
            hideSessionPopup();
          }
        } else {
          alert('Please select a specific session to edit from the list above.');
        }
      }
    }
    
    function openClientRecord() {
      if (currentSessionPopup) {
        if (currentSessionPopup.events && currentSessionPopup.events.length === 1) {
          const event = currentSessionPopup.events[0];
          const booking = bookingsData.find(b => b.calendarSlot === event.id);
          if (booking) {
            showClientRecordModal(booking);
            hideSessionPopup();
          }
        } else {
          alert('Please select a specific session from the list above to view client record.');
        }
      }
    }
    
    // Client record functions
    function showClientRecordModal(booking) {
      currentClientRecord = booking;
      const modal = document.getElementById('clientRecordModal');
      
      // Populate client information
      document.getElementById('clientRecordName1').value = booking.client1Name || '';
      document.getElementById('clientRecordEmail1').value = booking.client1Email || '';
      document.getElementById('clientRecordPhone1').value = booking.client1Phone || '';
      document.getElementById('clientRecordInstagram1').value = booking.client1Instagram || '';
      document.getElementById('clientRecordZip1').value = booking.client1Zip || '';
      
      // Second client info
      const secondClientDiv = document.getElementById('secondClientInfo');
      if (booking.client2Name) {
        document.getElementById('clientRecordName2').value = booking.client2Name || '';
        document.getElementById('clientRecordEmail2').value = booking.client2Email || '';
        document.getElementById('clientRecordPhone2').value = booking.client2Phone || '';
        secondClientDiv.style.display = 'block';
      } else {
        secondClientDiv.style.display = 'none';
      }
      
      // Pet information
      document.getElementById('petName1').value = booking.client1FirstPetName || '';
      
      const secondPetDiv = document.getElementById('secondPetInfo');
      if (booking.client2FirstPetName) {
        document.getElementById('petName2').value = booking.client2FirstPetName || '';
        secondPetDiv.style.display = 'block';
      } else {
        secondPetDiv.style.display = 'none';
      }
      
      // Marketing consent
      document.getElementById('marketingConsentRecord').checked = booking.marketingConsent || false;
      
      // Load session history
      loadSessionHistory(booking.client1Email);
      
      modal.style.display = 'flex';
    }
    
    function closeClientRecordModal() {
      document.getElementById('clientRecordModal').style.display = 'none';
      currentClientRecord = null;
    }
    
    async function loadSessionHistory(clientEmail) {
      const historyContainer = document.getElementById('sessionHistoryList');
      
      // Find all bookings for this client
      const clientBookings = bookingsData.filter(booking => 
        booking.client1Email === clientEmail || booking.client2Email === clientEmail
      );
      
      if (clientBookings.length === 0) {
        historyContainer.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center;">No session history found</p>';
        return;
      }
      
      // Sort by date (newest first)
      clientBookings.sort((a, b) => new Date(b.sessionDate) - new Date(a.sessionDate));
      
      let historyHTML = '';
      clientBookings.forEach(booking => {
        const calendarSlot = calendarData.find(slot => slot.id === booking.calendarSlot);
        const sessionDate = new Date(booking.sessionDate).toLocaleDateString();
        const sessionStatus = calendarSlot ? calendarSlot.status : 'unknown';
        
        let statusColor = '';
        let statusText = '';
        switch(sessionStatus) {
          case 'booked':
            statusColor = 'var(--booked-red)';
            statusText = 'Upcoming';
            break;
          case 'completed':
            statusColor = 'var(--available-green)';
            statusText = 'Completed';
            break;
          default:
            statusColor = 'var(--soft-hold-yellow)';
            statusText = 'Pending';
        }
        
        historyHTML += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 3px solid ${statusColor};">
            <div>
              <div style="font-weight: 600; color: white;">${sessionDate} - ${calendarSlot?.sessionType || 'Session'}</div>
              <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">${calendarSlot?.location || 'Location TBD'} • ${booking.petCount} pet(s), ${booking.peopleCount} person(s)</div>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="color: ${statusColor}; font-size: 0.8rem; font-weight: 600;">${statusText}</span>
              <button class="popup-btn popup-btn-secondary" onclick="editSessionFromHistory('${booking.id}')">📝</button>
            </div>
          </div>
        `;
      });
      
      historyContainer.innerHTML = historyHTML;
    }
    
    function editSessionFromHistory(bookingId) {
      const booking = bookingsData.find(b => b.id === bookingId);
      const calendarSlot = calendarData.find(slot => slot.id === booking.calendarSlot);
      
      if (booking && calendarSlot) {
        openSessionDetailsModal(booking, calendarSlot);
      }
    }
    
    function addNewSessionForClient() {
      if (currentClientRecord) {
        // Pre-populate the session form with current client data
        openSessionDetailsModal();
        
        // Fill in client information
        document.getElementById('client1Name').value = currentClientRecord.client1Name || '';
        document.getElementById('client1Email').value = currentClientRecord.client1Email || '';
        document.getElementById('client1Phone').value = currentClientRecord.client1Phone || '';
        document.getElementById('client1Instagram').value = currentClientRecord.client1Instagram || '';
        document.getElementById('client2Name').value = currentClientRecord.client2Name || '';
        document.getElementById('client2Email').value = currentClientRecord.client2Email || '';
        document.getElementById('client2Phone').value = currentClientRecord.client2Phone || '';
        document.getElementById('client2Instagram').value = currentClientRecord.client2Instagram || '';
        document.getElementById('sessionPetCount').value = currentClientRecord.petCount || 1;
        document.getElementById('sessionPeopleCount').value = currentClientRecord.peopleCount || 1;
        document.getElementById('client1FirstPetName').value = currentClientRecord.client1FirstPetName || '';
        document.getElementById('client2FirstPetName').value = currentClientRecord.client2FirstPetName || '';
        document.getElementById('marketingConsent').checked = currentClientRecord.marketingConsent || false;
        
        updateClient2Fields();
      }
    }
    
    async function updateClientRecord() {
      if (!currentClientRecord) return;
      
      try {
        // Get updated values
        const updatedData = {
          fields: {
            // Client information updates (read-only fields won't be updated)
            
            // Extended client data - these would need new fields in Airtable
            preferredLocations: document.getElementById('preferredLocations').value,
            preferredTimes: document.getElementById('preferredTimes').value,
            clientNotes: document.getElementById('clientNotes').value,
            petBreed1: document.getElementById('petBreed1').value,
            petAge1: document.getElementById('petAge1').value,
            petNotes1: document.getElementById('petNotes1').value,
            petBreed2: document.getElementById('petBreed2').value,
            petAge2: document.getElementById('petAge2').value,
            marketingConsent: document.getElementById('marketingConsentRecord').checked
          }
        };
        
        // Update the booking record with extended data
        // Note: You may want to create a separate "Clients" table for extended client data
        const response = await fetch(`https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings/${currentClientRecord.id}`, {
          method: 'PATCH',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedData)
        });
        
        if (!response.ok) {
          throw new Error(`Airtable error: ${response.status}`);
        }
        
        console.log('✅ Client record updated successfully');
        alert('✅ Client record updated successfully!');
        
        // Refresh data
        await fetchBookingsData();
        
      } catch (error) {
        console.error('Error updating client record:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error updating client record. Please try again.');
      }
    }
    
    // FIXED bulkAvailabilityForm submission handler with extensive debugging
    document.getElementById('bulkAvailabilityForm').onsubmit = async function(e) {
      e.preventDefault();
      
      console.log('🔥 FORM SUBMISSION STARTED');
      
      const startDate = new Date(document.getElementById('bulkStartDate').value);
      const endDate = new Date(document.getElementById('bulkEndDate').value);
      
      console.log('📅 Dates:', {
        startDate: startDate.toISOString().split('T')[0],
        endDate: endDate.toISOString().split('T')[0]
      });
      
      // ENHANCED DEBUGGING: Check all checkboxes first
      console.log('🔍 Debugging checkbox selection...');
      const allCheckboxes = document.querySelectorAll('#bulkAvailabilityForm input[type="checkbox"]');
      console.log('Total checkboxes found:', allCheckboxes.length);
      
      allCheckboxes.forEach((checkbox, index) => {
        console.log(`Checkbox ${index}:`, {
          id: checkbox.id,
          value: checkbox.value,
          checked: checkbox.checked,
          element: checkbox
        });
      });
      
      // FIXED: Use your exact selectedDays retrieval logic
      const selectedDays = [];
      const dayCheckboxes = document.querySelectorAll('#bulkAvailabilityForm input[type="checkbox"][id^="day"]');
      console.log('Day checkboxes found:', dayCheckboxes.length);
      
      dayCheckboxes.forEach((checkbox, index) => {
        console.log(`Day checkbox ${index}:`, {
          id: checkbox.id,
          value: checkbox.value,
          checked: checkbox.checked
        });
        if (checkbox.checked) {
          console.log(`✅ Adding day ${checkbox.value} to selectedDays`);
          selectedDays.push(parseInt(checkbox.value));
        }
      });
      
      console.log('🎯 Selected days:', selectedDays);
      const daysToUse = selectedDays.length > 0 ? selectedDays : [0, 1, 2, 3, 4, 5, 6];
      console.log('🎯 Days to use:', daysToUse);
      
      const startTime = document.getElementById('bulkStartTime').value;
      const endTime = document.getElementById('bulkEndTime').value;
      const location = document.getElementById('bulkLocation').value;
      const bufferMinutes = parseInt(document.getElementById('bufferTime').value);
      
      console.log('⏰ Time settings:', {
        startTime,
        endTime,
        location,
        bufferMinutes
      });
      
      try {
        const slotsToCreate = [];
        
        // Calculate how many hours of availability
        const start = new Date(`2025-01-01T${startTime}:00`);
        const end = new Date(`2025-01-01T${endTime}:00`);
        const totalHours = (end - start) / (1000 * 60 * 60);
        
        console.log(`⏱️ Creating availability: ${startTime} to ${endTime} (${totalHours} hours)`);
        console.log(`🛡️ Buffer time: ${bufferMinutes} minutes between sessions`);
        
        console.log('🔄 Starting date loop...');
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          const dateString = d.toISOString().split('T')[0];
          const dayOfWeek = d.getDay();
          
          console.log('🗓️ Processing date:', dateString, 'Day of week:', dayOfWeek);
          console.log('🎯 daysToUse includes this day?', daysToUse.includes(dayOfWeek));
          
          if (daysToUse.includes(dayOfWeek)) {
            console.log('✅ Creating slots for date:', dateString);
            
            // Create hourly booking slots for this day
            const dayStart = new Date(`${dateString}T${startTime}:00`);
            const dayEnd = new Date(`${dateString}T${endTime}:00`);
            
            console.log('🕐 Day start:', dayStart, 'Day end:', dayEnd);
            
            let slotCount = 0;
            // Create hourly slots (8 AM, 9 AM, 10 AM, etc.)
            for (let time = new Date(dayStart); time < dayEnd; time.setHours(time.getHours() + 1)) {
              const timeString = time.toTimeString().slice(0, 5);
              slotCount++;
              
              console.log(`📅 Creating slot ${slotCount}: ${dateString} at ${timeString}`);
              
              // Each slot represents a potential session start time
              // The actual booking system will handle session duration + buffer time
              slotsToCreate.push({
                fields: {
                  SlotType: 'Available',
                  Location: location,
                  date: dateString,
                  time: timeString,
                  endTime: timeString, // Will be calculated when booked
                  status: 'available',
                  sessionType: 'Open Availability',
                  bufferTime: bufferMinutes,
                  isBlocked: false,
                  isAvailable: true,
                  availabilityWindow: `${startTime}-${endTime}`,
                  // Store metadata for intelligent booking
                  createdByAdmin: true,
                  availabilityType: 'hourly-slot'
                }
              });
            }
            
            console.log(`📊 Created ${slotCount} slots for ${dateString}`);
          } else {
            console.log('❌ Skipping date:', dateString, '(day not selected)');
          }
        }
        
        console.log('🎯 Total slots to create:', slotsToCreate.length);
        
        if (slotsToCreate.length === 0) {
          console.error('🚨 NO SLOTS TO CREATE! This is the problem.');
          console.log('Debug info:', {
            selectedDays,
            daysToUse,
            startDate: startDate.toISOString().split('T')[0],
            endDate: endDate.toISOString().split('T')[0],
            startTime,
            endTime
          });
          alert('🚨 DEBUG: No slots were created. Check the console for detailed debugging info.');
          return;
        }
        
        // Create slots in batches of 10
        let totalCreated = 0;
        console.log('🚀 Starting Airtable API calls...');
        
        for (let i = 0; i < slotsToCreate.length; i += 10) {
          const batch = slotsToCreate.slice(i, i + 10);
          console.log(`📤 Sending batch ${Math.ceil((i + 1) / 10)}:`, batch);
          
          const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ records: batch })
          });
          
          console.log('📥 API Response status:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('🚨 API Error response:', errorText);
            throw new Error(`Airtable error: ${response.status} - ${errorText}`);
          }
          
          const result = await response.json();
          console.log('✅ API Response result:', result);
          
          totalCreated += batch.length;
          console.log(`✅ Created batch ${Math.ceil((i + 1) / 10)} - ${totalCreated} slots total`);
        }
        
        console.log(`🎉 SUCCESS! Created ${totalCreated} hourly availability slots`);
        alert(`✅ Successfully created availability!\n\n📅 ${totalCreated} hourly booking slots created\n⏰ ${startTime} to ${endTime} daily\n🕐 ${bufferMinutes} min buffer between sessions\n\nClients can now book any session type during these times.`);
        closeBulkAvailabilityModal();
        await syncCalendarData();
        
        // Show implementation notes
        setTimeout(() => {
          alert(`📋 Next Steps:\n\n1. These slots now appear on your homepage calendar\n2. When clients book, the system will:\n   • Block session duration + ${bufferMinutes} min buffer\n   • Show next available slot accordingly\n   • Prevent overlapping bookings\n\n3. You can add more buffer time by blocking specific periods\n4. Only admin-created availability shows to clients`);
        }, 2000);
        
      } catch (error) {
        console.error('🚨 COMPLETE ERROR DETAILS:', {
          message: error.message,
          stack: error.stack,
          error: error
        });
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error creating availability slots. Check console for details. Error: ' + error.message);
      }
    };
    
    // Quick Book Form submission
    document.getElementById('quickBookForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const formData = {
        date: document.getElementById('quickBookDate').value,
        time: document.getElementById('quickBookTime').value,
        sessionType: document.getElementById('quickBookSessionType').value,
        location: document.getElementById('quickBookLocation').value,
        clientName: document.getElementById('quickBookClientName').value,
        clientPhone: document.getElementById('quickBookClientPhone').value,
        petCount: parseInt(document.getElementById('quickBookPetCount').value),
        notes: document.getElementById('quickBookNotes').value,
        sendClientLink: document.getElementById('sendClientLink').checked
      };
      
      try {
        const bookingId = `QUICK_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
        
        if (formData.sendClientLink) {
          // Create partial booking and generate client completion link
          const partialBooking = {
            fields: {
              bookingId: bookingId,
              client1Name: formData.clientName,
              client1Phone: formData.clientPhone,
              petCount: formData.petCount,
              sessionDate: formData.date,
              sessionType: formData.sessionType,
              notes: formData.notes,
              status: 'partial', // Needs completion by client
              completionToken: Math.random().toString(36).substr(2, 15) // Security token
            }
          };
          
          // Create booking in Airtable
          const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(partialBooking)
          });
          
          const result = await response.json();
          const completionLink = `/client-portal-home.html?complete=${result.id}&token=${partialBooking.fields.completionToken}`;
          
          alert(`⚡ Quick booking created!\n\nBooking ID: ${bookingId}\n\nSend this link to ${formData.clientName}:\n${window.location.origin}${completionLink}\n\nThey can complete their booking details there.`);
          
        } else {
          // Create full booking directly (minimal info)
          const fullBooking = {
            fields: {
              bookingId: bookingId,
              client1Name: formData.clientName,
              client1Phone: formData.clientPhone,
              petCount: formData.petCount,
              peopleCount: 1, // Default
              sessionDate: `${formData.date}T${formData.time}:00`,
              sessionType: formData.sessionType
            }
          };
          
          // Create calendar slot
          const calendarSlot = {
            fields: {
              SlotType: 'Booked',
              Location: formData.location,
              date: formData.date,
              time: formData.time,
              endTime: formData.time, // Will be calculated
              status: 'booked',
              bookingId: bookingId,
              sessionType: formData.sessionType,
              bufferTime: 60, // Default
              isBlocked: false
            }
          };
          
          // Create both records
          const [bookingResponse, calendarResponse] = await Promise.all([
            fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(fullBooking)
            }),
            fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(calendarSlot)
            })
          ]);
          
          alert(`⚡ Quick booking completed!\n\nBooking ID: ${bookingId}\nClient: ${formData.clientName}\nDate: ${formData.date} at ${formData.time}\nSession: ${formData.sessionType}`);
        }
        
        closeQuickBookModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error creating quick booking:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error creating quick booking. Please try again.');
      }
    };
    
    // Other form submission handlers (unchanged)
    document.getElementById('popupEventForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const date = document.getElementById('popupDate').value;
      const startTime = document.getElementById('popupStartTime').value;
      const location = document.getElementById('popupLocation').value;
      const numSlots = parseInt(document.getElementById('popupSlots').value);
      const description = document.getElementById('popupDescription').value;
      
      try {
        const slotsToCreate = [];
        
        for (let i = 0; i < numSlots; i++) {
          const slotTime = new Date(`${date}T${startTime}:00`);
          slotTime.setMinutes(slotTime.getMinutes() + (i * 20)); // 10 min session + 10 min prep
          
          const timeString = slotTime.toTimeString().slice(0, 5);
          const endTime = new Date(slotTime);
          endTime.setMinutes(endTime.getMinutes() + 10);
          const endTimeString = endTime.toTimeString().slice(0, 5);
          
          slotsToCreate.push({
            fields: {
              SlotType: 'Pop-Up',
              Location: location,
              date: date,
              time: timeString,
              endTime: endTimeString,
              status: 'available',
              sessionType: 'Pop-Up',
              bufferTime: 10,
              isBlocked: false
            }
          });
        }
        
        // Create pop-up slots
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ records: slotsToCreate })
        });
        
        if (!response.ok) {
          throw new Error(`Airtable error: ${response.status}`);
        }
        
        console.log(`✅ Created pop-up event with ${numSlots} slots`);
        alert(`🎉 Successfully created pop-up event "${description}" with ${numSlots} slots!`);
        closePopupEventModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error creating pop-up event:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error creating pop-up event. Please try again.');
      }
    };
    
    document.getElementById('blockDateForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const startDate = new Date(document.getElementById('blockStartDate').value);
      const endDate = new Date(document.getElementById('blockEndDate').value);
      const reason = document.getElementById('blockReason').value;
      const blockType = document.getElementById('blockType').value;
      
      try {
        const slotsToCreate = [];
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          const dateString = d.toISOString().split('T')[0];
          
          if (blockType === 'full-day') {
            // Block entire day
            slotsToCreate.push({
              fields: {
                SlotType: 'Blocked',
                Location: reason,
                date: dateString,
                time: '00:00',
                endTime: '23:59',
                status: 'blocked',
                sessionType: 'Blocked',
                bufferTime: 0,
                isBlocked: true,
                blockReason: reason
              }
            });
          } else {
            // Block specific time range
            const startTime = document.getElementById('blockStartTime').value;
            const endTime = document.getElementById('blockEndTime').value;
            
            // Create 15-minute blocked slots for the time range
            const start = new Date(`${dateString}T${startTime}:00`);
            const end = new Date(`${dateString}T${endTime}:00`);
            
            for (let time = new Date(start); time < end; time.setMinutes(time.getMinutes() + 15)) {
              const timeString = time.toTimeString().slice(0, 5);
              const endTimeObj = new Date(time);
              endTimeObj.setMinutes(endTimeObj.getMinutes() + 15);
              const endTimeString = endTimeObj.toTimeString().slice(0, 5);
              
              slotsToCreate.push({
                fields: {
                  SlotType: 'Blocked',
                  Location: reason,
                  date: dateString,
                  time: timeString,
                  endTime: endTimeString,
                  status: 'blocked',
                  sessionType: 'Blocked Time',
                  bufferTime: 0,
                  isBlocked: true,
                  blockReason: reason
                }
              });
            }
          }
        }
        
        // Create blocked slots in batches
        let totalCreated = 0;
        for (let i = 0; i < slotsToCreate.length; i += 10) {
          const batch = slotsToCreate.slice(i, i + 10);
          const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ records: batch })
          });
          
          if (!response.ok) {
            throw new Error(`Airtable error: ${response.status}`);
          }
          
          totalCreated += batch.length;
        }
        
        const blockTypeText = blockType === 'full-day' ? 'full day(s)' : 'time range(s)';
        console.log(`✅ Blocked ${totalCreated} slots`);
        alert(`🚫 Successfully blocked ${blockTypeText}: ${reason}\n\nCreated ${totalCreated} blocked slots.`);
        closeBlockDateModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error blocking dates:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error blocking dates. Please try again.');
      }
    };
    
    document.getElementById('sessionDetailsForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const bookingId = document.getElementById('sessionBookingId').value;
      const sessionDate = document.getElementById('sessionDate').value;
      const sessionTime = document.getElementById('sessionTime').value;
      const sessionType = document.getElementById('sessionType').value;
      
      try {
        // Create or update calendar slot
        const calendarData = {
          fields: {
            SlotType: sessionType === 'Pop-Up' ? 'Pop-Up' : 'Regular',
            Location: 'Cheesman Park', // Default location
            date: sessionDate,
            time: sessionTime,
            endTime: sessionTime, // Will be calculated based on session type
            status: 'booked',
            bookingId: bookingId,
            sessionType: sessionType,
            bufferTime: sessionType === 'Pop-Up' ? 10 : 60,
            isBlocked: false
          }
        };
        
        // Create booking record
        const bookingData = {
          fields: {
            bookingId: bookingId,
            client1Name: document.getElementById('client1Name').value,
            client1Email: document.getElementById('client1Email').value,
            client1Phone: document.getElementById('client1Phone').value,
            client1Instagram: document.getElementById('client1Instagram').value,
            client2Name: document.getElementById('client2Name').value || null,
            client2Email: document.getElementById('client2Email').value || null,
            client2Phone: document.getElementById('client2Phone').value || null,
            client2Instagram: document.getElementById('client2Instagram').value || null,
            client1FirstPetName: document.getElementById('client1FirstPetName').value,
            client2FirstPetName: document.getElementById('client2FirstPetName').value || null,
            petCount: parseInt(document.getElementById('sessionPetCount').value),
            peopleCount: parseInt(document.getElementById('sessionPeopleCount').value),
            marketingConsent: document.getElementById('marketingConsent').checked,
            sessionDate: `${sessionDate}T${sessionTime}:00`
          }
        };
        
        // Create calendar slot first
        const calendarResponse = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(calendarData)
        });
        
        if (!calendarResponse.ok) {
          throw new Error(`Calendar creation error: ${calendarResponse.status}`);
        }
        
        const calendarResult = await calendarResponse.json();
        
        // Link booking to calendar slot
        bookingData.fields.calendarSlot = [calendarResult.id];
        
        // Create booking
        const bookingResponse = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bookingData)
        });
        
        if (!bookingResponse.ok) {
          throw new Error(`Booking creation error: ${bookingResponse.status}`);
        }
        
        console.log('✅ Session created successfully');
        alert('✅ Session created successfully!');
        closeSessionDetailsModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error creating session:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error creating session. Please try again.');
      }
    };
    
    // Listen for people count changes
    document.getElementById('sessionPeopleCount').onchange = updateClient2Fields;
    document.getElementById('sessionPetCount').onchange = updateClient2Fields;
    
    // Delete session function
    async function deleteSession(bookingId, calendarId) {
      if (!confirm('Are you sure you want to delete this session? This cannot be undone.')) {
        return;
      }
      
      try {
        // Delete booking
        if (bookingId) {
          const bookingResponse = await fetch(`https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings/${bookingId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
            }
          });
          
          if (!bookingResponse.ok) {
            throw new Error(`Booking deletion error: ${bookingResponse.status}`);
          }
        }
        
        // Delete calendar slot
        if (calendarId) {
          const calendarResponse = await fetch(`https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar/${calendarId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
            }
          });
          
          if (!calendarResponse.ok) {
            throw new Error(`Calendar deletion error: ${calendarResponse.status}`);
          }
        }
        
        console.log('✅ Session deleted successfully');
        alert('✅ Session deleted successfully!');
        closeSessionDetailsModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error deleting session:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error deleting session. Please try again.');
      }
    }
    
    // Debug function to test checkbox selection
    function debugCheckboxes() {
      console.log('🔍 DEBUGGING CHECKBOX SELECTION...');
      
      // Open the modal first if it's not open
      if (document.getElementById('bulkAvailabilityModal').style.display !== 'flex') {
        openBulkAvailabilityModal();
        console.log('📝 Opened availability modal for testing');
      }
      
      setTimeout(() => {
        // Test all checkbox selection methods
        console.log('🧪 Testing checkbox selection methods...');
        
        // Method 1: All checkboxes in form
        const allCheckboxes = document.querySelectorAll('#bulkAvailabilityForm input[type="checkbox"]');
        console.log('Method 1 - All checkboxes:', allCheckboxes.length);
        
        // Method 2: Day checkboxes specifically
        const dayCheckboxes = document.querySelectorAll('#bulkAvailabilityForm input[type="checkbox"][id^="day"]');
        console.log('Method 2 - Day checkboxes:', dayCheckboxes.length);
        
        // Method 3: By individual IDs
        const individualCheckboxes = [
          document.getElementById('daySun'),
          document.getElementById('dayMon'),
          document.getElementById('dayTue'),
          document.getElementById('dayWed'),
          document.getElementById('dayThu'),
          document.getElementById('dayFri'),
          document.getElementById('daySat')
        ];
        
        console.log('Method 3 - Individual checkboxes:', individualCheckboxes.filter(cb => cb !== null).length);
        
        // Check each day checkbox
        individualCheckboxes.forEach((checkbox, index) => {
          const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
          if (checkbox) {
            console.log(`${dayNames[index]} checkbox:`, {
              id: checkbox.id,
              value: checkbox.value,
              checked: checkbox.checked,
              exists: true
            });
          } else {
            console.log(`${dayNames[index]} checkbox: NOT FOUND`);
          }
        });
        
        // Auto-check Friday for testing
        const friCheckbox = document.getElementById('dayFri');
        if (friCheckbox) {
          friCheckbox.checked = true;
          console.log('✅ Auto-checked Friday for testing');
          
          // Test selection again
          const selectedDays = [];
          dayCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
              selectedDays.push(parseInt(checkbox.value));
            }
          });
          console.log('🎯 Selected days after auto-check:', selectedDays);
        } else {
          console.error('🚨 Friday checkbox not found!');
        }
        
        alert('Debug complete! Check console for detailed checkbox information.');
      }, 500); // Wait for modal to fully open
    }
    
    // Utility functions
    async function syncCalendarData() {
      console.log('Syncing calendar data...');
      await fetchCalendarData();
      await fetchBookingsData();
    }
    
    function exportCalendar() {
      // Export functionality - placeholder for now
      alert('📤 Calendar export functionality coming soon!');
    }
    
    // Test function to debug popup
    function testPopup() {
      console.log('Testing popup...');
      
      // Create fake event data for testing
      const fakeEvent = {
        id: 'test',
        date: '2025-05-24',
        time: '10:00',
        sessionType: 'Mini Session',
        location: 'Cheesman Park',
        status: 'booked',
        slotType: 'Regular'
      };
      
      const fakeBooking = {
        id: 'test-booking',
        client1Name: 'Test Client',
        client1Email: 'test@example.com',
        petCount: 1,
        peopleCount: 1,
        client1FirstPetName: 'Buddy'
      };
      
      // Add fake data temporarily
      currentSessionPopup = { events: [fakeEvent], dateString: '2025-05-24' };
      
      // Show popup at center of screen
      const popup = document.getElementById('sessionPopup');
      popup.style.position = 'fixed';
      popup.style.left = '50%';
      popup.style.top = '50%';
      popup.style.transform = 'translate(-50%, -50%)';
      
      // Populate popup
      document.getElementById('popupTitle').textContent = 'Test Client';
      document.getElementById('popupStatus').textContent = 'Booked';
      document.getElementById('popupStatus').className = 'session-popup-status booked';
      
      document.getElementById('popupDetails').innerHTML = `
        <div class="session-popup-detail">
          <span class="session-popup-icon">📅</span>
          <span>2025-05-24 at 10:00</span>
        </div>
        <div class="session-popup-detail">
          <span class="session-popup-icon">📸</span>
          <span>Mini Session</span>
        </div>
        <div class="session-popup-detail">
          <span class="session-popup-icon">📍</span>
          <span>Cheesman Park</span>
        </div>
        <div class="session-popup-detail">
          <span class="session-popup-icon">🐾</span>
          <span>1 pet, 1 person</span>
        </div>
        <div class="session-popup-detail">
          <span class="session-popup-icon">🐕</span>
          <span>Buddy</span>
        </div>
      `;
      
      popup.classList.add('show');
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        hideSessionPopup();
      }, 5000);
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Enhanced calendar management page loaded...');
      checkAuthentication();
      await fetchSessionTypes();
      await fetchCalendarData();
      await fetchBookingsData();
      
      // Debug: Log data after loading
      setTimeout(() => {
        console.log('Calendar data loaded:', calendarData.length, 'records');
        console.log('Bookings data loaded:', bookingsData.length, 'records');
        console.log('Sample calendar data:', calendarData.slice(0, 3));
        console.log('Sample bookings data:', bookingsData.slice(0, 3));
      }, 2000);
      
      // Close popup when clicking outside
      document.addEventListener('click', function(event) {
        const popup = document.getElementById('sessionPopup');
        if (!popup.contains(event.target) && !event.target.closest('.calendar-day')) {
          hideSessionPopup();
        }
      });
    });
  </script>
</body>
</html>
