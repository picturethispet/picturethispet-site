<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendar Management | Picture This Pet Admin</title>
  <meta name="description" content="Manage calendar slots, sessions, and pop-up events for Picture This Pet photography business.">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  
  <!-- Interact.js for drag-and-drop functionality -->
  <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.27/dist/interact.min.js"></script>
  
  <style>
    :root {
      --orange: #F47C2C;
      --gold: #FDB75E;
      --dark-brown: #4B2E1E;
      --available-green: #10b981;
      --booked-red: #ef4444;
      --soft-hold-yellow: #f59e0b;
      --admin-purple: #8b5cf6;
      --admin-blue: #3b82f6;
      --popup-event-purple: #a78bfa;
      --blocked-gray: #6b7280;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }
    html::-webkit-scrollbar {
      width: 8px;
    }
    html::-webkit-scrollbar-track {
      background: transparent;
    }
    html::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: white;
      background: none;
    }
    @keyframes moveBackground {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Drag selection styles */
    .drag-selection {
      position: absolute;
      background: rgba(253, 183, 94, 0.3);
      border: 2px solid var(--gold);
      border-radius: 4px;
      pointer-events: none;
      z-index: 1000;
    }
    
    .calendar-day.drag-hover {
      background: rgba(253, 183, 94, 0.2) !important;
      border: 2px solid var(--gold) !important;
    }
    
    .calendar-day.drag-selected {
      background: rgba(253, 183, 94, 0.3) !important;
      border: 2px solid var(--gold) !important;
    }
    
    /* === LAYOUT === */
    .admin-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
      background-image: url("assets/images/main_background_allsystem.png");
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
    }
    /* === HEADER STYLES === */
    header {
      grid-column: 1 / -1;
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 2rem;
    }
    .logo-small {
      height: 50px;
    }
    .header-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .sync-status {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .sync-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--available-green);
      animation: pulse 2s infinite;
    }
    .sync-indicator.disconnected {
      background: var(--booked-red);
    }
    .admin-user {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.8rem 1.5rem;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .logout-btn {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.7rem 1.2rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 80px;
    }
    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    /* === SIDEBAR === */
    .admin-sidebar {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 2rem 0;
      overflow-y: auto;
    }
    .nav-section {
      margin-bottom: 2rem;
    }
    .nav-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 1.5rem;
      margin-bottom: 0.5rem;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      min-height: 48px;
      text-decoration: none;
    }
    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-left-color: var(--gold);
    }
    .nav-icon {
      font-size: 1.2rem;
      width: 20px;
      text-align: center;
    }
    .nav-badge {
      background: var(--booked-red);
      color: white;
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      margin-left: auto;
    }
    /* === MAIN CONTENT === */
    .admin-main {
      padding: 2rem;
      padding-bottom: 4rem;
    }
    /* === CARDS === */
    .admin-card {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      padding: 2rem;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .card-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }
    .card-actions {
      display: flex;
      gap: 0.5rem;
    }
    /* === BUTTONS === */
    .btn {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-height: 48px;
      min-width: 80px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--orange), var(--gold));
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(244, 124, 44, 0.3);
    }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      min-height: 40px;
      min-width: 60px;
    }
    .btn-icon {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 0.6rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 40px;
      min-width: 40px;
    }
    .btn-icon:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    /* === CALENDAR GRID === */
    .calendar-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
      position: relative;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .calendar-month {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      min-width: 200px;
      text-align: center;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    .calendar-day {
      background: rgba(255, 255, 255, 0.05);
      padding: 0.8rem 0.5rem;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }
    .calendar-day:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .calendar-day.other-month {
      opacity: 0.3;
    }
    .calendar-day.today {
      background: rgba(244, 124, 44, 0.2);
      border: 2px solid var(--orange);
    }
    .calendar-day.has-events {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--available-green);
    }
    .calendar-day.has-bookings {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--booked-red);
    }
    .calendar-day.has-popups {
      background: rgba(167, 139, 250, 0.1);
      border-left: 4px solid var(--popup-event-purple);
    }
    .calendar-day.blocked {
      background: rgba(107, 114, 128, 0.2);
      border-left: 4px solid var(--blocked-gray);
    }
    .day-number {
      font-weight: 600;
      font-size: 1rem;
      color: white;
      margin-bottom: 0.5rem;
    }
    .day-events {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      width: 100%;
    }
    .event-dot {
      width: 100%;
      height: 3px;
      border-radius: 2px;
      background: var(--available-green);
    }
    .event-dot.booked {
      background: var(--booked-red);
    }
    .event-dot.popup {
      background: var(--popup-event-purple);
    }
    .event-dot.blocked {
      background: var(--blocked-gray);
    }
    /* === LEGEND === */
    .calendar-legend {
      display: flex;
      gap: 1.5rem;
      justify-content: center;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .legend-dot.available {
      background: var(--available-green);
    }
    .legend-dot.booked {
      background: var(--booked-red);
    }
    .legend-dot.popup {
      background: var(--popup-event-purple);
    }
    .legend-dot.blocked {
      background: var(--blocked-gray);
    }
    
    /* === FORMS === */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-label {
      display: block;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: rgba(255, 255, 255, 0.9);
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.8rem;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      color: white;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      transition: all 0.3s ease;
      resize: vertical;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(255, 255, 255, 0.15);
    }
    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* === NEW CALENDAR ACTION MODAL === */
    .calendar-action-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .calendar-action-content {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      padding: 2rem;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 600px;
      width: 90%;
    }

    .action-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .action-option {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .action-option:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: var(--gold);
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(244, 124, 44, 0.3);
    }

    .action-option-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .action-option-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: var(--gold);
    }

    .action-option-desc {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.4;
    }

    /* === SMART AVAILABILITY SECTION === */
    .smart-availability {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--available-green);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .smart-availability h4 {
      color: var(--available-green);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .bulk-option {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .bulk-toggle {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 28px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .toggle-switch.active {
      background: var(--available-green);
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(22px);
    }

    /* === MODALS === */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      padding: 2rem;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }
    .modal-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.3s ease;
      min-height: 40px;
      min-width: 40px;
    }
    .modal-close:hover {
      color: white;
    }
    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }
    /* === STATS === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(244, 124, 44, 0.3);
    }
    .stat-card h4 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--gold);
    }
    .stat-card p {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }
    /* === RESPONSIVE === */
    @media (max-width: 1024px) {
      .admin-layout {
        grid-template-columns: 60px 1fr;
      }
      .admin-sidebar {
        padding: 1rem 0;
      }
      .nav-item {
        padding: 1rem 0.8rem;
        justify-content: center;
      }
      .nav-item span:not(.nav-icon) {
        display: none;
      }
      .nav-section-title {
        display: none;
      }
      .calendar-day {
        min-height: 60px;
        padding: 0.5rem 0.3rem;
      }
      .day-number {
        font-size: 0.8rem;
      }
      .action-options {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 768px) {
      .admin-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .admin-sidebar {
        background: rgba(0, 0, 0, 0.9);
        position: fixed;
        top: 0;
        left: -100%;
        width: 280px;
        height: 100vh;
        z-index: 4000;
        transition: left 0.3s ease;
      }
      .admin-sidebar.open {
        left: 0;
      }
      .mobile-menu-btn {
        display: block;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .mobile-menu-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .header-title {
        font-size: 1.4rem;
      }
      .admin-main {
        padding: 1rem;
        padding-bottom: 2rem;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      .calendar-grid {
        font-size: 0.8rem;
      }
      .calendar-day {
        min-height: 50px;
        padding: 0.3rem 0.2rem;
      }
      .day-number {
        font-size: 0.7rem;
      }
      .calendar-legend {
        font-size: 0.8rem;
      }
      .modal {
        padding: 1.5rem;
        margin: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Header -->
    <header class="admin-header">
      <div class="header-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()" style="display: none;">‚ò∞</button>
        <img src="assets/images/headerlogowarm.png" alt="PictureThisPet Logo" class="logo-small" />
        <h1 class="header-title">Calendar Management üìÖ</h1>
      </div>
      <div class="header-right">
        <div class="sync-status">
          <div class="sync-indicator" id="syncIndicator"></div>
          <span id="syncStatus">Connected</span>
        </div>
        <div class="admin-user" id="adminUser">Welcome, Admin</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>
    <!-- Sidebar -->
    <nav class="admin-sidebar" id="adminSidebar">
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <a href="admin.html" class="nav-item">
          <span class="nav-icon">üìä</span>
          <span>Dashboard</span>
        </a>
        <a href="calendar-management.html" class="nav-item active">
          <span class="nav-icon">üìÖ</span>
          <span>Calendar Management</span>
          <span class="nav-badge" id="calendarBadge">0</span>
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Management</div>
        <a href="client-session-management.html" class="nav-item">
          <span class="nav-icon">üë•</span>
          <span>Client & Session Management</span>
        </a>
        <a href="gallery-management.html" class="nav-item">
          <span class="nav-icon">üñºÔ∏è</span>
          <span>Gallery Management</span>
          <span class="nav-badge" id="galleriesBadge">0</span>
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Business</div>
        <a href="business-management.html" class="nav-item">
          <span class="nav-icon">üìà</span>
          <span>Business Management</span>
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">System</div>
        <a href="#" class="nav-item">
          <span class="nav-icon">‚öôÔ∏è</span>
          <span>Settings</span>
        </a>
      </div>
    </nav>
    <!-- Main Content -->
    <main class="admin-main">
      <!-- Calendar Stats -->
      <div class="admin-card">
        <div class="card-header">
          <h2 class="card-title">Calendar Overview üìä</h2>
          <div class="card-actions">
            <button class="btn btn-secondary btn-small" onclick="syncCalendarData()">üîÑ Sync</button>
            <button class="btn btn-secondary btn-small" onclick="debugCheckboxes()" style="background: var(--booked-red);">üîç Debug Checkboxes</button>
            <button class="btn btn-primary btn-small" onclick="exportCalendar()">üì§ Export</button>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card">
            <h4>Available Slots This Week üìÖ</h4>
            <p id="available-slots">Loading...</p>
          </div>
          <div class="stat-card">
            <h4>Booked Sessions This Week üì∏</h4>
            <p id="booked-sessions">Loading...</p>
          </div>
          <div class="stat-card">
            <h4>Pop-Up Events This Week üéâ</h4>
            <p id="popup-events">Loading...</p>
          </div>
          <div class="stat-card">
            <h4>Blocked Days This Month üö´</h4>
            <p id="blocked-days">Loading...</p>
          </div>
        </div>
      </div>
      <!-- Calendar View -->
      <div class="admin-card">
        <div class="card-header">
          <h2 class="card-title">Calendar View üóìÔ∏è <small style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">(Click dates to set availability or quick book)</small></h2>
          <div class="card-actions">
            <button class="btn btn-primary btn-small" onclick="openSetAvailabilityModal()">üìÖ Add Availability</button>
            <button class="btn btn-primary btn-small" onclick="openPopupEventModal()">üéâ Create Pop-Up Event</button>
            <button class="btn btn-secondary btn-small" onclick="openBlockDateModal()">üö´ Block Date</button>
          </div>
        </div>
        <div class="calendar-container">
          <div class="calendar-header">
            <div class="calendar-nav">
              <button class="btn-icon" onclick="changeMonth(-1)">‚Üê</button>
              <div class="calendar-month" id="calendarMonth">May 2025</div>
              <button class="btn-icon" onclick="changeMonth(1)">‚Üí</button>
            </div>
            <button class="btn btn-secondary btn-small" onclick="goToToday()">üìç Today</button>
          </div>
          <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar days will be populated here -->
          </div>
          <div class="calendar-legend">
            <div class="legend-item">
              <div class="legend-dot available"></div>
              <span>Available Slots</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot booked"></div>
              <span>Booked Sessions</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot popup"></div>
              <span>Pop-Up Events</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot blocked"></div>
              <span>Blocked Dates</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- NEW Calendar Action Modal -->
  <div class="calendar-action-modal" id="calendarActionModal">
    <div class="calendar-action-content">
      <div class="modal-header">
        <h3 class="modal-title">What would you like to do? ‚ö°</h3>
        <button class="modal-close" onclick="closeCalendarActionModal()">√ó</button>
      </div>
      
      <div id="selectedDateInfo" style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <!-- Selected date info will appear here -->
      </div>
      
      <div class="action-options">
        <div class="action-option" onclick="selectSetAvailability()">
          <div class="action-option-icon">üìÖ</div>
          <div class="action-option-title">Set Availability</div>
          <div class="action-option-desc">Create hourly booking slots for clients to book sessions</div>
        </div>
        
        <div class="action-option" onclick="selectQuickBook()">
          <div class="action-option-icon">‚ö°</div>
          <div class="action-option-title">QuickBook</div>
          <div class="action-option-desc">Quickly book a session and block the time automatically</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Set Availability Modal -->
  <div class="modal-overlay" id="setAvailabilityModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Set Availability üìÖ</h3>
        <button class="modal-close" onclick="closeSetAvailabilityModal()">√ó</button>
      </div>
      
      <form id="setAvailabilityForm">
        <div id="selectedDateRangeInfo" style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
          <!-- Selected date range will appear here -->
        </div>

        <!-- Smart Availability Section -->
        <div class="smart-availability" id="smartAvailabilitySection" style="display: none;">
          <h4>üß† Smart Availability</h4>
          <p id="smartAvailabilityText" style="margin-bottom: 1rem;"></p>
          
          <div class="bulk-option">
            <div class="bulk-toggle">
              <div class="toggle-switch" id="bulkToggle" onclick="toggleBulkMode()">
                <div class="toggle-slider"></div>
              </div>
              <label>Apply to all <span id="bulkDayName">Fridays</span> in date range</label>
            </div>
            <p id="bulkDescription" style="font-size: 0.9rem; color: rgba(255,255,255,0.7);"></p>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Start Date üìÖ</label>
            <input type="date" class="form-input" id="availabilityStartDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">End Date üìÖ</label>
            <input type="date" class="form-input" id="availabilityEndDate" required>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Start Time ‚è∞</label>
            <input type="time" class="form-input" id="availabilityStartTime" value="08:00" required>
          </div>
          <div class="form-group">
            <label class="form-label">End Time ‚è∞</label>
            <input type="time" class="form-input" id="availabilityEndTime" value="18:00" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Location üìç</label>
          <select class="form-select" id="availabilityLocation" required>
            <option value="Cheesman Park">Cheesman Park</option>
            <option value="City Park">City Park</option>
            <option value="Washington Park">Washington Park</option>
            <option value="Cherry Creek">Cherry Creek</option>
            <option value="TBD">Location TBD</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Session Buffer Time ‚è±Ô∏è</label>
          <select class="form-select" id="availabilityBufferTime" required>
            <option value="30">30 minutes between sessions</option>
            <option value="60" selected>1 hour between sessions (recommended)</option>
            <option value="90">1.5 hours between sessions</option>
            <option value="120">2 hours between sessions</option>
          </select>
          <small style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">Buffer time added automatically after each booked session</small>
        </div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
          <h4 style="color: var(--gold); margin-bottom: 0.5rem;">üìã How This Works:</h4>
          <ul style="font-size: 0.9rem; color: rgba(255,255,255,0.8); line-height: 1.5;">
            <li>‚Ä¢ Creates hourly booking slots (8 AM, 9 AM, 10 AM, etc.)</li>
            <li>‚Ä¢ Any session type can book any available slot</li>
            <li>‚Ä¢ When booked, automatically blocks session + buffer time</li>
            <li>‚Ä¢ Example: Mini (60 min) + 1hr buffer = next slot 2 hours later</li>
            <li>‚Ä¢ Only your created availability appears to clients</li>
          </ul>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeSetAvailabilityModal()">Cancel üö´</button>
          <button type="submit" class="btn btn-primary">Create Availability üìÖ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Enhanced Quick Book Modal -->
  <div class="modal-overlay" id="quickBookModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Quick Book Session ‚ö°</h3>
        <button class="modal-close" onclick="closeQuickBookModal()">√ó</button>
      </div>
      
      <form id="quickBookForm">
        <div id="quickBookDateInfo" style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
          <!-- Selected date will appear here -->
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Session Date üìÖ</label>
            <input type="date" class="form-input" id="quickBookDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Session Time ‚è∞</label>
            <input type="time" class="form-input" id="quickBookTime" required>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Session Type üì∏</label>
            <select class="form-select" id="quickBookSessionType" required>
              <option value="Mini Session">Mini Session (60 min)</option>
              <option value="Full Session">Full Session (90 min)</option>
              <option value="Pop-Up">Pop-Up Session (10 min)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Location üìç</label>
            <select class="form-select" id="quickBookLocation" required>
              <option value="Cheesman Park">Cheesman Park</option>
              <option value="City Park">City Park</option>
              <option value="Washington Park">Washington Park</option>
              <option value="Cherry Creek">Cherry Creek</option>
              <option value="TBD">Location TBD</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Client Name üë§</label>
          <input type="text" class="form-input" id="quickBookClientName" placeholder="Enter client name" required>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Client Phone üì±</label>
            <input type="tel" class="form-input" id="quickBookClientPhone" placeholder="(303) 555-0123" required>
          </div>
          <div class="form-group">
            <label class="form-label">Pet Count üêæ</label>
            <select class="form-select" id="quickBookPetCount">
              <option value="1">1 Pet</option>
              <option value="2">2 Pets</option>
              <option value="3">3 Pets</option>
              <option value="4">4+ Pets</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Quick Notes üìù</label>
          <textarea class="form-input" id="quickBookNotes" rows="2" placeholder="Any quick notes about this session..."></textarea>
        </div>
        
        <div style="background: rgba(139, 92, 246, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid var(--admin-purple);">
          <h4 style="color: var(--admin-purple); margin-bottom: 0.5rem;">‚ö° Quick Book Features:</h4>
          <ul style="font-size: 0.9rem; color: rgba(255,255,255,0.8); line-height: 1.5;">
            <li>‚Ä¢ Automatically blocks session duration + buffer time</li>
            <li>‚Ä¢ Prevents other bookings during this window</li>
            <li>‚Ä¢ Creates calendar entry immediately</li>
            <li>‚Ä¢ Client can complete details later via portal</li>
          </ul>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeQuickBookModal()">Cancel üö´</button>
          <button type="submit" class="btn btn-primary">‚ö° Quick Book Session</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Pop-Up Event Modal (unchanged) -->
  <div class="modal-overlay" id="popupEventModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Create Pop-Up Event üéâ</h3>
        <button class="modal-close" onclick="closePopupEventModal()">√ó</button>
      </div>
      
      <form id="popupEventForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Event Date üìÖ</label>
            <input type="date" class="form-input" id="popupDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Start Time ‚è∞</label>
            <input type="time" class="form-input" id="popupStartTime" required>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Location üìç</label>
            <select class="form-select" id="popupLocation" required>
              <option value="Cheesman Park">Cheesman Park</option>
              <option value="City Park">City Park</option>
              <option value="Cherry Creek">Cherry Creek</option>
              <option value="Washington Park">Washington Park</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Number of Slots üéØ</label>
            <input type="number" class="form-input" id="popupSlots" min="1" max="20" value="10" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Event Description üìù</label>
          <input type="text" class="form-input" id="popupDescription" placeholder="e.g., Spring Pop-Up at Cheesman Park" required>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closePopupEventModal()">Cancel üö´</button>
          <button type="submit" class="btn btn-primary">Create Event üéâ</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Block Date Modal (unchanged) -->
  <div class="modal-overlay" id="blockDateModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Block Date üö´</h3>
        <button class="modal-close" onclick="closeBlockDateModal()">√ó</button>
      </div>
      
      <form id="blockDateForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Start Date üìÖ</label>
            <input type="date" class="form-input" id="blockStartDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">End Date üìÖ</label>
            <input type="date" class="form-input" id="blockEndDate" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Block Type üö´</label>
          <select class="form-select" id="blockType" onchange="toggleTimeInputs()" required>
            <option value="full-day">Full Day Block</option>
            <option value="time-range">Specific Time Range</option>
          </select>
        </div>
        
        <div class="form-grid" id="timeRangeInputs" style="display: none;">
          <div class="form-group">
            <label class="form-label">Start Time ‚è∞</label>
            <input type="time" class="form-input" id="blockStartTime" value="09:00">
          </div>
          <div class="form-group">
            <label class="form-label">End Time ‚è∞</label>
            <input type="time" class="form-input" id="blockEndTime" value="17:00">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Reason üìù</label>
          <input type="text" class="form-input" id="blockReason" placeholder="e.g., Personal time off, Equipment maintenance, Private event" required>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeBlockDateModal()">Cancel üö´</button>
          <button type="submit" class="btn btn-primary">Block Time üö´</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // Global variables
    let calendarData = [];
    let bookingsData = [];
    let sessionTypes = [];
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let selectedCalendarDate = null;
    let isBulkMode = false;
    
    // Authentication and initialization
    function checkAuthentication() {
      const isAuthenticated = localStorage.getItem('adminAuthenticated');
      if (!isAuthenticated) {
        console.log('Not authenticated, redirecting to login...');
        window.location.href = '/portal.html';
        return;
      }
      const adminUser = localStorage.getItem('adminUser') || 'Admin';
      document.getElementById('adminUser').textContent = `Welcome, ${adminUser} üëã`;
      console.log('Authenticated as:', adminUser);
    }
    
    function logout() {
      console.log('Logging out...');
      localStorage.removeItem('adminAuthenticated');
      localStorage.removeItem('adminUser');
      localStorage.removeItem('adminLoginTime');
      window.location.href = '/portal.html';
    }
    
    function toggleSidebar() {
      console.log('Toggling sidebar...');
      const sidebar = document.getElementById('adminSidebar');
      sidebar.classList.toggle('open');
    }
    
    // Error logging
    async function logErrorToAirtable(page, error, data = {}) {
      try {
        const errorId = `ERR_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const errorRecord = {
          fields: {
            errorId: errorId,
            timestamp: new Date().toISOString(),
            page: page,
            errorMessage: error.message || String(error),
            errorStack: error.stack || 'No stack trace available',
            userAgent: navigator.userAgent,
            sessionData: JSON.stringify(data)
          }
        };
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Errors', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(errorRecord)
        });
        if (response.ok) {
          console.log('‚úÖ Error logged to Airtable:', errorRecord);
        } else {
          console.warn('‚ö†Ô∏è Failed to log error to Airtable:', response.status);
        }
      } catch (innerError) {
        console.warn('‚ö†Ô∏è Failed to log error to Airtable:', innerError);
      }
    }
    
    // Data fetching functions
    async function fetchCalendarData() {
      try {
        console.log('Fetching calendar data from Airtable...');
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });
        if (!response.ok) {
          throw new Error(`Airtable error: ${response.status}`);
        }
        const data = await response.json();
        calendarData = data.records.map(record => ({
          id: record.id,
          date: record.fields.date,
          time: record.fields.time,
          endTime: record.fields.endTime,
          status: record.fields.status,
          bookingId: record.fields.bookingId,
          sessionType: record.fields.sessionType,
          bufferTime: record.fields.bufferTime || 0,
          isBlocked: record.fields.isBlocked || false,
          slotType: record.fields.SlotType || 'Regular',
          location: record.fields.Location || ''
        }));
        console.log('Calendar data fetched:', calendarData);
        updateCalendarStats();
        renderCalendar();
      } catch (error) {
        console.error('Error fetching calendar data:', error);
        await logErrorToAirtable('calendar-management.html', error);
      }
    }
    
    async function fetchBookingsData() {
      try {
        console.log('Fetching bookings data from Airtable...');
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings', {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });
        if (!response.ok) {
          throw new Error(`Airtable error: ${response.status}`);
        }
        const data = await response.json();
        bookingsData = data.records.map(record => ({
          id: record.id,
          bookingId: record.fields.bookingId,
          client1Name: record.fields.client1Name,
          client2Name: record.fields.client2Name,
          client1Email: record.fields.client1Email,
          client2Email: record.fields.client2Email,
          client1Phone: record.fields.client1Phone,
          client2Phone: record.fields.client2Phone,
          client1Instagram: record.fields.client1Instagram,
          client2Instagram: record.fields.client2Instagram,
          client1Zip: record.fields.client1Zip,
          client2Zip: record.fields.client2Zip,
          client1FirstPetName: record.fields.client1FirstPetName,
          client2FirstPetName: record.fields.client2FirstPetName,
          marketingConsent: record.fields.marketingConsent,
          petCount: record.fields.petCount,
          peopleCount: record.fields.peopleCount,
          sessionDate: record.fields.sessionDate,
          calendarSlot: record.fields.calendarSlot ? record.fields.calendarSlot[0] : null
        }));
        console.log('Bookings data fetched:', bookingsData);
      } catch (error) {
        console.error('Error fetching bookings data:', error);
        await logErrorToAirtable('calendar-management.html', error);
      }
    }
    
    async function fetchSessionTypes() {
      try {
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/SessionTypes', {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });
        const data = await response.json();
        sessionTypes = data.records.map(record => ({
          id: record.id,
          typeName: record.fields.typeName,
          duration: record.fields.duration,
          price: record.fields.price || 0
        }));
      } catch (error) {
        console.error('Error fetching session types:', error);
        await logErrorToAirtable('calendar-management.html', error);
      }
    }
    
    // Calendar rendering functions
    function renderCalendar() {
      const calendarGrid = document.getElementById('calendarGrid');
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
      
      document.getElementById('calendarMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
      
      // Clear grid
      calendarGrid.innerHTML = '';
      
      // Add day headers
      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day';
        header.style.fontWeight = 'bold';
        header.style.background = 'rgba(255, 255, 255, 0.1)';
        header.textContent = day;
        calendarGrid.appendChild(header);
      });
      
      // Get first day of month and number of days
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const today = new Date();
      
      // Add empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day other-month';
        calendarGrid.appendChild(emptyDay);
      }
      
      // Add days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.dataset.date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        const currentDate = new Date(currentYear, currentMonth, day);
        const dateString = currentDate.toISOString().split('T')[0];
        
        // Check if it's today
        if (currentDate.toDateString() === today.toDateString()) {
          dayElement.classList.add('today');
        }
        
        // Get events for this day
        const dayEvents = calendarData.filter(slot => slot.date === dateString);
        
        // Classify day based on events
        const hasAvailable = dayEvents.some(event => event.status === 'available' && !event.isBlocked);
        const hasBooked = dayEvents.some(event => event.status === 'booked');
        const hasPopups = dayEvents.some(event => event.slotType === 'Pop-Up' || event.sessionType === 'Pop-Up');
        const hasBlocked = dayEvents.some(event => event.isBlocked);
        
        if (hasBlocked) {
          dayElement.classList.add('blocked');
        } else if (hasBooked) {
          dayElement.classList.add('has-bookings');
        } else if (hasPopups) {
          dayElement.classList.add('has-popups');
        } else if (hasAvailable) {
          dayElement.classList.add('has-events');
        }
        
        // Add day number
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        dayElement.appendChild(dayNumber);
        
        // Add event indicators
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'day-events';
        
        dayEvents.slice(0, 3).forEach(event => {
          const eventDot = document.createElement('div');
          eventDot.className = 'event-dot';
          
          if (event.isBlocked) {
            eventDot.classList.add('blocked');
          } else if (event.slotType === 'Pop-Up') {
            eventDot.classList.add('popup');
          } else if (event.status === 'booked') {
            eventDot.classList.add('booked');
          }
          
          eventsContainer.appendChild(eventDot);
        });
        
        dayElement.appendChild(eventsContainer);
        
        // Add click handler for new UX flow
        dayElement.onclick = () => handleCalendarDateClick(dateString, dayEvents);
        
        calendarGrid.appendChild(dayElement);
      }
    }
    
    // NEW Calendar Date Click Handler
    function handleCalendarDateClick(dateString, dayEvents) {
      selectedCalendarDate = dateString;
      
      // Show the new calendar action modal
      showCalendarActionModal(dateString, dayEvents);
    }
    
    function showCalendarActionModal(dateString, dayEvents) {
      const modal = document.getElementById('calendarActionModal');
      const infoDiv = document.getElementById('selectedDateInfo');
      
      const date = new Date(dateString);
      const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
      const formattedDate = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      // Show current status
      const availableSlots = dayEvents.filter(e => e.status === 'available' && !e.isBlocked);
      const bookedSessions = dayEvents.filter(e => e.status === 'booked');
      const blockedSlots = dayEvents.filter(e => e.isBlocked);
      
      let statusText = '';
      if (availableSlots.length > 0) {
        statusText += `‚úÖ ${availableSlots.length} available slots`;
      }
      if (bookedSessions.length > 0) {
        statusText += `${statusText ? ' ‚Ä¢ ' : ''}üì∏ ${bookedSessions.length} booked sessions`;
      }
      if (blockedSlots.length > 0) {
        statusText += `${statusText ? ' ‚Ä¢ ' : ''}üö´ ${blockedSlots.length} blocked`;
      }
      if (!statusText) {
        statusText = '‚ö™ No availability set';
      }
      
      infoDiv.innerHTML = `
        <h4 style="color: var(--gold); margin-bottom: 0.5rem;">üìÖ Selected Date</h4>
        <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">${formattedDate}</p>
        <p style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">${statusText}</p>
      `;
      
      modal.style.display = 'flex';
    }
    
    function closeCalendarActionModal() {
      document.getElementById('calendarActionModal').style.display = 'none';
      selectedCalendarDate = null;
    }
    
    function selectSetAvailability() {
      closeCalendarActionModal();
      openSetAvailabilityModal();
    }
    
    function selectQuickBook() {
      closeCalendarActionModal();
      openQuickBookModal();
    }
    
    // Enhanced Set Availability Modal Functions
    function openSetAvailabilityModal() {
      const modal = document.getElementById('setAvailabilityModal');
      
      if (selectedCalendarDate) {
        // Pre-fill with selected date
        document.getElementById('availabilityStartDate').value = selectedCalendarDate;
        document.getElementById('availabilityEndDate').value = selectedCalendarDate;
        
        // Show smart availability section for single date
        showSmartAvailability(selectedCalendarDate);
      } else {
        // Default to next 7 days
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        
        document.getElementById('availabilityStartDate').value = today.toISOString().split('T')[0];
        document.getElementById('availabilityEndDate').value = nextWeek.toISOString().split('T')[0];
      }
      
      updateSelectedDateRangeInfo();
      modal.style.display = 'flex';
    }
    
    function showSmartAvailability(dateString) {
      const date = new Date(dateString);
      const dayOfWeek = date.getDay();
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const dayName = dayNames[dayOfWeek];
      
      const smartSection = document.getElementById('smartAvailabilitySection');
      const smartText = document.getElementById('smartAvailabilityText');
      const bulkDayName = document.getElementById('bulkDayName');
      const bulkDescription = document.getElementById('bulkDescription');
      
      smartText.textContent = `You've selected a ${dayName}. You can apply this availability to all ${dayName}s in your date range.`;
      bulkDayName.textContent = `${dayName}s`;
      bulkDescription.textContent = `When enabled, this will create availability for every ${dayName} between your start and end dates.`;
      
      smartSection.style.display = 'block';
    }
    
    function updateSelectedDateRangeInfo() {
      const startDate = document.getElementById('availabilityStartDate').value;
      const endDate = document.getElementById('availabilityEndDate').value;
      const infoDiv = document.getElementById('selectedDateRangeInfo');
      
      if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (startDate === endDate) {
          infoDiv.innerHTML = `
            <h4 style="color: var(--gold); margin-bottom: 0.5rem;">üìÖ Single Date</h4>
            <p>${start.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
          `;
          showSmartAvailability(startDate);
        } else {
          const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
          infoDiv.innerHTML = `
            <h4 style="color: var(--gold); margin-bottom: 0.5rem;">üìÖ Date Range</h4>
            <p><strong>From:</strong> ${start.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            <p><strong>To:</strong> ${end.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            <p><strong>Total Days:</strong> ${days}</p>
          `;
          document.getElementById('smartAvailabilitySection').style.display = 'none';
        }
      }
    }
    
    function toggleBulkMode() {
      const toggle = document.getElementById('bulkToggle');
      isBulkMode = !isBulkMode;
      
      if (isBulkMode) {
        toggle.classList.add('active');
      } else {
        toggle.classList.remove('active');
      }
    }
    
    function closeSetAvailabilityModal() {
      document.getElementById('setAvailabilityModal').style.display = 'none';
      document.getElementById('setAvailabilityForm').reset();
      document.getElementById('smartAvailabilitySection').style.display = 'none';
      isBulkMode = false;
      document.getElementById('bulkToggle').classList.remove('active');
      
      // Reset defaults
      document.getElementById('availabilityStartTime').value = '08:00';
      document.getElementById('availabilityEndTime').value = '18:00';
      document.getElementById('availabilityBufferTime').value = '60';
    }
    
    // Enhanced Quick Book Modal Functions
    function openQuickBookModal() {
      const modal = document.getElementById('quickBookModal');
      const infoDiv = document.getElementById('quickBookDateInfo');
      
      if (selectedCalendarDate) {
        document.getElementById('quickBookDate').value = selectedCalendarDate;
        
        const date = new Date(selectedCalendarDate);
        infoDiv.innerHTML = `
          <h4 style="color: var(--admin-purple); margin-bottom: 0.5rem;">‚ö° Quick Book Session</h4>
          <p>${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
        `;
      } else {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('quickBookDate').value = today;
        
        infoDiv.innerHTML = `
          <h4 style="color: var(--admin-purple); margin-bottom: 0.5rem;">‚ö° Quick Book Session</h4>
          <p>Today</p>
        `;
      }
      
      // Set default time
      document.getElementById('quickBookTime').value = '10:00';
      
      modal.style.display = 'flex';
    }
    
    function closeQuickBookModal() {
      document.getElementById('quickBookModal').style.display = 'none';
      document.getElementById('quickBookForm').reset();
    }
    
    // Listen for date changes in Set Availability form
    document.getElementById('availabilityStartDate').onchange = updateSelectedDateRangeInfo;
    document.getElementById('availabilityEndDate').onchange = updateSelectedDateRangeInfo;
    
    // Navigation functions
    function changeMonth(direction) {
      currentMonth += direction;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    }
    
    function goToToday() {
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      renderCalendar();
    }
    
    // Stats update function
    function updateCalendarStats() {
      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      
      const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
      const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      
      // Available slots this week
      const availableThisWeek = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= weekStart && slotDate <= weekEnd && 
               slot.status === 'available' && !slot.isBlocked;
      }).length;
      document.getElementById('available-slots').textContent = availableThisWeek;
      
      // Booked sessions this week
      const bookedThisWeek = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= weekStart && slotDate <= weekEnd && slot.status === 'booked';
      }).length;
      document.getElementById('booked-sessions').textContent = bookedThisWeek;
      
      // Pop-up events this week
      const popupsThisWeek = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= weekStart && slotDate <= weekEnd && slot.slotType === 'Pop-Up';
      }).length;
      document.getElementById('popup-events').textContent = popupsThisWeek;
      
      // Blocked days this month
      const blockedThisMonth = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= monthStart && slotDate <= monthEnd && slot.isBlocked;
      }).length;
      document.getElementById('blocked-days').textContent = blockedThisMonth;
      
      // Update badge
      document.getElementById('calendarBadge').textContent = calendarData.length;
    }
    
    // FIXED Set Availability Form submission handler
    document.getElementById('setAvailabilityForm').onsubmit = async function(e) {
      e.preventDefault();
      
      console.log('üî• SET AVAILABILITY FORM SUBMISSION STARTED');
      
      const startDate = new Date(document.getElementById('availabilityStartDate').value);
      const endDate = new Date(document.getElementById('availabilityEndDate').value);
      const startTime = document.getElementById('availabilityStartTime').value;
      const endTime = document.getElementById('availabilityEndTime').value;
      const location = document.getElementById('availabilityLocation').value;
      const bufferMinutes = parseInt(document.getElementById('availabilityBufferTime').value);
      
      console.log('üìÖ Form Data:', {
        startDate: startDate.toISOString().split('T')[0],
        endDate: endDate.toISOString().split('T')[0],
        startTime,
        endTime,
        location,
        bufferMinutes,
        isBulkMode
      });
      
      try {
        const slotsToCreate = [];
        
        // Calculate total hours for each day
        const start = new Date(`2025-01-01T${startTime}:00`);
        const end = new Date(`2025-01-01T${endTime}:00`);
        const totalHours = (end - start) / (1000 * 60 * 60);
        
        console.log(`‚è±Ô∏è Creating availability: ${startTime} to ${endTime} (${totalHours} hours per day)`);
        
        if (isBulkMode && selectedCalendarDate) {
          // Bulk mode: Apply only to specific day of week
          const selectedDate = new Date(selectedCalendarDate);
          const targetDayOfWeek = selectedDate.getDay();
          
          console.log(`üß† BULK MODE: Applying to all ${['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][targetDayOfWeek]}s`);
          
          for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateString = d.toISOString().split('T')[0];
            const dayOfWeek = d.getDay();
            
            console.log('üóìÔ∏è Processing date:', dateString, 'Day of week:', dayOfWeek, 'Target:', targetDayOfWeek);
            
            if (dayOfWeek === targetDayOfWeek) {
              console.log('‚úÖ Creating slots for date:', dateString);
              
              // Create hourly slots for this day
              const dayStart = new Date(`${dateString}T${startTime}:00`);
              const dayEnd = new Date(`${dateString}T${endTime}:00`);
              
              let slotCount = 0;
              for (let time = new Date(dayStart); time < dayEnd; time.setHours(time.getHours() + 1)) {
                const timeString = time.toTimeString().slice(0, 5);
                slotCount++;
                
                slotsToCreate.push({
                  fields: {
                    SlotType: 'Available',
                    Location: location,
                    date: dateString,
                    time: timeString,
                    endTime: timeString,
                    status: 'available',
                    sessionType: 'Open Availability',
                    bufferTime: bufferMinutes,
                    isBlocked: false,
                    isAvailable: true,
                    availabilityWindow: `${startTime}-${endTime}`,
                    createdByAdmin: true,
                    availabilityType: 'hourly-slot'
                  }
                });
              }
              
              console.log(`üìä Created ${slotCount} slots for ${dateString}`);
            } else {
              console.log('‚ùå Skipping date:', dateString, '(wrong day of week)');
            }
          }
        } else {
          // Regular mode: Apply to all days in range
          console.log('üìÖ REGULAR MODE: Applying to all days in range');
          
          for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateString = d.toISOString().split('T')[0];
            
            console.log('‚úÖ Creating slots for date:', dateString);
            
            // Create hourly slots for this day
            const dayStart = new Date(`${dateString}T${startTime}:00`);
            const dayEnd = new Date(`${dateString}T${endTime}:00`);
            
            let slotCount = 0;
            for (let time = new Date(dayStart); time < dayEnd; time.setHours(time.getHours() + 1)) {
              const timeString = time.toTimeString().slice(0, 5);
              slotCount++;
              
              slotsToCreate.push({
                fields: {
                  SlotType: 'Available',
                  Location: location,
                  date: dateString,
                  time: timeString,
                  endTime: timeString,
                  status: 'available',
                  sessionType: 'Open Availability',
                  bufferTime: bufferMinutes,
                  isBlocked: false,
                  isAvailable: true,
                  availabilityWindow: `${startTime}-${endTime}`,
                  createdByAdmin: true,
                  availabilityType: 'hourly-slot'
                }
              });
            }
            
            console.log(`üìä Created ${slotCount} slots for ${dateString}`);
          }
        }
        
        console.log('üéØ Total slots to create:', slotsToCreate.length);
        
        if (slotsToCreate.length === 0) {
          alert('üö® No slots to create. Please check your date and bulk settings.');
          return;
        }
        
        // Create slots in batches of 10
        let totalCreated = 0;
        console.log('üöÄ Starting Airtable API calls...');
        
        for (let i = 0; i < slotsToCreate.length; i += 10) {
          const batch = slotsToCreate.slice(i, i + 10);
          console.log(`üì§ Sending batch ${Math.ceil((i + 1) / 10)}:`, batch);
          
          const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ records: batch })
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('üö® API Error response:', errorText);
            throw new Error(`Airtable error: ${response.status} - ${errorText}`);
          }
          
          const result = await response.json();
          totalCreated += batch.length;
          console.log(`‚úÖ Created batch ${Math.ceil((i + 1) / 10)} - ${totalCreated} slots total`);
        }
        
        const modeText = isBulkMode ? `(bulk mode for ${['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][new Date(selectedCalendarDate).getDay()]}s)` : '';
        
        console.log(`üéâ SUCCESS! Created ${totalCreated} hourly availability slots ${modeText}`);
        alert(`‚úÖ Successfully created availability! ${modeText}\n\nüìÖ ${totalCreated} hourly booking slots created\nüìç Location: ${location}\n‚è∞ ${startTime} to ${endTime} daily\nüïê ${bufferMinutes} min buffer between sessions\n\nClients can now book any session type during these times.`);
        
        closeSetAvailabilityModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('üö® COMPLETE ERROR DETAILS:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('‚ùå Error creating availability slots. Error: ' + error.message);
      }
    };
    
    // Enhanced Quick Book Form submission
    document.getElementById('quickBookForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const formData = {
        date: document.getElementById('quickBookDate').value,
        time: document.getElementById('quickBookTime').value,
        sessionType: document.getElementById('quickBookSessionType').value,
        location: document.getElementById('quickBookLocation').value,
        clientName: document.getElementById('quickBookClientName').value,
        clientPhone: document.getElementById('quickBookClientPhone').value,
        petCount: parseInt(document.getElementById('quickBookPetCount').value),
        notes: document.getElementById('quickBookNotes').value
      };
      
      console.log('‚ö° Quick booking session:', formData);
      
      try {
        const bookingId = `QUICK_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
        
        // Calculate session duration and end time
        let sessionDuration = 60; // Default 60 minutes
        switch(formData.sessionType) {
          case 'Mini Session':
            sessionDuration = 60;
            break;
          case 'Full Session':
            sessionDuration = 90;
            break;
          case 'Pop-Up':
            sessionDuration = 10;
            break;
        }
        
        const sessionStart = new Date(`${formData.date}T${formData.time}:00`);
        const sessionEnd = new Date(sessionStart);
        sessionEnd.setMinutes(sessionEnd.getMinutes() + sessionDuration);
        const endTimeString = sessionEnd.toTimeString().slice(0, 5);
        
        // Create calendar slot (blocked time)
        const calendarSlot = {
          fields: {
            SlotType: 'Booked',
            Location: formData.location,
            date: formData.date,
            time: formData.time,
            endTime: endTimeString,
            status: 'booked',
            bookingId: bookingId,
            sessionType: formData.sessionType,
            bufferTime: 60, // Standard buffer
            isBlocked: false,
            quickBooked: true
          }
        };
        
        // Create minimal booking record
        const bookingRecord = {
          fields: {
            bookingId: bookingId,
            client1Name: formData.clientName,
            client1Phone: formData.clientPhone,
            petCount: formData.petCount,
            peopleCount: 1, // Default
            sessionDate: `${formData.date}T${formData.time}:00`,
            sessionType: formData.sessionType,
            notes: formData.notes,
            status: 'confirmed' // Quick booked sessions are immediately confirmed
          }
        };
        
        // Create both records
        console.log('üì§ Creating calendar slot and booking record...');
        
        const [calendarResponse, bookingResponse] = await Promise.all([
          fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(calendarSlot)
          }),
          fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(bookingRecord)
          })
        ]);
        
        if (!calendarResponse.ok) {
          throw new Error(`Calendar creation error: ${calendarResponse.status}`);
        }
        
        if (!bookingResponse.ok) {
          throw new Error(`Booking creation error: ${bookingResponse.status}`);
        }
        
        // Link the records
        const calendarResult = await calendarResponse.json();
        const bookingResult = await bookingResponse.json();
        
        // Update booking with calendar slot reference
        await fetch(`https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings/${bookingResult.id}`, {
          method: 'PATCH',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            fields: {
              calendarSlot: [calendarResult.id]
            }
          })
        });
        
        console.log('‚úÖ Quick booking completed successfully!');
        alert(`‚ö° Session quickly booked!\n\nBooking ID: ${bookingId}\nClient: ${formData.clientName}\nDate: ${formData.date} at ${formData.time}\nSession: ${formData.sessionType} (${sessionDuration} min)\nLocation: ${formData.location}\n\nüö´ Time automatically blocked: ${formData.time} - ${endTimeString}`);
        
        closeQuickBookModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error creating quick booking:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('‚ùå Error creating quick booking. Please try again.');
      }
    };
    
    // Other modal functions (removed duplicate function)
    
    function openPopupEventModal() {
      document.getElementById('popupEventModal').style.display = 'flex';
    }
    
    function closePopupEventModal() {
      document.getElementById('popupEventModal').style.display = 'none';
      document.getElementById('popupEventForm').reset();
    }
    
    function openBlockDateModal() {
      document.getElementById('blockDateModal').style.display = 'flex';
    }
    
    function closeBlockDateModal() {
      document.getElementById('blockDateModal').style.display = 'none';
      document.getElementById('blockDateForm').reset();
      document.getElementById('timeRangeInputs').style.display = 'none';
    }
    
    function toggleTimeInputs() {
      const blockType = document.getElementById('blockType').value;
      const timeInputs = document.getElementById('timeRangeInputs');
      timeInputs.style.display = blockType === 'time-range' ? 'grid' : 'none';
    }
    
    // Pop-up Event Form submission
    document.getElementById('popupEventForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const date = document.getElementById('popupDate').value;
      const startTime = document.getElementById('popupStartTime').value;
      const location = document.getElementById('popupLocation').value;
      const numSlots = parseInt(document.getElementById('popupSlots').value);
      const description = document.getElementById('popupDescription').value;
      
      try {
        const slotsToCreate = [];
        
        for (let i = 0; i < numSlots; i++) {
          const slotTime = new Date(`${date}T${startTime}:00`);
          slotTime.setMinutes(slotTime.getMinutes() + (i * 20)); // 10 min session + 10 min prep
          
          const timeString = slotTime.toTimeString().slice(0, 5);
          const endTime = new Date(slotTime);
          endTime.setMinutes(endTime.getMinutes() + 10);
          const endTimeString = endTime.toTimeString().slice(0, 5);
          
          slotsToCreate.push({
            fields: {
              SlotType: 'Pop-Up',
              Location: location,
              date: date,
              time: timeString,
              endTime: endTimeString,
              status: 'available',
              sessionType: 'Pop-Up',
              bufferTime: 10,
              isBlocked: false,
              description: description
            }
          });
        }
        
        // Create pop-up slots
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ records: slotsToCreate })
        });
        
        if (!response.ok) {
          throw new Error(`Airtable error: ${response.status}`);
        }
        
        console.log(`‚úÖ Created pop-up event with ${numSlots} slots`);
        alert(`üéâ Successfully created pop-up event "${description}"!\n\nüìç Location: ${location}\nüïê Start time: ${startTime}\nüéØ Slots created: ${numSlots}\n\nThese will appear on your homepage for client booking.`);
        closePopupEventModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error creating pop-up event:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('‚ùå Error creating pop-up event. Please try again.');
      }
    };
    
    // Block Date Form submission
    document.getElementById('blockDateForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const startDate = new Date(document.getElementById('blockStartDate').value);
      const endDate = new Date(document.getElementById('blockEndDate').value);
      const reason = document.getElementById('blockReason').value;
      const blockType = document.getElementById('blockType').value;
      
      try {
        const slotsToCreate = [];
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          const dateString = d.toISOString().split('T')[0];
          
          if (blockType === 'full-day') {
            // Block entire day
            slotsToCreate.push({
              fields: {
                SlotType: 'Blocked',
                Location: reason,
                date: dateString,
                time: '00:00',
                endTime: '23:59',
                status: 'blocked',
                sessionType: 'Blocked',
                bufferTime: 0,
                isBlocked: true,
                blockReason: reason
              }
            });
          } else {
            // Block specific time range
            const startTime = document.getElementById('blockStartTime').value;
            const endTime = document.getElementById('blockEndTime').value;
            
            slotsToCreate.push({
              fields: {
                SlotType: 'Blocked',
                Location: reason,
                date: dateString,
                time: startTime,
                endTime: endTime,
                status: 'blocked',
                sessionType: 'Blocked Time',
                bufferTime: 0,
                isBlocked: true,
                blockReason: reason
              }
            });
          }
        }
        
        // Create blocked slots in batches
        let totalCreated = 0;
        for (let i = 0; i < slotsToCreate.length; i += 10) {
          const batch = slotsToCreate.slice(i, i + 10);
          const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ records: batch })
          });
          
          if (!response.ok) {
            throw new Error(`Airtable error: ${response.status}`);
          }
          
          totalCreated += batch.length;
        }
        
        const blockTypeText = blockType === 'full-day' ? 'full day(s)' : 'time range(s)';
        console.log(`‚úÖ Blocked ${totalCreated} slots`);
        alert(`üö´ Successfully blocked ${blockTypeText}!\n\nReason: ${reason}\nSlots blocked: ${totalCreated}\n\nThis time is now unavailable for client booking.`);
        closeBlockDateModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error blocking dates:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('‚ùå Error blocking dates. Please try again.');
      }
    };
    
    // Debug function to test availability creation and check Airtable schema
    function debugCheckboxes() {
      console.log('üîç DEBUGGING CALENDAR SYSTEM...');
      console.log('üìä Current Data State:');
      console.log('  - Calendar records:', calendarData.length);
      console.log('  - Booking records:', bookingsData.length);
      console.log('  - Selected date:', selectedCalendarDate);
      console.log('  - Bulk mode:', isBulkMode);
      
      // STEP 1: Analyze existing calendar data to understand field structure
      if (calendarData.length > 0) {
        console.log('üîç EXISTING CALENDAR RECORD ANALYSIS:');
        console.log('Sample record fields:', Object.keys(calendarData[0]));
        console.log('Sample record data:', calendarData[0]);
        
        // Show field names in alert for easy copying
        const fieldNames = Object.keys(calendarData[0]);
        alert(`üîç CURRENT AIRTABLE FIELD NAMES:\n\n${fieldNames.join('\n')}\n\nCheck console for full record details.\n\nCompare these names with what we're trying to send in the API call.`);
      } else {
        console.log('‚ö†Ô∏è No existing calendar data to analyze');
        alert('‚ö†Ô∏è No existing calendar data found.\n\nPlease check:\n1. Your Airtable base has records in the Calendar table\n2. The API key has read permissions\n3. The table name is exactly "Calendar"');
      }
      
      // STEP 2: Test a minimal record creation
      console.log('üß™ Testing minimal record creation...');
      testMinimalRecordCreation();
    }
    
    // Test creating a minimal record to isolate field issues
    async function testMinimalRecordCreation() {
      try {
        console.log('üß™ Attempting to create minimal test record...');
        
        // Try the simplest possible record first
        const minimalRecord = {
          fields: {
            date: '2025-05-30',
            time: '10:00',
            status: 'available'
          }
        };
        
        console.log('üì§ Sending minimal record:', minimalRecord);
        
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(minimalRecord)
        });
        
        console.log('üì• Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå API Error:', errorText);
          alert(`‚ùå MINIMAL RECORD TEST FAILED:\n\nStatus: ${response.status}\nError: ${errorText}\n\nThis helps identify if it's a permissions issue or field name issue.`);
        } else {
          const result = await response.json();
          console.log('‚úÖ Minimal record created successfully:', result);
          alert('‚úÖ MINIMAL RECORD TEST PASSED!\n\nThe API connection works. The issue is likely with field names in the full record.\n\nCheck console for details.');
          
          // Clean up test record
          await fetch(`https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar/${result.id}`, {
            method: 'DELETE',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
            }
          });
          console.log('üßπ Test record cleaned up');
        }
        
      } catch (error) {
        console.error('‚ùå Test failed:', error);
        alert(`‚ùå CONNECTION TEST FAILED:\n\nError: ${error.message}\n\nThis suggests a fundamental connection issue.`);
      }
    }
    
    // Utility functions
    async function syncCalendarData() {
      console.log('üîÑ Syncing calendar data...');
      document.getElementById('syncStatus').textContent = 'Syncing...';
      document.getElementById('syncIndicator').className = 'sync-indicator';
      
      try {
        await Promise.all([
          fetchCalendarData(),
          fetchBookingsData()
        ]);
        
        document.getElementById('syncStatus').textContent = 'Connected';
        document.getElementById('syncIndicator').className = 'sync-indicator';
        console.log('‚úÖ Calendar data synced successfully');
        
      } catch (error) {
        document.getElementById('syncStatus').textContent = 'Error';
        document.getElementById('syncIndicator').className = 'sync-indicator disconnected';
        console.error('‚ùå Error syncing calendar data:', error);
      }
    }
    
    function exportCalendar() {
      // Create CSV export of calendar data
      const csvData = [
        ['Date', 'Time', 'Type', 'Status', 'Location', 'Client', 'Session Type'].join(',')
      ];
      
      calendarData.forEach(slot => {
        const booking = bookingsData.find(b => b.calendarSlot === slot.id);
        const clientName = booking ? booking.client1Name : '';
        
        csvData.push([
          slot.date,
          slot.time,
          slot.slotType,
          slot.status,
          slot.location,
          clientName,
          slot.sessionType
        ].join(','));
      });
      
      const csvContent = csvData.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `calendar-export-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      console.log('üì§ Calendar exported to CSV');
      alert('üì§ Calendar exported successfully!');
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Enhanced Calendar Management v2.0 loading...');
      checkAuthentication();
      
      try {
        await fetchSessionTypes();
        await fetchCalendarData();
        await fetchBookingsData();
        
        console.log('‚úÖ All data loaded successfully');
        console.log('üìä System Status:');
        console.log('  - Calendar records:', calendarData.length);
        console.log('  - Booking records:', bookingsData.length);
        console.log('  - Session types:', sessionTypes.length);
        
        // Update sync status
        document.getElementById('syncStatus').textContent = 'Connected';
        document.getElementById('syncIndicator').className = 'sync-indicator';
        
      } catch (error) {
        console.error('‚ùå Error loading data:', error);
        document.getElementById('syncStatus').textContent = 'Error';
        document.getElementById('syncIndicator').className = 'sync-indicator disconnected';
        await logErrorToAirtable('calendar-management.html', error);
      }
    });
  </script>
</body>
</html>
