<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendar Management | Picture This Pet Admin</title>
  <meta name="description" content="Manage calendar slots, sessions, and pop-up events for Picture This Pet photography business.">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --orange: #F47C2C;
      --gold: #FDB75E;
      --dark-brown: #4B2E1E;
      --available-green: #10b981;
      --booked-red: #ef4444;
      --soft-hold-yellow: #f59e0b;
      --admin-purple: #8b5cf6;
      --admin-blue: #3b82f6;
      --popup-event-purple: #a78bfa;
      --blocked-gray: #6b7280;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }

    html::-webkit-scrollbar {
      width: 8px;
    }

    html::-webkit-scrollbar-track {
      background: transparent;
    }

    html::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: white;
      background: none;
    }

    @keyframes moveBackground {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* === LAYOUT === */
    .admin-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: auto 1fr;
      min-height: 100vh;
      background-image: url("assets/images/main_background_allsystem.png");
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
    }

    /* === HEADER STYLES === */
    header {
      grid-column: 1 / -1;
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .logo-small {
      height: 50px;
    }

    .header-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .sync-status {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .sync-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--available-green);
      animation: pulse 2s infinite;
    }

    .sync-indicator.disconnected {
      background: var(--booked-red);
    }

    .admin-user {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.8rem 1.5rem;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.7rem 1.2rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 80px;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    /* === SIDEBAR === */
    .admin-sidebar {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 2rem 0;
      overflow-y: auto;
    }

    .nav-section {
      margin-bottom: 2rem;
    }

    .nav-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 1.5rem;
      margin-bottom: 0.5rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
      min-height: 48px;
      text-decoration: none;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .nav-item.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-left-color: var(--gold);
    }

    .nav-icon {
      font-size: 1.2rem;
      width: 20px;
      text-align: center;
    }

    .nav-badge {
      background: var(--booked-red);
      color: white;
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      margin-left: auto;
    }

    /* === MAIN CONTENT === */
    .admin-main {
      padding: 2rem;
      padding-bottom: 4rem;
    }

    /* === CARDS === */
    .admin-card {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      padding: 2rem;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .card-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }

    .card-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* === BUTTONS === */
    .btn {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-height: 48px;
      min-width: 80px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--orange), var(--gold));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(244, 124, 44, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      min-height: 40px;
      min-width: 60px;
    }

    .btn-icon {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 0.6rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 40px;
      min-width: 40px;
    }

    .btn-icon:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* === CALENDAR GRID === */
    .calendar-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .calendar-month {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      min-width: 200px;
      text-align: center;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    .calendar-day {
      background: rgba(255, 255, 255, 0.05);
      padding: 0.8rem 0.5rem;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .calendar-day:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .calendar-day.other-month {
      opacity: 0.3;
    }

    .calendar-day.today {
      background: rgba(244, 124, 44, 0.2);
      border: 2px solid var(--orange);
    }

    .calendar-day.has-events {
      background: rgba(16, 185, 129, 0.1);
      border-left: 4px solid var(--available-green);
    }

    .calendar-day.has-bookings {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--booked-red);
    }

    .calendar-day.has-popups {
      background: rgba(167, 139, 250, 0.1);
      border-left: 4px solid var(--popup-event-purple);
    }

    .calendar-day.blocked {
      background: rgba(107, 114, 128, 0.2);
      border-left: 4px solid var(--blocked-gray);
    }

    .day-number {
      font-weight: 600;
      font-size: 1rem;
      color: white;
      margin-bottom: 0.5rem;
    }

    .day-events {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      width: 100%;
    }

    .event-dot {
      width: 100%;
      height: 3px;
      border-radius: 2px;
      background: var(--available-green);
    }

    .event-dot.booked {
      background: var(--booked-red);
    }

    .event-dot.popup {
      background: var(--popup-event-purple);
    }

    .event-dot.blocked {
      background: var(--blocked-gray);
    }

    /* === LEGEND === */
    .calendar-legend {
      display: flex;
      gap: 1.5rem;
      justify-content: center;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .legend-dot.available {
      background: var(--available-green);
    }

    .legend-dot.booked {
      background: var(--booked-red);
    }

    .legend-dot.popup {
      background: var(--popup-event-purple);
    }

    .legend-dot.blocked {
      background: var(--blocked-gray);
    }

    /* === FORMS === */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.8rem;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      color: white;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      transition: all 0.3s ease;
      resize: vertical;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(255, 255, 255, 0.15);
    }

    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* === SESSION HOVER POPUP === */
    .session-popup {
      position: fixed;
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      padding: 1rem;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-width: 250px;
      max-width: 300px;
      z-index: 5000;
      pointer-events: none;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.2s ease;
    }

    .session-popup.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }

    .session-popup-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 0.8rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .session-popup-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--gold);
    }

    .session-popup-status {
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      margin-left: auto;
    }

    .session-popup-status.booked {
      background: rgba(239, 68, 68, 0.2);
      color: var(--booked-red);
      border: 1px solid var(--booked-red);
    }

    .session-popup-status.popup {
      background: rgba(167, 139, 250, 0.2);
      color: var(--popup-event-purple);
      border: 1px solid var(--popup-event-purple);
    }

    .session-popup-details {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-bottom: 1rem;
    }

    .session-popup-detail {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .session-popup-icon {
      font-size: 1rem;
      width: 18px;
      text-align: center;
    }

    .session-popup-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
    }

    .popup-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .popup-btn-primary {
      background: linear-gradient(135deg, var(--orange), var(--gold));
      color: white;
    }

    .popup-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(244, 124, 44, 0.3);
    }

    .popup-btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .popup-btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* === MODALS === */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      padding: 2rem;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    .modal-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.3s ease;
      min-height: 40px;
      min-width: 40px;
    }

    .modal-close:hover {
      color: white;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    /* === STATS === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(244, 124, 44, 0.3);
    }

    .stat-card h4 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--gold);
    }

    .stat-card p {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    /* === RESPONSIVE === */
    @media (max-width: 1024px) {
      .admin-layout {
        grid-template-columns: 60px 1fr;
      }

      .admin-sidebar {
        padding: 1rem 0;
      }

      .nav-item {
        padding: 1rem 0.8rem;
        justify-content: center;
      }

      .nav-item span:not(.nav-icon) {
        display: none;
      }

      .nav-section-title {
        display: none;
      }

      .calendar-day {
        min-height: 60px;
        padding: 0.5rem 0.3rem;
      }

      .day-number {
        font-size: 0.8rem;
      }
    }

    @media (max-width: 768px) {
      .admin-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }

      .admin-sidebar {
        background: rgba(0, 0, 0, 0.9);
        position: fixed;
        top: 0;
        left: -100%;
        width: 280px;
        height: 100vh;
        z-index: 4000;
        transition: left 0.3s ease;
      }

      .admin-sidebar.open {
        left: 0;
      }

      .mobile-menu-btn {
        display: block;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .mobile-menu-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .header-title {
        font-size: 1.4rem;
      }

      .admin-main {
        padding: 1rem;
        padding-bottom: 2rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .calendar-grid {
        font-size: 0.8rem;
      }

      .calendar-day {
        min-height: 50px;
        padding: 0.3rem 0.2rem;
      }

      .day-number {
        font-size: 0.7rem;
      }

      .calendar-legend {
        font-size: 0.8rem;
      }

      .modal {
        padding: 1.5rem;
        margin: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Header -->
    <header class="admin-header">
      <div class="header-left">
        <button class="mobile-menu-btn" onclick="toggleSidebar()" style="display: none;">☰</button>
        <img src="assets/images/headerlogowarm.png" alt="PictureThisPet Logo" class="logo-small" />
        <h1 class="header-title">Calendar Management 📅</h1>
      </div>

  <!-- Session Hover Popup -->
  <div class="session-popup" id="sessionPopup">
    <div class="session-popup-header">
      <div class="session-popup-title" id="popupTitle">Session Details</div>
      <div class="session-popup-status" id="popupStatus">Booked</div>
    </div>
    <div class="session-popup-details" id="popupDetails">
      <!-- Details will be populated by JavaScript -->
    </div>
    <div class="session-popup-actions">
      <button class="popup-btn popup-btn-secondary" onclick="editSessionQuick()">📝 Quick Edit</button>
      <button class="popup-btn popup-btn-primary" onclick="openClientRecord()">👤 Client Record</button>
    </div>
  </div>
      <div class="header-right">
        <div class="sync-status">
          <div class="sync-indicator" id="syncIndicator"></div>
          <span id="syncStatus">Connected</span>
        </div>
        <div class="admin-user" id="adminUser">Welcome, Admin</div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Sidebar -->
    <nav class="admin-sidebar" id="adminSidebar">
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <a href="admin.html" class="nav-item">
          <span class="nav-icon">📊</span>
          <span>Dashboard</span>
        </a>
        <a href="calendar-management.html" class="nav-item active">
          <span class="nav-icon">📅</span>
          <span>Calendar Management</span>
          <span class="nav-badge" id="calendarBadge">0</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Management</div>
        <a href="client-session-management.html" class="nav-item">
          <span class="nav-icon">👥</span>
          <span>Client & Session Management</span>
        </a>
        <a href="gallery-management.html" class="nav-item">
          <span class="nav-icon">🖼️</span>
          <span>Gallery Management</span>
          <span class="nav-badge" id="galleriesBadge">0</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Business</div>
        <a href="business-management.html" class="nav-item">
          <span class="nav-icon">📈</span>
          <span>Business Management</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">System</div>
        <a href="#" class="nav-item">
          <span class="nav-icon">⚙️</span>
          <span>Settings</span>
        </a>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="admin-main">
      <!-- Calendar Stats -->
      <div class="admin-card">
        <div class="card-header">
          <h2 class="card-title">Calendar Overview 📊</h2>
          <div class="card-actions">
            <button class="btn btn-secondary btn-small" onclick="syncCalendarData()">🔄 Sync</button>
            <button class="btn btn-secondary btn-small" onclick="testPopup()" style="background: var(--admin-purple);">🧪 Test Popup</button>
            <button class="btn btn-primary btn-small" onclick="exportCalendar()">📤 Export</button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <h4>Available Slots This Week 📅</h4>
            <p id="available-slots">Loading...</p>
          </div>
          <div class="stat-card">
            <h4>Booked Sessions This Week 📸</h4>
            <p id="booked-sessions">Loading...</p>
          </div>
          <div class="stat-card">
            <h4>Pop-Up Events This Week 🎉</h4>
            <p id="popup-events">Loading...</p>
          </div>
          <div class="stat-card">
            <h4>Blocked Days This Month 🚫</h4>
            <p id="blocked-days">Loading...</p>
          </div>
        </div>
      </div>

      <!-- Calendar View -->
      <div class="admin-card">
        <div class="card-header">
          <h2 class="card-title">Calendar View 🗓️</h2>
          <div class="card-actions">
            <button class="btn btn-primary btn-small" onclick="openBulkAvailabilityModal()">📅 Add Bulk Availability</button>
            <button class="btn btn-primary btn-small" onclick="openPopupEventModal()">🎉 Create Pop-Up Event</button>
            <button class="btn btn-secondary btn-small" onclick="openBlockDateModal()">🚫 Block Date</button>
          </div>
        </div>

        <div class="calendar-container">
          <div class="calendar-header">
            <div class="calendar-nav">
              <button class="btn-icon" onclick="changeMonth(-1)">←</button>
              <div class="calendar-month" id="calendarMonth">May 2025</div>
              <button class="btn-icon" onclick="changeMonth(1)">→</button>
            </div>
            <button class="btn btn-secondary btn-small" onclick="goToToday()">📍 Today</button>
          </div>

          <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar days will be populated here -->
          </div>

          <div class="calendar-legend">
            <div class="legend-item">
              <div class="legend-dot available"></div>
              <span>Available Slots</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot booked"></div>
              <span>Booked Sessions</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot popup"></div>
              <span>Pop-Up Events</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot blocked"></div>
              <span>Blocked Dates</span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Bulk Availability Modal -->
  <div class="modal-overlay" id="bulkAvailabilityModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Bulk Availability 📅</h3>
        <button class="modal-close" onclick="closeBulkAvailabilityModal()">×</button>
      </div>
      
      <form id="bulkAvailabilityForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Start Date 📅</label>
            <input type="date" class="form-input" id="bulkStartDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">End Date 📅</label>
            <input type="date" class="form-input" id="bulkEndDate" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Days of Week 📆</label>
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
            <div class="checkbox-group">
              <input type="checkbox" id="dayMon" value="1">
              <label for="dayMon">Mon</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="dayTue" value="2">
              <label for="dayTue">Tue</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="dayWed" value="3">
              <label for="dayWed">Wed</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="dayThu" value="4">
              <label for="dayThu">Thu</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="dayFri" value="5">
              <label for="dayFri">Fri</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="daySat" value="6" checked>
              <label for="daySat">Sat</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="daySun" value="0">
              <label for="daySun">Sun</label>
            </div>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Start Time ⏰</label>
            <input type="time" class="form-input" id="bulkStartTime" value="08:00" required>
          </div>
          <div class="form-group">
            <label class="form-label">End Time ⏰</label>
            <input type="time" class="form-input" id="bulkEndTime" value="17:00" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Availability Type 📅</label>
          <select class="form-select" id="bulkAvailabilityType" required>
            <option value="open">Open Availability (Any session type can book)</option>
            <option value="mini-only">Mini Sessions Only</option>
            <option value="full-only">Full Sessions Only</option>
            <option value="popup-only">Pop-Up Events Only</option>
          </select>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Default Location 📍</label>
            <select class="form-select" id="bulkLocation" required>
              <option value="Cheesman Park">Cheesman Park</option>
              <option value="City Park">City Park</option>
              <option value="Washington Park">Washington Park</option>
              <option value="Cherry Creek">Cherry Creek</option>
              <option value="TBD">Location TBD</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Slot Duration (minutes) ⏱️</label>
            <input type="number" class="form-input" id="slotDuration" value="20" min="10" max="120" required>
            <small style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">How long each bookable slot should be</small>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeBulkAvailabilityModal()">Cancel 🚫</button>
          <button type="submit" class="btn btn-primary">Create Slots 📅</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Pop-Up Event Modal -->
  <div class="modal-overlay" id="popupEventModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Create Pop-Up Event 🎉</h3>
        <button class="modal-close" onclick="closePopupEventModal()">×</button>
      </div>
      
      <form id="popupEventForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Event Date 📅</label>
            <input type="date" class="form-input" id="popupDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Start Time ⏰</label>
            <input type="time" class="form-input" id="popupStartTime" required>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Location 📍</label>
            <select class="form-select" id="popupLocation" required>
              <option value="Cheesman Park">Cheesman Park</option>
              <option value="City Park">City Park</option>
              <option value="Cherry Creek">Cherry Creek</option>
              <option value="Washington Park">Washington Park</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Number of Slots 🎯</label>
            <input type="number" class="form-input" id="popupSlots" min="1" max="20" value="10" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Event Description 📝</label>
          <input type="text" class="form-input" id="popupDescription" placeholder="e.g., Spring Pop-Up at Cheesman Park" required>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closePopupEventModal()">Cancel 🚫</button>
          <button type="submit" class="btn btn-primary">Create Event 🎉</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Block Date Modal -->
  <div class="modal-overlay" id="blockDateModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Block Date 🚫</h3>
        <button class="modal-close" onclick="closeBlockDateModal()">×</button>
      </div>
      
      <form id="blockDateForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Start Date 📅</label>
            <input type="date" class="form-input" id="blockStartDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">End Date 📅</label>
            <input type="date" class="form-input" id="blockEndDate" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Block Type 🚫</label>
          <select class="form-select" id="blockType" onchange="toggleTimeInputs()" required>
            <option value="full-day">Full Day Block</option>
            <option value="time-range">Specific Time Range</option>
          </select>
        </div>
        
        <div class="form-grid" id="timeRangeInputs" style="display: none;">
          <div class="form-group">
            <label class="form-label">Start Time ⏰</label>
            <input type="time" class="form-input" id="blockStartTime" value="09:00">
          </div>
          <div class="form-group">
            <label class="form-label">End Time ⏰</label>
            <input type="time" class="form-input" id="blockEndTime" value="17:00">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Reason 📝</label>
          <input type="text" class="form-input" id="blockReason" placeholder="e.g., Personal time off, Equipment maintenance, Private event" required>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeBlockDateModal()">Cancel 🚫</button>
          <button type="submit" class="btn btn-primary">Block Time 🚫</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Client Record Modal -->
  <div class="modal-overlay" id="clientRecordModal">
    <div class="modal" style="max-width: 900px;">
      <div class="modal-header">
        <h3 class="modal-title">Client Record 👤</h3>
        <button class="modal-close" onclick="closeClientRecordModal()">×</button>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <!-- Client Information -->
        <div>
          <h4 style="color: var(--gold); margin-bottom: 1rem; font-size: 1.2rem;">📋 Client Information</h4>
          <div class="form-group">
            <label class="form-label">Primary Client Name 👤</label>
            <input type="text" class="form-input" id="clientRecordName1" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Email 📧</label>
            <input type="email" class="form-input" id="clientRecordEmail1" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Phone 📱</label>
            <input type="tel" class="form-input" id="clientRecordPhone1" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Instagram 📸</label>
            <input type="text" class="form-input" id="clientRecordInstagram1" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Zip Code 📍</label>
            <input type="text" class="form-input" id="clientRecordZip1" readonly>
          </div>
          
          <div id="secondClientInfo" style="margin-top: 1.5rem; display: none;">
            <h5 style="color: var(--gold); margin-bottom: 0.5rem;">Second Client</h5>
            <div class="form-group">
              <label class="form-label">Name 👤</label>
              <input type="text" class="form-input" id="clientRecordName2" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">Email 📧</label>
              <input type="email" class="form-input" id="clientRecordEmail2" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">Phone 📱</label>
              <input type="tel" class="form-input" id="clientRecordPhone2" readonly>
            </div>
          </div>
        </div>
        
        <!-- Pet Information -->
        <div>
          <h4 style="color: var(--gold); margin-bottom: 1rem; font-size: 1.2rem;">🐾 Pet Information</h4>
          <div class="form-group">
            <label class="form-label">Primary Pet Name 🐕</label>
            <input type="text" class="form-input" id="petName1" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Pet Breed 🎯</label>
            <input type="text" class="form-input" id="petBreed1" placeholder="Add breed information">
          </div>
          <div class="form-group">
            <label class="form-label">Pet Age 📅</label>
            <input type="text" class="form-input" id="petAge1" placeholder="Add age information">
          </div>
          <div class="form-group">
            <label class="form-label">Special Notes 📝</label>
            <textarea class="form-input" id="petNotes1" rows="3" placeholder="Behavioral notes, preferences, etc."></textarea>
          </div>
          
          <div id="secondPetInfo" style="margin-top: 1.5rem; display: none;">
            <h5 style="color: var(--gold); margin-bottom: 0.5rem;">Second Pet</h5>
            <div class="form-group">
              <label class="form-label">Pet Name 🐕</label>
              <input type="text" class="form-input" id="petName2" readonly>
            </div>
            <div class="form-group">
              <label class="form-label">Pet Breed 🎯</label>
              <input type="text" class="form-input" id="petBreed2" placeholder="Add breed information">
            </div>
            <div class="form-group">
              <label class="form-label">Pet Age 📅</label>
              <input type="text" class="form-input" id="petAge2" placeholder="Add age information">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Session History -->
      <div style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="color: var(--gold); font-size: 1.2rem;">📸 Session History</h4>
          <button class="btn btn-primary btn-small" onclick="addNewSessionForClient()">➕ Add Session</button>
        </div>
        <div id="sessionHistoryList" style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 1rem; max-height: 300px; overflow-y: auto;">
          <!-- Session history will be populated here -->
        </div>
      </div>
      
      <!-- Client Preferences & Notes -->
      <div style="margin-bottom: 2rem;">
        <h4 style="color: var(--gold); margin-bottom: 1rem; font-size: 1.2rem;">📋 Client Preferences & Notes</h4>
        <div class="form-group">
          <label class="form-label">Preferred Locations 📍</label>
          <input type="text" class="form-input" id="preferredLocations" placeholder="Cheesman Park, City Park, etc.">
        </div>
        <div class="form-group">
          <label class="form-label">Preferred Session Times ⏰</label>
          <input type="text" class="form-input" id="preferredTimes" placeholder="Morning, Evening, Weekends, etc.">
        </div>
        <div class="form-group">
          <label class="form-label">Special Requests & Notes 📝</label>
          <textarea class="form-input" id="clientNotes" rows="4" placeholder="Any special requests, accessibility needs, or important notes about the client or pets"></textarea>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="marketingConsentRecord">
          <label for="marketingConsentRecord">Marketing consent granted 📬</label>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeClientRecordModal()">Close 🚫</button>
        <button type="button" class="btn btn-primary" onclick="updateClientRecord()">Save Updates 💾</button>
      </div>
    </div>
  </div>

  <!-- Session Details Modal -->
  <div class="modal-overlay" id="sessionDetailsModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Session Details 📸</h3>
        <button class="modal-close" onclick="closeSessionDetailsModal()">×</button>
      </div>
      
      <form id="sessionDetailsForm">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Booking ID 🔍</label>
            <input type="text" class="form-input" id="sessionBookingId" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Session Date 📅</label>
            <input type="date" class="form-input" id="sessionDate" required>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Session Time ⏰</label>
            <input type="time" class="form-input" id="sessionTime" required>
          </div>
          <div class="form-group">
            <label class="form-label">Session Type 📸</label>
            <select class="form-select" id="sessionType" required>
              <option value="Mini Session">Mini Session</option>
              <option value="Full Session">Full Session</option>
              <option value="Pop-Up">Pop-Up Session</option>
            </select>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Client 1 Name 👤</label>
            <input type="text" class="form-input" id="client1Name" placeholder="Enter client name" required>
          </div>
          <div class="form-group">
            <label class="form-label">Client 1 Email 📧</label>
            <input type="email" class="form-input" id="client1Email" placeholder="client@email.com">
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Client 1 Phone 📱</label>
            <input type="tel" class="form-input" id="client1Phone" placeholder="(303) 555-0123">
          </div>
          <div class="form-group">
            <label class="form-label">Client 1 Instagram 📸</label>
            <input type="text" class="form-input" id="client1Instagram" placeholder="@username">
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Pet Count 🐾</label>
            <select class="form-select" id="sessionPetCount" required>
              <option value="1">1 Pet</option>
              <option value="2">2 Pets</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">People Count 👥</label>
            <select class="form-select" id="sessionPeopleCount" required>
              <option value="1">1 Person</option>
              <option value="2">2 People</option>
            </select>
          </div>
        </div>
        
        <div id="client2Fields" style="display: none;">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Client 2 Name 👤</label>
              <input type="text" class="form-input" id="client2Name" placeholder="Enter second client name">
            </div>
            <div class="form-group">
              <label class="form-label">Client 2 Email 📧</label>
              <input type="email" class="form-input" id="client2Email" placeholder="client2@email.com">
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Client 2 Phone 📱</label>
              <input type="tel" class="form-input" id="client2Phone" placeholder="(303) 555-0123">
            </div>
            <div class="form-group">
              <label class="form-label">Client 2 Instagram 📸</label>
              <input type="text" class="form-input" id="client2Instagram" placeholder="@username">
            </div>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Client 1 First Pet Name 🐾</label>
            <input type="text" class="form-input" id="client1FirstPetName" placeholder="Pet name">
          </div>
          <div class="form-group" id="client2PetField" style="display: none;">
            <label class="form-label">Client 2 First Pet Name 🐾</label>
            <input type="text" class="form-input" id="client2FirstPetName" placeholder="Pet name">
          </div>
        </div>
        
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="marketingConsent">
            <label for="marketingConsent">Marketing consent granted 📬</label>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="deleteSession()" id="deleteSessionBtn" style="display: none;">🗑️ Delete</button>
          <button type="button" class="btn btn-secondary" onclick="closeSessionDetailsModal()">Cancel 🚫</button>
          <button type="submit" class="btn btn-primary">Save Session 💾</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Global variables
    let calendarData = [];
    let bookingsData = [];
    let sessionTypes = [];
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let currentSessionPopup = null;
    let currentClientRecord = null;

    // Authentication and initialization
    function checkAuthentication() {
      const isAuthenticated = localStorage.getItem('adminAuthenticated');
      if (!isAuthenticated) {
        console.log('Not authenticated, redirecting to login...');
        window.location.href = '/admin-login.html';
        return;
      }
      const adminUser = localStorage.getItem('adminUser') || 'Admin';
      document.getElementById('adminUser').textContent = `Welcome, ${adminUser} 👋`;
      console.log('Authenticated as:', adminUser);
    }

    function logout() {
      console.log('Logging out...');
      localStorage.removeItem('adminAuthenticated');
      localStorage.removeItem('adminUser');
      localStorage.removeItem('adminLoginTime');
      window.location.href = '/admin-login.html';
    }

    function toggleSidebar() {
      console.log('Toggling sidebar...');
      const sidebar = document.getElementById('adminSidebar');
      sidebar.classList.toggle('open');
    }

    // Error logging
    async function logErrorToAirtable(page, error, data = {}) {
      try {
        const errorId = `ERR_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const errorRecord = {
          fields: {
            errorId: errorId,
            timestamp: new Date().toISOString(),
            page: page,
            errorMessage: error.message || String(error),
            errorStack: error.stack || 'No stack trace available',
            userAgent: navigator.userAgent,
            sessionData: JSON.stringify(data)
          }
        };

        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Errors', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(errorRecord)
        });

        if (response.ok) {
          console.log('✅ Error logged to Airtable:', errorRecord);
        } else {
          console.warn('⚠️ Failed to log error to Airtable:', response.status);
        }
      } catch (innerError) {
        console.warn('⚠️ Failed to log error to Airtable:', innerError);
      }
    }

    // Data fetching functions
    async function fetchCalendarData() {
      try {
        console.log('Fetching calendar data from Airtable...');
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });

        if (!response.ok) {
          throw new Error(`Airtable error: ${response.status}`);
        }

        const data = await response.json();
        calendarData = data.records.map(record => ({
          id: record.id,
          date: record.fields.date,
          time: record.fields.time,
          endTime: record.fields.endTime,
          status: record.fields.status,
          bookingId: record.fields.bookingId,
          sessionType: record.fields.sessionType,
          cushionTime: record.fields.cushionTime || 0,
          isBlocked: record.fields.isBlocked || false,
          slotType: record.fields.SlotType || 'Regular',
          location: record.fields.Location || ''
        }));

        console.log('Calendar data fetched:', calendarData);
        updateCalendarStats();
        renderCalendar();
      } catch (error) {
        console.error('Error fetching calendar data:', error);
        await logErrorToAirtable('calendar-management.html', error);
      }
    }

    async function fetchBookingsData() {
      try {
        console.log('Fetching bookings data from Airtable...');
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings', {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });

        if (!response.ok) {
          throw new Error(`Airtable error: ${response.status}`);
        }

        const data = await response.json();
        bookingsData = data.records.map(record => ({
          id: record.id,
          bookingId: record.fields.bookingId,
          client1Name: record.fields.client1Name,
          client2Name: record.fields.client2Name,
          client1Email: record.fields.client1Email,
          client2Email: record.fields.client2Email,
          client1Phone: record.fields.client1Phone,
          client2Phone: record.fields.client2Phone,
          client1Instagram: record.fields.client1Instagram,
          client2Instagram: record.fields.client2Instagram,
          client1Zip: record.fields.client1Zip,
          client2Zip: record.fields.client2Zip,
          client1FirstPetName: record.fields.client1FirstPetName,
          client2FirstPetName: record.fields.client2FirstPetName,
          marketingConsent: record.fields.marketingConsent,
          petCount: record.fields.petCount,
          peopleCount: record.fields.peopleCount,
          sessionDate: record.fields.sessionDate,
          calendarSlot: record.fields.calendarSlot ? record.fields.calendarSlot[0] : null
        }));

        console.log('Bookings data fetched:', bookingsData);
        updateCalendarStats();
      } catch (error) {
        console.error('Error fetching bookings data:', error);
        await logErrorToAirtable('calendar-management.html', error);
      }
    }

    async function fetchSessionTypes() {
      try {
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/SessionTypes', {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });
        const data = await response.json();
        sessionTypes = data.records.map(record => ({
          id: record.id,
          typeName: record.fields.typeName,
          duration: record.fields.duration,
          price: record.fields.price || 0
        }));
      } catch (error) {
        console.error('Error fetching session types:', error);
        await logErrorToAirtable('calendar-management.html', error);
      }
    }

    // Calendar rendering functions
    function renderCalendar() {
      const calendarGrid = document.getElementById('calendarGrid');
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
      
      document.getElementById('calendarMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
      
      // Clear grid
      calendarGrid.innerHTML = '';
      
      // Add day headers
      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day';
        header.style.fontWeight = 'bold';
        header.style.background = 'rgba(255, 255, 255, 0.1)';
        header.textContent = day;
        calendarGrid.appendChild(header);
      });
      
      // Get first day of month and number of days
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const today = new Date();
      
      // Add empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day other-month';
        calendarGrid.appendChild(emptyDay);
      }
      
      // Add days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        const currentDate = new Date(currentYear, currentMonth, day);
        const dateString = currentDate.toISOString().split('T')[0];
        
        // Check if it's today
        if (currentDate.toDateString() === today.toDateString()) {
          dayElement.classList.add('today');
        }
        
        // Get events for this day
        const dayEvents = calendarData.filter(slot => slot.date === dateString);
        
        // Classify day based on events
        if (dayEvents.some(event => event.isBlocked)) {
          dayElement.classList.add('blocked');
        } else if (dayEvents.some(event => event.slotType === 'Pop-Up')) {
          dayElement.classList.add('has-popups');
        } else if (dayEvents.some(event => event.status === 'booked')) {
          dayElement.classList.add('has-bookings');
        } else if (dayEvents.length > 0) {
          dayElement.classList.add('has-events');
        }
        
        // Add day number
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;
        dayElement.appendChild(dayNumber);
        
        // Add event indicators
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'day-events';
        
        dayEvents.slice(0, 3).forEach(event => {
          const eventDot = document.createElement('div');
          eventDot.className = 'event-dot';
          
          if (event.isBlocked) {
            eventDot.classList.add('blocked');
          } else if (event.slotType === 'Pop-Up') {
            eventDot.classList.add('popup');
          } else if (event.status === 'booked') {
            eventDot.classList.add('booked');
          }
          
          eventsContainer.appendChild(eventDot);
        });
        
        dayElement.appendChild(eventsContainer);
        
        // Add click handler
        dayElement.onclick = () => handleDayClick(dateString, dayEvents);
        
        // Add hover handlers for booked sessions - DEBUG
        const hasBookedEvents = dayEvents.some(event => event.status === 'booked' || event.slotType === 'Pop-Up');
        if (hasBookedEvents) {
          console.log('Adding hover handlers for:', dateString, dayEvents);
          dayElement.style.cursor = 'pointer';
          dayElement.addEventListener('mouseenter', (e) => {
            console.log('Mouse entered day with events:', dateString);
            showSessionPopup(e, dateString, dayEvents);
          });
          dayElement.addEventListener('mouseleave', () => {
            console.log('Mouse left day');
            hideSessionPopup();
          });
        }
        
        calendarGrid.appendChild(dayElement);
      }
    }

    function handleDayClick(dateString, dayEvents) {
      if (dayEvents.length === 0) {
        // No events, offer to add availability or create session
        if (confirm(`No events on ${dateString}. Would you like to add availability?`)) {
          openBulkAvailabilityModal();
          document.getElementById('bulkStartDate').value = dateString;
          document.getElementById('bulkEndDate').value = dateString;
        }
      } else if (dayEvents.length === 1 && dayEvents[0].status === 'booked') {
        // Single booked session, open details
        const booking = bookingsData.find(b => b.calendarSlot === dayEvents[0].id);
        if (booking) {
          openSessionDetailsModal(booking, dayEvents[0]);
        }
      } else {
        // Multiple events, show list
        showDayEventsPopup(dateString, dayEvents);
      }
    }

    function showDayEventsPopup(dateString, dayEvents) {
      const eventsList = dayEvents.map(event => {
        const booking = bookingsData.find(b => b.calendarSlot === event.id);
        const time = event.time || '00:00';
        let status = event.isBlocked ? 'Blocked' : event.status || 'available';
        let clientInfo = booking ? ` - ${booking.client1Name}` : '';
        return `${time} ${event.sessionType} (${status})${clientInfo}`;
      }).join('\n');
      
      alert(`Events on ${dateString}:\n\n${eventsList}`);
    }

    // Navigation functions
    function changeMonth(direction) {
      currentMonth += direction;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      renderCalendar();
    }

    function goToToday() {
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      renderCalendar();
    }

    // Stats update function
    function updateCalendarStats() {
      const today = new Date();
      const weekStart = new Date(today);
      weekStart.setDate(today.getDate() - today.getDay());
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      
      const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
      const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      
      // Available slots this week
      const availableThisWeek = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= weekStart && slotDate <= weekEnd && 
               slot.status === 'available' && !slot.isBlocked;
      }).length;
      document.getElementById('available-slots').textContent = availableThisWeek;
      
      // Booked sessions this week
      const bookedThisWeek = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= weekStart && slotDate <= weekEnd && slot.status === 'booked';
      }).length;
      document.getElementById('booked-sessions').textContent = bookedThisWeek;
      
      // Pop-up events this week
      const popupsThisWeek = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= weekStart && slotDate <= weekEnd && slot.slotType === 'Pop-Up';
      }).length;
      document.getElementById('popup-events').textContent = popupsThisWeek;
      
      // Blocked days this month
      const blockedThisMonth = calendarData.filter(slot => {
        const slotDate = new Date(slot.date);
        return slotDate >= monthStart && slotDate <= monthEnd && slot.isBlocked;
      }).length;
      document.getElementById('blocked-days').textContent = blockedThisMonth;
      
      // Update badge
      document.getElementById('calendarBadge').textContent = calendarData.length;
    }

    // Modal functions
    function openBulkAvailabilityModal() {
      document.getElementById('bulkAvailabilityModal').style.display = 'flex';
    }

    function closeBulkAvailabilityModal() {
      document.getElementById('bulkAvailabilityModal').style.display = 'none';
      document.getElementById('bulkAvailabilityForm').reset();
    }

    function openPopupEventModal() {
      document.getElementById('popupEventModal').style.display = 'flex';
    }

    function closePopupEventModal() {
      document.getElementById('popupEventModal').style.display = 'none';
      document.getElementById('popupEventForm').reset();
    }

    function openBlockDateModal() {
      document.getElementById('blockDateModal').style.display = 'flex';
    }

    function closeBlockDateModal() {
      document.getElementById('blockDateModal').style.display = 'none';
      document.getElementById('blockDateForm').reset();
      document.getElementById('timeRangeInputs').style.display = 'none';
    }

    function toggleTimeInputs() {
      const blockType = document.getElementById('blockType').value;
      const timeInputs = document.getElementById('timeRangeInputs');
      timeInputs.style.display = blockType === 'time-range' ? 'grid' : 'none';
    }

    function openSessionDetailsModal(booking = null, calendarSlot = null) {
      const modal = document.getElementById('sessionDetailsModal');
      const form = document.getElementById('sessionDetailsForm');
      const deleteBtn = document.getElementById('deleteSessionBtn');
      
      if (booking && calendarSlot) {
        // Editing existing session
        document.getElementById('sessionBookingId').value = booking.bookingId || '';
        document.getElementById('sessionDate').value = calendarSlot.date || '';
        document.getElementById('sessionTime').value = calendarSlot.time || '';
        document.getElementById('sessionType').value = calendarSlot.sessionType || '';
        document.getElementById('client1Name').value = booking.client1Name || '';
        document.getElementById('client1Email').value = booking.client1Email || '';
        document.getElementById('client1Phone').value = booking.client1Phone || '';
        document.getElementById('client1Instagram').value = booking.client1Instagram || '';
        document.getElementById('client2Name').value = booking.client2Name || '';
        document.getElementById('client2Email').value = booking.client2Email || '';
        document.getElementById('client2Phone').value = booking.client2Phone || '';
        document.getElementById('client2Instagram').value = booking.client2Instagram || '';
        document.getElementById('sessionPetCount').value = booking.petCount || 1;
        document.getElementById('sessionPeopleCount').value = booking.peopleCount || 1;
        document.getElementById('client1FirstPetName').value = booking.client1FirstPetName || '';
        document.getElementById('client2FirstPetName').value = booking.client2FirstPetName || '';
        document.getElementById('marketingConsent').checked = booking.marketingConsent || false;
        
        deleteBtn.style.display = 'block';
        deleteBtn.onclick = () => deleteSession(booking.id, calendarSlot.id);
      } else {
        // Creating new session
        const newBookingId = `SESS_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        document.getElementById('sessionBookingId').value = newBookingId;
        deleteBtn.style.display = 'none';
      }
      
      // Show/hide client 2 fields based on people count
      updateClient2Fields();
      
      modal.style.display = 'flex';
    }

    function closeSessionDetailsModal() {
      document.getElementById('sessionDetailsModal').style.display = 'none';
      document.getElementById('sessionDetailsForm').reset();
    }

    function updateClient2Fields() {
      const peopleCount = document.getElementById('sessionPeopleCount').value;
      const petCount = document.getElementById('sessionPetCount').value;
      const client2Fields = document.getElementById('client2Fields');
      const client2PetField = document.getElementById('client2PetField');
      
      client2Fields.style.display = peopleCount === '2' ? 'block' : 'none';
      client2PetField.style.display = petCount === '2' ? 'block' : 'none';
    }

    // Session popup functions
    function showSessionPopup(event, dateString, dayEvents) {
      console.log('showSessionPopup called with:', dateString, dayEvents);
      
      const popup = document.getElementById('sessionPopup');
      if (!popup) {
        console.error('Session popup element not found!');
        return;
      }
      
      const bookedEvents = dayEvents.filter(event => event.status === 'booked' || event.slotType === 'Pop-Up');
      console.log('Booked events found:', bookedEvents);
      
      if (bookedEvents.length === 0) {
        console.log('No booked events found');
        return;
      }
      
      currentSessionPopup = { events: bookedEvents, dateString: dateString };
      
      // If multiple sessions, show list format
      if (bookedEvents.length > 1) {
        document.getElementById('popupTitle').textContent = `${bookedEvents.length} Sessions`;
        document.getElementById('popupStatus').textContent = 'Multiple';
        document.getElementById('popupStatus').className = 'session-popup-status booked';
        
        let detailsHTML = '';
        bookedEvents.forEach((event, index) => {
          const booking = bookingsData.find(b => b.calendarSlot === event.id);
          const clientName = booking ? booking.client1Name : 'Unknown Client';
          
          detailsHTML += `
            <div class="session-popup-detail" style="cursor: pointer; padding: 0.5rem; margin: 0.2rem 0; background: rgba(255,255,255,0.1); border-radius: 4px;" onclick="openSingleSession(${index})">
              <div style="font-weight: 600; color: var(--gold);">${event.time} - ${clientName}</div>
              <div style="font-size: 0.8rem; color: rgba(255,255,255,0.8);">${event.sessionType} • ${event.location}</div>
            </div>
          `;
        });
        
        document.getElementById('popupDetails').innerHTML = detailsHTML;
      } else {
        // Single session format
        const mainEvent = bookedEvents[0];
        const booking = bookingsData.find(b => b.calendarSlot === mainEvent.id);
        
        if (!booking) {
          console.log('No booking found for event');
          return;
        }
        
        document.getElementById('popupTitle').textContent = booking.client1Name || 'Session';
        
        const statusElement = document.getElementById('popupStatus');
        statusElement.textContent = mainEvent.slotType === 'Pop-Up' ? 'Pop-Up' : 'Booked';
        statusElement.className = `session-popup-status ${mainEvent.slotType === 'Pop-Up' ? 'popup' : 'booked'}`;
        
        document.getElementById('popupDetails').innerHTML = `
          <div class="session-popup-detail">
            <span class="session-popup-icon">📅</span>
            <span>${dateString} at ${mainEvent.time}</span>
          </div>
          <div class="session-popup-detail">
            <span class="session-popup-icon">📸</span>
            <span>${mainEvent.sessionType}</span>
          </div>
          <div class="session-popup-detail">
            <span class="session-popup-icon">📍</span>
            <span>${mainEvent.location || 'Location TBD'}</span>
          </div>
          <div class="session-popup-detail">
            <span class="session-popup-icon">🐾</span>
            <span>${booking.petCount} pet${booking.petCount > 1 ? 's' : ''}, ${booking.peopleCount} person${booking.peopleCount > 1 ? 's' : ''}</span>
          </div>
          ${booking.client1FirstPetName ? `
          <div class="session-popup-detail">
            <span class="session-popup-icon">🐕</span>
            <span>${booking.client1FirstPetName}${booking.client2FirstPetName ? `, ${booking.client2FirstPetName}` : ''}</span>
          </div>
          ` : ''}
        `;
      }
      
      // Position popup near the mouse
      popup.style.position = 'fixed';
      popup.style.left = `${event.clientX + 10}px`;
      popup.style.top = `${event.clientY + 10}px`;
      
      console.log('Showing popup at:', event.clientX, event.clientY);
      popup.classList.add('show');
      
      // Adjust if popup goes off screen
      setTimeout(() => {
        const popupRect = popup.getBoundingClientRect();
        if (popupRect.right > window.innerWidth) {
          popup.style.left = `${window.innerWidth - popupRect.width - 10}px`;
        }
        if (popupRect.bottom > window.innerHeight) {
          popup.style.top = `${event.clientY - popupRect.height - 10}px`;
        }
      }, 10);
    }

    function openSingleSession(index) {
      if (currentSessionPopup && currentSessionPopup.events[index]) {
        const event = currentSessionPopup.events[index];
        const booking = bookingsData.find(b => b.calendarSlot === event.id);
        if (booking) {
          showClientRecordModal(booking);
          hideSessionPopup();
        }
      }
    }

    function hideSessionPopup() {
      console.log('hideSessionPopup called');
      const popup = document.getElementById('sessionPopup');
      if (popup) {
        popup.classList.remove('show');
      }
      currentSessionPopup = null;
    }

    function editSessionQuick() {
      if (currentSessionPopup) {
        if (currentSessionPopup.events && currentSessionPopup.events.length === 1) {
          const event = currentSessionPopup.events[0];
          const booking = bookingsData.find(b => b.calendarSlot === event.id);
          if (booking) {
            openSessionDetailsModal(booking, event);
            hideSessionPopup();
          }
        } else {
          alert('Please select a specific session to edit from the list above.');
        }
      }
    }

    function openClientRecord() {
      if (currentSessionPopup) {
        if (currentSessionPopup.events && currentSessionPopup.events.length === 1) {
          const event = currentSessionPopup.events[0];
          const booking = bookingsData.find(b => b.calendarSlot === event.id);
          if (booking) {
            showClientRecordModal(booking);
            hideSessionPopup();
          }
        } else {
          alert('Please select a specific session from the list above to view client record.');
        }
      }
    }

    // Client record functions
    function showClientRecordModal(booking) {
      currentClientRecord = booking;
      const modal = document.getElementById('clientRecordModal');
      
      // Populate client information
      document.getElementById('clientRecordName1').value = booking.client1Name || '';
      document.getElementById('clientRecordEmail1').value = booking.client1Email || '';
      document.getElementById('clientRecordPhone1').value = booking.client1Phone || '';
      document.getElementById('clientRecordInstagram1').value = booking.client1Instagram || '';
      document.getElementById('clientRecordZip1').value = booking.client1Zip || '';
      
      // Second client info
      const secondClientDiv = document.getElementById('secondClientInfo');
      if (booking.client2Name) {
        document.getElementById('clientRecordName2').value = booking.client2Name || '';
        document.getElementById('clientRecordEmail2').value = booking.client2Email || '';
        document.getElementById('clientRecordPhone2').value = booking.client2Phone || '';
        secondClientDiv.style.display = 'block';
      } else {
        secondClientDiv.style.display = 'none';
      }
      
      // Pet information
      document.getElementById('petName1').value = booking.client1FirstPetName || '';
      
      const secondPetDiv = document.getElementById('secondPetInfo');
      if (booking.client2FirstPetName) {
        document.getElementById('petName2').value = booking.client2FirstPetName || '';
        secondPetDiv.style.display = 'block';
      } else {
        secondPetDiv.style.display = 'none';
      }
      
      // Marketing consent
      document.getElementById('marketingConsentRecord').checked = booking.marketingConsent || false;
      
      // Load session history
      loadSessionHistory(booking.client1Email);
      
      modal.style.display = 'flex';
    }

    function closeClientRecordModal() {
      document.getElementById('clientRecordModal').style.display = 'none';
      currentClientRecord = null;
    }

    async function loadSessionHistory(clientEmail) {
      const historyContainer = document.getElementById('sessionHistoryList');
      
      // Find all bookings for this client
      const clientBookings = bookingsData.filter(booking => 
        booking.client1Email === clientEmail || booking.client2Email === clientEmail
      );
      
      if (clientBookings.length === 0) {
        historyContainer.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center;">No session history found</p>';
        return;
      }
      
      // Sort by date (newest first)
      clientBookings.sort((a, b) => new Date(b.sessionDate) - new Date(a.sessionDate));
      
      let historyHTML = '';
      clientBookings.forEach(booking => {
        const calendarSlot = calendarData.find(slot => slot.id === booking.calendarSlot);
        const sessionDate = new Date(booking.sessionDate).toLocaleDateString();
        const sessionStatus = calendarSlot ? calendarSlot.status : 'unknown';
        
        let statusColor = '';
        let statusText = '';
        switch(sessionStatus) {
          case 'booked':
            statusColor = 'var(--booked-red)';
            statusText = 'Upcoming';
            break;
          case 'completed':
            statusColor = 'var(--available-green)';
            statusText = 'Completed';
            break;
          default:
            statusColor = 'var(--soft-hold-yellow)';
            statusText = 'Pending';
        }
        
        historyHTML += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 3px solid ${statusColor};">
            <div>
              <div style="font-weight: 600; color: white;">${sessionDate} - ${calendarSlot?.sessionType || 'Session'}</div>
              <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">${calendarSlot?.location || 'Location TBD'} • ${booking.petCount} pet(s), ${booking.peopleCount} person(s)</div>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="color: ${statusColor}; font-size: 0.8rem; font-weight: 600;">${statusText}</span>
              <button class="popup-btn popup-btn-secondary" onclick="editSessionFromHistory('${booking.id}')">📝</button>
            </div>
          </div>
        `;
      });
      
      historyContainer.innerHTML = historyHTML;
    }

    function editSessionFromHistory(bookingId) {
      const booking = bookingsData.find(b => b.id === bookingId);
      const calendarSlot = calendarData.find(slot => slot.id === booking.calendarSlot);
      
      if (booking && calendarSlot) {
        openSessionDetailsModal(booking, calendarSlot);
      }
    }

    function addNewSessionForClient() {
      if (currentClientRecord) {
        // Pre-populate the session form with current client data
        openSessionDetailsModal();
        
        // Fill in client information
        document.getElementById('client1Name').value = currentClientRecord.client1Name || '';
        document.getElementById('client1Email').value = currentClientRecord.client1Email || '';
        document.getElementById('client1Phone').value = currentClientRecord.client1Phone || '';
        document.getElementById('client1Instagram').value = currentClientRecord.client1Instagram || '';
        document.getElementById('client2Name').value = currentClientRecord.client2Name || '';
        document.getElementById('client2Email').value = currentClientRecord.client2Email || '';
        document.getElementById('client2Phone').value = currentClientRecord.client2Phone || '';
        document.getElementById('client2Instagram').value = currentClientRecord.client2Instagram || '';
        document.getElementById('sessionPetCount').value = currentClientRecord.petCount || 1;
        document.getElementById('sessionPeopleCount').value = currentClientRecord.peopleCount || 1;
        document.getElementById('client1FirstPetName').value = currentClientRecord.client1FirstPetName || '';
        document.getElementById('client2FirstPetName').value = currentClientRecord.client2FirstPetName || '';
        document.getElementById('marketingConsent').checked = currentClientRecord.marketingConsent || false;
        
        updateClient2Fields();
      }
    }

    async function updateClientRecord() {
      if (!currentClientRecord) return;
      
      try {
        // Get updated values
        const updatedData = {
          fields: {
            // Client information updates (read-only fields won't be updated)
            
            // Extended client data - these would need new fields in Airtable
            preferredLocations: document.getElementById('preferredLocations').value,
            preferredTimes: document.getElementById('preferredTimes').value,
            clientNotes: document.getElementById('clientNotes').value,
            petBreed1: document.getElementById('petBreed1').value,
            petAge1: document.getElementById('petAge1').value,
            petNotes1: document.getElementById('petNotes1').value,
            petBreed2: document.getElementById('petBreed2').value,
            petAge2: document.getElementById('petAge2').value,
            marketingConsent: document.getElementById('marketingConsentRecord').checked
          }
        };
        
        // Update the booking record with extended data
        // Note: You may want to create a separate "Clients" table for extended client data
        const response = await fetch(`https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings/${currentClientRecord.id}`, {
          method: 'PATCH',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedData)
        });
        
        if (!response.ok) {
          throw new Error(`Airtable error: ${response.status}`);
        }
        
        console.log('✅ Client record updated successfully');
        alert('✅ Client record updated successfully!');
        
        // Refresh data
        await fetchBookingsData();
        
      } catch (error) {
        console.error('Error updating client record:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error updating client record. Please try again.');
      }
    }

    // Form submission handlers
    document.getElementById('bulkAvailabilityForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const startDate = new Date(document.getElementById('bulkStartDate').value);
      const endDate = new Date(document.getElementById('bulkEndDate').value);
      const selectedDays = [];
      
      // Get selected days of week
      ['daySun', 'dayMon', 'dayTue', 'dayWed', 'dayThu', 'dayFri', 'daySat'].forEach((dayId, index) => {
        if (document.getElementById(dayId).checked) {
          selectedDays.push(index);
        }
      });
      
      // If no days selected, include all days in the date range
      const daysToUse = selectedDays.length > 0 ? selectedDays : [0, 1, 2, 3, 4, 5, 6];
      
      const startTime = document.getElementById('bulkStartTime').value;
      const endTime = document.getElementById('bulkEndTime').value;
      const availabilityType = document.getElementById('bulkAvailabilityType').value;
      const location = document.getElementById('bulkLocation').value;
      const slotDuration = parseInt(document.getElementById('slotDuration').value);
      
      try {
        const slotsToCreate = [];
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          if (daysToUse.includes(d.getDay())) {
            const dateString = d.toISOString().split('T')[0];
            
            // Create time slots for this day
            const start = new Date(`${dateString}T${startTime}:00`);
            const end = new Date(`${dateString}T${endTime}:00`);
            
            for (let time = new Date(start); time < end; time.setMinutes(time.getMinutes() + slotDuration)) {
              const timeString = time.toTimeString().slice(0, 5);
              const endTimeObj = new Date(time);
              endTimeObj.setMinutes(endTimeObj.getMinutes() + slotDuration);
              const endTimeString = endTimeObj.toTimeString().slice(0, 5);
              
              // Determine session type based on availability type
              let sessionType = 'Available Slot';
              let slotType = 'Regular';
              
              switch(availabilityType) {
                case 'mini-only':
                  sessionType = 'Mini Session Available';
                  break;
                case 'full-only':
                  sessionType = 'Full Session Available';
                  break;
                case 'popup-only':
                  sessionType = 'Pop-Up Available';
                  slotType = 'Pop-Up';
                  break;
                default:
                  sessionType = 'Open Availability';
              }
              
              slotsToCreate.push({
                fields: {
                  SlotType: slotType,
                  Location: location,
                  date: dateString,
                  time: timeString,
                  endTime: endTimeString,
                  status: 'available',
                  sessionType: sessionType,
                  availabilityType: availabilityType,
                  slotDuration: slotDuration,
                  cushionTime: 0,
                  isBlocked: false
                }
              });
            }
          }
        }
        
        // Create slots in batches of 10
        let totalCreated = 0;
        for (let i = 0; i < slotsToCreate.length; i += 10) {
          const batch = slotsToCreate.slice(i, i + 10);
          const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ records: batch })
          });
          
          if (!response.ok) {
            throw new Error(`Airtable error: ${response.status}`);
          }
          
          totalCreated += batch.length;
          console.log(`✅ Created batch ${Math.ceil((i + 1) / 10)} - ${totalCreated} slots total`);
        }
        
        console.log(`✅ Created ${totalCreated} availability slots`);
        alert(`✅ Successfully created ${totalCreated} availability slots!\n\nThese slots are now available for booking across all calendars on your site.`);
        closeBulkAvailabilityModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error creating bulk availability:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error creating availability slots. Please try again.');
      }
    };

    document.getElementById('popupEventForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const date = document.getElementById('popupDate').value;
      const startTime = document.getElementById('popupStartTime').value;
      const location = document.getElementById('popupLocation').value;
      const numSlots = parseInt(document.getElementById('popupSlots').value);
      const description = document.getElementById('popupDescription').value;
      
      try {
        const slotsToCreate = [];
        
        for (let i = 0; i < numSlots; i++) {
          const slotTime = new Date(`${date}T${startTime}:00`);
          slotTime.setMinutes(slotTime.getMinutes() + (i * 20)); // 10 min session + 10 min prep
          
          const timeString = slotTime.toTimeString().slice(0, 5);
          const endTime = new Date(slotTime);
          endTime.setMinutes(endTime.getMinutes() + 10);
          const endTimeString = endTime.toTimeString().slice(0, 5);
          
          slotsToCreate.push({
            fields: {
              SlotType: 'Pop-Up',
              Location: location,
              date: date,
              time: timeString,
              endTime: endTimeString,
              status: 'available',
              sessionType: 'Pop-Up',
              cushionTime: 10,
              isBlocked: false
            }
          });
        }
        
        // Create pop-up slots
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ records: slotsToCreate })
        });
        
        if (!response.ok) {
          throw new Error(`Airtable error: ${response.status}`);
        }
        
        console.log(`✅ Created pop-up event with ${numSlots} slots`);
        alert(`🎉 Successfully created pop-up event "${description}" with ${numSlots} slots!`);
        closePopupEventModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error creating pop-up event:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error creating pop-up event. Please try again.');
      }
    };

    document.getElementById('blockDateForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const startDate = new Date(document.getElementById('blockStartDate').value);
      const endDate = new Date(document.getElementById('blockEndDate').value);
      const reason = document.getElementById('blockReason').value;
      const blockType = document.getElementById('blockType').value;
      
      try {
        const slotsToCreate = [];
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          const dateString = d.toISOString().split('T')[0];
          
          if (blockType === 'full-day') {
            // Block entire day
            slotsToCreate.push({
              fields: {
                SlotType: 'Blocked',
                Location: reason,
                date: dateString,
                time: '00:00',
                endTime: '23:59',
                status: 'blocked',
                sessionType: 'Blocked',
                cushionTime: 0,
                isBlocked: true,
                blockReason: reason
              }
            });
          } else {
            // Block specific time range
            const startTime = document.getElementById('blockStartTime').value;
            const endTime = document.getElementById('blockEndTime').value;
            
            // Create 15-minute blocked slots for the time range
            const start = new Date(`${dateString}T${startTime}:00`);
            const end = new Date(`${dateString}T${endTime}:00`);
            
            for (let time = new Date(start); time < end; time.setMinutes(time.getMinutes() + 15)) {
              const timeString = time.toTimeString().slice(0, 5);
              const endTimeObj = new Date(time);
              endTimeObj.setMinutes(endTimeObj.getMinutes() + 15);
              const endTimeString = endTimeObj.toTimeString().slice(0, 5);
              
              slotsToCreate.push({
                fields: {
                  SlotType: 'Blocked',
                  Location: reason,
                  date: dateString,
                  time: timeString,
                  endTime: endTimeString,
                  status: 'blocked',
                  sessionType: 'Blocked Time',
                  cushionTime: 0,
                  isBlocked: true,
                  blockReason: reason
                }
              });
            }
          }
        }
        
        // Create blocked slots in batches
        let totalCreated = 0;
        for (let i = 0; i < slotsToCreate.length; i += 10) {
          const batch = slotsToCreate.slice(i, i + 10);
          const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ records: batch })
          });
          
          if (!response.ok) {
            throw new Error(`Airtable error: ${response.status}`);
          }
          
          totalCreated += batch.length;
        }
        
        const blockTypeText = blockType === 'full-day' ? 'full day(s)' : 'time range(s)';
        console.log(`✅ Blocked ${totalCreated} slots`);
        alert(`🚫 Successfully blocked ${blockTypeText}: ${reason}\n\nCreated ${totalCreated} blocked slots.`);
        closeBlockDateModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error blocking dates:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error blocking dates. Please try again.');
      }
    };

    document.getElementById('sessionDetailsForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const bookingId = document.getElementById('sessionBookingId').value;
      const sessionDate = document.getElementById('sessionDate').value;
      const sessionTime = document.getElementById('sessionTime').value;
      const sessionType = document.getElementById('sessionType').value;
      
      try {
        // Create or update calendar slot
        const calendarData = {
          fields: {
            SlotType: sessionType === 'Pop-Up' ? 'Pop-Up' : 'Regular',
            Location: 'Cheesman Park', // Default location
            date: sessionDate,
            time: sessionTime,
            endTime: sessionTime, // Will be calculated based on session type
            status: 'booked',
            bookingId: bookingId,
            sessionType: sessionType,
            cushionTime: sessionType === 'Pop-Up' ? 10 : 0,
            isBlocked: false
          }
        };
        
        // Create booking record
        const bookingData = {
          fields: {
            bookingId: bookingId,
            client1Name: document.getElementById('client1Name').value,
            client1Email: document.getElementById('client1Email').value,
            client1Phone: document.getElementById('client1Phone').value,
            client1Instagram: document.getElementById('client1Instagram').value,
            client2Name: document.getElementById('client2Name').value || null,
            client2Email: document.getElementById('client2Email').value || null,
            client2Phone: document.getElementById('client2Phone').value || null,
            client2Instagram: document.getElementById('client2Instagram').value || null,
            client1FirstPetName: document.getElementById('client1FirstPetName').value,
            client2FirstPetName: document.getElementById('client2FirstPetName').value || null,
            petCount: parseInt(document.getElementById('sessionPetCount').value),
            peopleCount: parseInt(document.getElementById('sessionPeopleCount').value),
            marketingConsent: document.getElementById('marketingConsent').checked,
            sessionDate: `${sessionDate}T${sessionTime}:00`
          }
        };
        
        // Create calendar slot first
        const calendarResponse = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(calendarData)
        });
        
        if (!calendarResponse.ok) {
          throw new Error(`Calendar creation error: ${calendarResponse.status}`);
        }
        
        const calendarResult = await calendarResponse.json();
        
        // Link booking to calendar slot
        bookingData.fields.calendarSlot = [calendarResult.id];
        
        // Create booking
        const bookingResponse = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bookingData)
        });
        
        if (!bookingResponse.ok) {
          throw new Error(`Booking creation error: ${bookingResponse.status}`);
        }
        
        console.log('✅ Session created successfully');
        alert('✅ Session created successfully!');
        closeSessionDetailsModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error creating session:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error creating session. Please try again.');
      }
    };

    // Listen for people count changes
    document.getElementById('sessionPeopleCount').onchange = updateClient2Fields;
    document.getElementById('sessionPetCount').onchange = updateClient2Fields;

    // Delete session function
    async function deleteSession(bookingId, calendarId) {
      if (!confirm('Are you sure you want to delete this session? This cannot be undone.')) {
        return;
      }
      
      try {
        // Delete booking
        if (bookingId) {
          const bookingResponse = await fetch(`https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings/${bookingId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
            }
          });
          
          if (!bookingResponse.ok) {
            throw new Error(`Booking deletion error: ${bookingResponse.status}`);
          }
        }
        
        // Delete calendar slot
        if (calendarId) {
          const calendarResponse = await fetch(`https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar/${calendarId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
            }
          });
          
          if (!calendarResponse.ok) {
            throw new Error(`Calendar deletion error: ${calendarResponse.status}`);
          }
        }
        
        console.log('✅ Session deleted successfully');
        alert('✅ Session deleted successfully!');
        closeSessionDetailsModal();
        await syncCalendarData();
        
      } catch (error) {
        console.error('Error deleting session:', error);
        await logErrorToAirtable('calendar-management.html', error);
        alert('❌ Error deleting session. Please try again.');
      }
    }

    // Utility functions
    async function syncCalendarData() {
      console.log('Syncing calendar data...');
      await fetchCalendarData();
      await fetchBookingsData();
    }

    function exportCalendar() {
      // Export functionality - placeholder for now
      alert('📤 Calendar export functionality coming soon!');
    }

    // Test function to debug popup
    function testPopup() {
      console.log('Testing popup...');
      
      // Create fake event data for testing
      const fakeEvent = {
        id: 'test',
        date: '2025-05-24',
        time: '10:00',
        sessionType: 'Mini Session',
        location: 'Cheesman Park',
        status: 'booked',
        slotType: 'Regular'
      };
      
      const fakeBooking = {
        id: 'test-booking',
        client1Name: 'Test Client',
        client1Email: 'test@example.com',
        petCount: 1,
        peopleCount: 1,
        client1FirstPetName: 'Buddy'
      };
      
      // Add fake data temporarily
      currentSessionPopup = { events: [fakeEvent], dateString: '2025-05-24' };
      
      // Show popup at center of screen
      const popup = document.getElementById('sessionPopup');
      popup.style.position = 'fixed';
      popup.style.left = '50%';
      popup.style.top = '50%';
      popup.style.transform = 'translate(-50%, -50%)';
      
      // Populate popup
      document.getElementById('popupTitle').textContent = 'Test Client';
      document.getElementById('popupStatus').textContent = 'Booked';
      document.getElementById('popupStatus').className = 'session-popup-status booked';
      
      document.getElementById('popupDetails').innerHTML = `
        <div class="session-popup-detail">
          <span class="session-popup-icon">📅</span>
          <span>2025-05-24 at 10:00</span>
        </div>
        <div class="session-popup-detail">
          <span class="session-popup-icon">📸</span>
          <span>Mini Session</span>
        </div>
        <div class="session-popup-detail">
          <span class="session-popup-icon">📍</span>
          <span>Cheesman Park</span>
        </div>
        <div class="session-popup-detail">
          <span class="session-popup-icon">🐾</span>
          <span>1 pet, 1 person</span>
        </div>
        <div class="session-popup-detail">
          <span class="session-popup-icon">🐕</span>
          <span>Buddy</span>
        </div>
      `;
      
      popup.classList.add('show');
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        hideSessionPopup();
      }, 5000);
    }

    // Cross-site integration notes for future development:
    // 
    // CLIENT MATCHING LOGIC (to implement across all booking systems):
    // - Primary key: client1Name + client1Phone (NOT email, as emails change)
    // - When a new booking comes in, check if client1Name + client1Phone exists
    // - If match found, link to existing client record and session history
    // - If no match, create new client record
    // 
    // AVAILABILITY SYNC (ensure this data appears on homepage calendar):
    // - All "available" status slots created here should appear as bookable on index.html
    // - Pop-up events should appear in the "Upcoming Pop-Up Events" section
    // - Blocked slots should prevent booking on client-side calendars
    // 
    // BOOKING INTELLIGENCE:
    // - Before allowing a booking, check if enough consecutive time exists
    // - Mini Session (20 min) needs 20 min available slot
    // - Full Session (60 min) needs 60 min available slot  
    // - Don't allow booking if insufficient time remains in day
    async function checkAvailabilityForBooking(date, sessionType, requestedDuration) {
      // This function should be implemented to check if booking is possible
      // Returns true/false and suggested alternative times if false
      
      const daySlots = calendarData.filter(slot => 
        slot.date === date && 
        slot.status === 'available' && 
        !slot.isBlocked
      ).sort((a, b) => a.time.localeCompare(b.time));
      
      // Logic to check for consecutive available slots
      // This ensures intelligent booking that respects time constraints
      
      return { canBook: true, alternatives: [] };
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Calendar management page loaded...');
      checkAuthentication();
      await fetchSessionTypes();
      await fetchCalendarData();
      await fetchBookingsData();
      
      // Debug: Log data after loading
      setTimeout(() => {
        console.log('Calendar data loaded:', calendarData.length, 'records');
        console.log('Bookings data loaded:', bookingsData.length, 'records');
        console.log('Sample calendar data:', calendarData.slice(0, 3));
        console.log('Sample bookings data:', bookingsData.slice(0, 3));
      }, 2000);
      
      // Close popup when clicking outside
      document.addEventListener('click', function(event) {
        const popup = document.getElementById('sessionPopup');
        if (!popup.contains(event.target) && !event.target.closest('.calendar-day')) {
          hideSessionPopup();
        }
      });
    });
  </script>
</body>
</html>
