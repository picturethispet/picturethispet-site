<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Portal | Picture This Pet</title>
  <meta name="description" content="Manage your pet photography sessions and view your gallery.">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --orange: #F47C2C;
      --gold: #FDB75E;
      --dark-brown: #4B2E1E;
      --available-green: #10b981;
      --booked-red: #ef4444;
      --soft-hold-yellow: #f59e0b;
      --client-blue: #3b82f6;
      --client-purple: #8b5cf6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }

    html::-webkit-scrollbar {
      width: 8px;
    }

    html::-webkit-scrollbar-track {
      background: transparent;
    }

    html::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: white;
      background-image: url("assets/images/main_background_allsystem.png");
      background-size: 100% 100%;
      background-position: center;
      background-attachment: fixed;
      animation: moveBackground 30s ease-in-out infinite;
      min-height: 100vh;
    }

    @keyframes moveBackground {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* === HEADER === */
    .client-header {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .logo-small {
      height: 50px;
    }

    .header-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .client-welcome {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.8rem 1.5rem;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.7rem 1.2rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    /* === MAIN CONTENT === */
    .client-main {
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 4rem;
    }

    /* === CARDS === */
    .client-card {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      animation: moveBackground 30s ease-in-out infinite;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      padding: 2rem;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .card-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }

    .card-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* === BUTTONS === */
    .btn {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-height: 48px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--orange), var(--gold));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(244, 124, 44, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      min-height: 40px;
    }

    /* === STATS === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(244, 124, 44, 0.3);
    }

    .stat-card h4 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--gold);
    }

    .stat-card p {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    /* === BOOKING SLOTS === */
    .slots-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .slot-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .slot-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .slot-card.available {
      border-left: 4px solid var(--available-green);
    }

    .slot-card.booked {
      border-left: 4px solid var(--booked-red);
    }

    .slot-date {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }

    .slot-time {
      font-size: 1rem;
      color: white;
      margin-bottom: 0.5rem;
    }

    .slot-location {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 1rem;
    }

    .slot-status {
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      display: inline-block;
    }

    .slot-status.available {
      background: rgba(16, 185, 129, 0.2);
      color: var(--available-green);
      border: 1px solid var(--available-green);
    }

    .slot-status.booked {
      background: rgba(239, 68, 68, 0.2);
      color: var(--booked-red);
      border: 1px solid var(--booked-red);
    }

    /* === BOOKINGS LIST === */
    .bookings-list {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .booking-item {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .booking-item:last-child {
      border-bottom: none;
    }

    .booking-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .booking-info {
      flex: 1;
    }

    .booking-date {
      font-size: 1.1rem;
      font-weight: 600;
      color: white;
      margin-bottom: 0.3rem;
    }

    .booking-details {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .booking-status {
      font-size: 0.8rem;
      font-weight: 600;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
    }

    .booking-status.upcoming {
      background: rgba(59, 130, 246, 0.2);
      color: var(--client-blue);
      border: 1px solid var(--client-blue);
    }

    .booking-status.completed {
      background: rgba(16, 185, 129, 0.2);
      color: var(--available-green);
      border: 1px solid var(--available-green);
    }

    .booking-status.past {
      background: rgba(107, 114, 128, 0.2);
      color: #9ca3af;
      border: 1px solid #6b7280;
    }

    /* === FORMS === */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .form-input, .form-select {
      width: 100%;
      padding: 0.8rem;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      color: white;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(255, 255, 255, 0.15);
    }

    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    /* === MODALS === */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal {
      background-image: url('assets/images/ani_bkgd_cool.png');
      background-size: 100% 100%;
      background-position: center;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      padding: 2rem;
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    .modal-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.3s ease;
      min-height: 40px;
      min-width: 40px;
    }

    .modal-close:hover {
      color: white;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    /* === FILTERS === */
    .filter-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 0.6rem 1.2rem;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .filter-tab:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .filter-tab.active {
      background: linear-gradient(135deg, var(--orange), var(--gold));
      color: white;
      border-color: var(--gold);
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      .client-header {
        padding: 0.5rem 1rem;
        flex-wrap: wrap;
      }

      .header-title {
        font-size: 1.4rem;
      }

      .client-main {
        padding: 1rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .slots-grid {
        grid-template-columns: 1fr;
      }

      .booking-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .modal {
        padding: 1.5rem;
        margin: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="client-header">
    <div class="header-left">
      <img src="assets/images/headerlogowarm.png" alt="PictureThisPet Logo" class="logo-small" />
      <h1 class="header-title">Client Portal üêæ</h1>
    </div>
    <div class="header-right">
      <div class="client-welcome" id="clientWelcome">Welcome!</div>
      <a href="/portal" class="logout-btn">Logout</a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="client-main">
    <!-- Welcome & Stats -->
    <div class="client-card">
      <div class="card-header">
        <h2 class="card-title">Your Pet Photography Dashboard üì∏</h2>
        <div class="card-actions">
          <button class="btn btn-secondary btn-small" onclick="refreshData()">üîÑ Refresh</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h4>Total Sessions üìÖ</h4>
          <p id="totalSessions">Loading...</p>
        </div>
        <div class="stat-card">
          <h4>Upcoming Sessions üéâ</h4>
          <p id="upcomingSessions">Loading...</p>
        </div>
        <div class="stat-card">
          <h4>Favorite Pet üêï</h4>
          <p id="favoritePet">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Available Booking Slots -->
    <div class="client-card">
      <div class="card-header">
        <h2 class="card-title">Book a New Session üìÖ</h2>
        <div class="card-actions">
          <button class="btn btn-primary btn-small" onclick="showAllAvailability()">üìã View All Dates</button>
        </div>
      </div>

      <div class="filter-tabs">
        <div class="filter-tab active" onclick="filterSlots('next7days')">Next 7 Days</div>
        <div class="filter-tab" onclick="filterSlots('next30days')">Next 30 Days</div>
        <div class="filter-tab" onclick="filterSlots('all')">All Available</div>
      </div>

      <div class="slots-grid" id="availableSlotsGrid">
        <!-- Available slots will be populated here -->
      </div>
    </div>

    <!-- Your Bookings -->
    <div class="client-card">
      <div class="card-header">
        <h2 class="card-title">Your Bookings üìñ</h2>
        <div class="card-actions">
          <button class="btn btn-secondary btn-small" onclick="filterBookings('all')">All</button>
          <button class="btn btn-secondary btn-small" onclick="filterBookings('upcoming')">Upcoming</button>
          <button class="btn btn-secondary btn-small" onclick="filterBookings('completed')">Completed</button>
        </div>
      </div>

      <div class="bookings-list" id="bookingsList">
        <!-- Bookings will be populated here -->
      </div>
    </div>
  </main>

  <!-- Booking Modal -->
  <div class="modal-overlay" id="bookingModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Book Session üì∏</h3>
        <button class="modal-close" onclick="closeBookingModal()">√ó</button>
      </div>
      
      <form id="bookingForm">
        <div class="form-group">
          <label class="form-label">Selected Date & Time üìÖ</label>
          <input type="text" class="form-input" id="selectedSlotInfo" readonly>
        </div>

        <div class="form-group">
          <label class="form-label">Session Type üì∏</label>
          <select class="form-select" id="sessionType" required>
            <option value="">Choose session type...</option>
            <option value="Mini Session">Mini Session (60 minutes)</option>
            <option value="Full Session">Full Session (90 minutes)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Number of Pets üêæ</label>
          <select class="form-select" id="petCount" onchange="updatePetFields()" required>
            <option value="1">1 Pet</option>
            <option value="2">2 Pets</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Number of People üë•</label>
          <select class="form-select" id="peopleCount" onchange="updatePeopleFields()" required>
            <option value="1">1 Person</option>
            <option value="2">2 People</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Additional Pet Name üêï</label>
          <input type="text" class="form-input" id="additionalPetName" placeholder="If bringing a second pet">
        </div>

        <div class="form-group" id="secondPersonFields" style="display: none;">
          <label class="form-label">Second Person Details üë§</label>
          <input type="text" class="form-input" id="secondPersonName" placeholder="Second person's name">
        </div>

        <div class="form-group">
          <label class="form-label">Special Requests üìù</label>
          <textarea class="form-input" id="specialRequests" rows="3" placeholder="Any special requests or notes for your session..."></textarea>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeBookingModal()">Cancel üö´</button>
          <button type="submit" class="btn btn-primary">Book Session üéâ</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Global variables
    let clientData = null;
    let availableSlots = [];
    let clientBookings = [];
    let sessionTypes = [];
    let selectedSlot = null;
    let currentFilter = 'next7days';

    // Authentication and initialization
    function checkClientAuthentication() {
      const username = localStorage.getItem('clientUsername');
      const password = localStorage.getItem('clientPassword');
      
      if (!username || !password || !password.includes('bark')) {
        console.log('Not authenticated as client, redirecting...');
        window.location.href = '/portal';
        return;
      }
      
      console.log('Authenticated as client:', username);
      loadClientData(username);
    }

    // Load client data from Airtable
    async function loadClientData(username) {
      try {
        console.log('Loading client data for username:', username);
        
        // Fetch client record
        const clientResponse = await fetch(`https://api.airtable.com/v0/applU3NCdDveC4G8a/Clients?filterByFormula={username}='${username}'`, {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });

        if (!clientResponse.ok) {
          throw new Error(`Client fetch error: ${clientResponse.status}`);
        }

        const clientData = await clientResponse.json();
        
        if (clientData.records.length === 0) {
          console.error('No client found with username:', username);
          alert('Client record not found. Please contact support.');
          window.location.href = '/portal';
          return;
        }

        clientData = clientData.records[0];
        
        // Update welcome message
        const clientEmail = clientData.fields.clientEmail || 'Valued Client';
        document.getElementById('clientWelcome').textContent = `Welcome, ${clientEmail}! üëã`;
        
        // Load all related data
        await Promise.all([
          loadClientBookings(),
          loadAvailableSlots(),
          loadSessionTypes()
        ]);
        
        updateDashboardStats();
        displayAvailableSlots();
        displayClientBookings();
        
      } catch (error) {
        console.error('Error loading client data:', error);
        await logErrorToAirtable('client-portal-home.html', error);
        alert('Error loading your data. Please try refreshing the page.');
      }
    }

    // Load client bookings
    async function loadClientBookings() {
      try {
        if (!clientData) return;
        
        const response = await fetch(`https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings?filterByFormula={clientRecord}='${clientData.id}'`, {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });

        if (!response.ok) {
          throw new Error(`Bookings fetch error: ${response.status}`);
        }

        const data = await response.json();
        clientBookings = data.records.map(record => ({
          id: record.id,
          bookingId: record.fields.bookingId,
          sessionDate: record.fields.sessionDate,
          sessionType: record.fields.sessionType || 'Session',
          petCount: record.fields.petCount || 1,
          peopleCount: record.fields.peopleCount || 1,
          client1FirstPetName: record.fields.client1FirstPetName,
          client2FirstPetName: record.fields.client2FirstPetName,
          calendarSlot: record.fields.calendarSlot ? record.fields.calendarSlot[0] : null,
          specialRequests: record.fields.specialRequests || ''
        }));

        console.log('Client bookings loaded:', clientBookings);
        
      } catch (error) {
        console.error('Error loading client bookings:', error);
        await logErrorToAirtable('client-portal-home.html', error);
      }
    }

    // Load available slots
    async function loadAvailableSlots() {
      try {
        const response = await fetch("https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar?filterByFormula=AND({status}='available',{isBlocked}=0,{createdByAdmin}=1)", {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });

        if (!response.ok) {
          throw new Error(`Calendar fetch error: ${response.status}`);
        }

        const data = await response.json();
        availableSlots = data.records.map(record => ({
          id: record.id,
          date: record.fields.date,
          time: record.fields.time,
          location: record.fields.Location || 'TBD',
          sessionType: record.fields.sessionType || 'Open Availability',
          bufferTime: record.fields.bufferTime || 60,
          availabilityWindow: record.fields.availabilityWindow || ''
        })).filter(slot => {
          // Only show future slots
          const slotDate = new Date(slot.date + 'T' + slot.time);
          return slotDate > new Date();
        }).sort((a, b) => {
          const dateA = new Date(a.date + 'T' + a.time);
          const dateB = new Date(b.date + 'T' + b.time);
          return dateA - dateB;
        });

        console.log('Available slots loaded:', availableSlots);
        
      } catch (error) {
        console.error('Error loading available slots:', error);
        await logErrorToAirtable('client-portal-home.html', error);
      }
    }

    // Load session types
    async function loadSessionTypes() {
      try {
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/SessionTypes', {
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3'
          }
        });

        if (!response.ok) {
          throw new Error(`SessionTypes fetch error: ${response.status}`);
        }

        const data = await response.json();
        sessionTypes = data.records.map(record => ({
          id: record.id,
          typeName: record.fields.typeName,
          duration: record.fields.duration,
          price: record.fields.price || 0
        }));

        console.log('Session types loaded:', sessionTypes);
        
      } catch (error) {
        console.error('Error loading session types:', error);
        await logErrorToAirtable('client-portal-home.html', error);
      }
    }

    // Update dashboard stats
    function updateDashboardStats() {
      const totalSessions = clientBookings.length;
      const upcomingSessions = clientBookings.filter(booking => {
        const sessionDate = new Date(booking.sessionDate);
        return sessionDate > new Date();
      }).length;
      
      const allPetNames = [];
      clientBookings.forEach(booking => {
        if (booking.client1FirstPetName) allPetNames.push(booking.client1FirstPetName);
        if (booking.client2FirstPetName) allPetNames.push(booking.client2FirstPetName);
      });
      
      const favoritePet = allPetNames.length > 0 ? allPetNames[0] : 'None yet';
      
      document.getElementById('totalSessions').textContent = totalSessions;
      document.getElementById('upcomingSessions').textContent = upcomingSessions;
      document.getElementById('favoritePet').textContent = favoritePet;
    }

    // Display available slots
    function displayAvailableSlots() {
      const slotsGrid = document.getElementById('availableSlotsGrid');
      slotsGrid.innerHTML = '';

      let filteredSlots = [...availableSlots];
      const today = new Date();

      // Apply filter
      switch(currentFilter) {
        case 'next7days':
          const next7Days = new Date(today);
          next7Days.setDate(today.getDate() + 7);
          filteredSlots = filteredSlots.filter(slot => {
            const slotDate = new Date(slot.date);
            return slotDate <= next7Days;
          });
          break;
        case 'next30days':
          const next30Days = new Date(today);
          next30Days.setDate(today.getDate() + 30);
          filteredSlots = filteredSlots.filter(slot => {
            const slotDate = new Date(slot.date);
            return slotDate <= next30Days;
          });
          break;
        // 'all' shows all slots (already filtered for future dates)
      }

      if (filteredSlots.length === 0) {
        slotsGrid.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: rgba(255,255,255,0.7);">
            <h3>No available slots found üìÖ</h3>
            <p>Check back later or contact us directly to schedule a session!</p>
          </div>
        `;
        return;
      }

      filteredSlots.forEach(slot => {
        const slotDate = new Date(slot.date);
        const formattedDate = slotDate.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        const formattedTime = formatTime(slot.time);

        const slotCard = document.createElement('div');
        slotCard.className = 'slot-card available';
        slotCard.onclick = () => openBookingModal(slot);
        
        slotCard.innerHTML = `
          <div class="slot-date">${formattedDate}</div>
          <div class="slot-time">‚è∞ ${formattedTime}</div>
          <div class="slot-location">üìç ${slot.location}</div>
          <div class="slot-status available">Available to Book</div>
        `;
        
        slotsGrid.appendChild(slotCard);
      });
    }

    // Display client bookings
    function displayClientBookings() {
      const bookingsList = document.getElementById('bookingsList');
      bookingsList.innerHTML = '';

      if (clientBookings.length === 0) {
        bookingsList.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.7);">
            <h3>No bookings yet üìÖ</h3>
            <p>Book your first pet photography session above!</p>
          </div>
        `;
        return;
      }

      // Sort bookings by date (newest first)
      const sortedBookings = [...clientBookings].sort((a, b) => {
        return new Date(b.sessionDate) - new Date(a.sessionDate);
      });

      sortedBookings.forEach(booking => {
        const sessionDate = new Date(booking.sessionDate);
        const isUpcoming = sessionDate > new Date();
        
        const formattedDate = sessionDate.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        const formattedTime = sessionDate.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });

        const petNames = [booking.client1FirstPetName, booking.client2FirstPetName]
          .filter(name => name)
          .join(', ');

        const bookingItem = document.createElement('div');
        bookingItem.className = 'booking-item';
        
        const statusClass = isUpcoming ? 'upcoming' : 'completed';
        const statusText = isUpcoming ? 'Upcoming' : 'Completed';
        
        bookingItem.innerHTML = `
          <div class="booking-info">
            <div class="booking-date">${formattedDate} at ${formattedTime}</div>
            <div class="booking-details">
              ${booking.sessionType} ‚Ä¢ ${booking.petCount} pet(s), ${booking.peopleCount} person(s)
              ${petNames ? ` ‚Ä¢ ${petNames}` : ''}
            </div>
          </div>
          <div class="booking-status ${statusClass}">${statusText}</div>
        `;
        
        bookingsList.appendChild(bookingItem);
      });
    }

    // Filter functions
    function filterSlots(filter) {
      currentFilter = filter;
      
      // Update active tab
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      displayAvailableSlots();
    }

    function filterBookings(filter) {
      // This could be enhanced to actually filter bookings
      console.log('Filtering bookings by:', filter);
    }

    // Booking modal functions
    function openBookingModal(slot) {
      selectedSlot = slot;
      
      const slotDate = new Date(slot.date);
      const formattedDate = slotDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      const formattedTime = formatTime(slot.time);
      
      document.getElementById('selectedSlotInfo').value = `${formattedDate} at ${formattedTime} - ${slot.location}`;
      document.getElementById('bookingModal').style.display = 'flex';
    }

    function closeBookingModal() {
      document.getElementById('bookingModal').style.display = 'none';
      document.getElementById('bookingForm').reset();
      selectedSlot = null;
    }

    function updatePetFields() {
      const petCount = document.getElementById('petCount').value;
      const additionalPetField = document.getElementById('additionalPetName');
      
      if (petCount === '2') {
        additionalPetField.required = true;
        additionalPetField.parentElement.style.display = 'block';
      } else {
        additionalPetField.required = false;
        additionalPetField.parentElement.style.display = 'none';
      }
    }

    function updatePeopleFields() {
      const peopleCount = document.getElementById('peopleCount').value;
      const secondPersonFields = document.getElementById('secondPersonFields');
      
      secondPersonFields.style.display = peopleCount === '2' ? 'block' : 'none';
    }

    // Book session
    document.getElementById('bookingForm').onsubmit = async function(e) {
      e.preventDefault();
      
      if (!selectedSlot || !clientData) {
        alert('Missing booking information. Please try again.');
        return;
      }
      
      const sessionType = document.getElementById('sessionType').value;
      const petCount = parseInt(document.getElementById('petCount').value);
      const peopleCount = parseInt(document.getElementById('peopleCount').value);
      const additionalPetName = document.getElementById('additionalPetName').value;
      const secondPersonName = document.getElementById('secondPersonName').value;
      const specialRequests = document.getElementById('specialRequests').value;
      
      try {
        // Create new booking ID
        const bookingId = `SESS_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        // Create booking record
        const bookingData = {
          fields: {
            bookingId: bookingId,
            client1Name: clientData.fields.clientEmail, // Using email as client name for now
            client1Email: clientData.fields.clientEmail,
            client1Phone: clientData.fields.username.slice(-5), // Extract from username
            client1FirstPetName: clientData.fields.password.replace('bark', ''), // Extract pet name from password
            client2FirstPetName: additionalPetName || null,
            petCount: petCount,
            peopleCount: peopleCount,
            sessionDate: `${selectedSlot.date}T${selectedSlot.time}:00`,
            sessionType: sessionType,
            specialRequests: specialRequests,
            marketingConsent: true,
            clientRecord: [clientData.id]
          }
        };
        
        // Create booking
        const bookingResponse = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Bookings', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bookingData)
        });
        
        if (!bookingResponse.ok) {
          throw new Error(`Booking creation error: ${bookingResponse.status}`);
        }
        
        const bookingResult = await bookingResponse.json();
        
        // Update calendar slot to booked
        const calendarUpdateData = {
          fields: {
            status: 'booked',
            bookingId: bookingId,
            sessionType: sessionType
          }
        };
        
        const calendarResponse = await fetch(`https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar/${selectedSlot.id}`, {
          method: 'PATCH',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(calendarUpdateData)
        });
        
        if (!calendarResponse.ok) {
          throw new Error(`Calendar update error: ${calendarResponse.status}`);
        }
        
        // Create buffer time blocks if needed
        if (selectedSlot.bufferTime > 0) {
          await createBufferBlocks(selectedSlot, sessionType, bookingId);
        }
        
        console.log('‚úÖ Session booked successfully');
        alert(`üéâ Session booked successfully!\n\nBooking ID: ${bookingId}\nDate: ${selectedSlot.date} at ${selectedSlot.time}\nSession Type: ${sessionType}\n\nYou'll receive a confirmation email soon!`);
        
        closeBookingModal();
        await refreshData();
        
      } catch (error) {
        console.error('Error booking session:', error);
        await logErrorToAirtable('client-portal-home.html', error);
        alert('‚ùå Error booking session. Please try again or contact support.');
      }
    };

    // Create buffer time blocks
    async function createBufferBlocks(slot, sessionType, bookingId) {
      try {
        // Get session duration
        const sessionTypeData = sessionTypes.find(st => st.typeName === sessionType);
        const sessionDuration = sessionTypeData ? sessionTypeData.duration : 60;
        
        // Calculate buffer start time
        const sessionStart = new Date(`${slot.date}T${slot.time}:00`);
        const bufferStart = new Date(sessionStart);
        bufferStart.setMinutes(bufferStart.getMinutes() + sessionDuration);
        
        const bufferEnd = new Date(bufferStart);
        bufferEnd.setMinutes(bufferEnd.getMinutes() + slot.bufferTime);
        
        const bufferData = {
          fields: {
            SlotType: 'Buffer',
            Location: 'Buffer Time',
            date: slot.date,
            time: bufferStart.toTimeString().slice(0, 5),
            endTime: bufferEnd.toTimeString().slice(0, 5),
            status: 'blocked',
            sessionType: 'Buffer Time',
            isBlocked: true,
            bufferFor: sessionType,
            relatedBooking: bookingId
          }
        };
        
        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Calendar', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bufferData)
        });
        
        if (response.ok) {
          console.log(`‚úÖ Created ${slot.bufferTime} min buffer after ${sessionType}`);
        }
        
      } catch (error) {
        console.error('Error creating buffer blocks:', error);
        // Don't throw - buffer creation failing shouldn't break the booking
      }
    }

    // Utility functions
    function formatTime(timeString) {
      const [hours, minutes] = timeString.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;
      return `${displayHour}:${minutes} ${ampm}`;
    }

    async function refreshData() {
      console.log('Refreshing all data...');
      await Promise.all([
        loadClientBookings(),
        loadAvailableSlots()
      ]);
      
      updateDashboardStats();
      displayAvailableSlots();
      displayClientBookings();
    }

    function showAllAvailability() {
      filterSlots('all');
    }

    // Error logging
    async function logErrorToAirtable(page, error, data = {}) {
      try {
        const errorId = `ERR_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const errorRecord = {
          fields: {
            errorId: errorId,
            timestamp: new Date().toISOString(),
            page: page,
            errorMessage: error.message || String(error),
            errorStack: error.stack || 'No stack trace available',
            userAgent: navigator.userAgent,
            sessionData: JSON.stringify(data)
          }
        };

        const response = await fetch('https://api.airtable.com/v0/applU3NCdDveC4G8a/Errors', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer patRiY2oii5YaxnGT.d79f2cadf0e49d677735ac56b003897974055bb6736efb893d3dce98d93a97b3',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(errorRecord)
        });

        if (response.ok) {
          console.log('‚úÖ Error logged to Airtable:', errorRecord);
        }
      } catch (innerError) {
        console.warn('‚ö†Ô∏è Failed to log error to Airtable:', innerError);
      }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Client portal loaded...');
      checkClientAuthentication();
    });
  </script>
</body>
</html>
